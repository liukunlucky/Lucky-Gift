import router from '@ohos.router';
import { Achievement, UserAchievementProgress, AchievementMilestone, UserAchievementDetail } from '../model/NewDataModels';
import { AchievementDAO } from '../dao/AchievementDAO';
import { NewDatabaseManager } from '../database/NewDatabaseManager';

@Entry
@Component
struct AchievementPage {
  @State userAchievements: UserAchievementDetail[] = [];
  @State milestones: AchievementMilestone[] = [];
  @State isLoading: boolean = true;

  private dbManager = new NewDatabaseManager();
  private achievementDAO: AchievementDAO | null = null;
  private userId: string = 'default_user'; // é»˜è®¤ç”¨æˆ·IDï¼Œå®é™…åº”ç”¨ä¸­åº”ä»ç”¨æˆ·ç³»ç»Ÿè·å–

  aboutToAppear() {
    this.initDatabase();
  }

  private async initDatabase() {
    try {
      if (!this.dbManager.isInitialized()) {
        await this.dbManager.initDatabase(getContext(this));
      }
      const rdbStore = this.dbManager.getRdbStore();
      if (rdbStore) {
        this.achievementDAO = new AchievementDAO(this.userId, this.dbManager);
        await this.achievementDAO.initDatabase(getContext(this));
        await this.loadUserAchievements();
      }
    } catch (error) {
      console.error('åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  private async loadUserAchievements() {
    if (!this.achievementDAO) {
      console.error('AchievementDAOæœªåˆå§‹åŒ–');
      return;
    }

    try {
      console.info('å¼€å§‹åŠ è½½ç”¨æˆ·æˆå°±æ•°æ®...');
      this.userAchievements = await this.achievementDAO.getUserAchievementDetails(this.userId);
      console.info(`æˆåŠŸåŠ è½½${this.userAchievements.length}ä¸ªæˆå°±æ•°æ®`);
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æˆå°±æ•°æ®å¤±è´¥:', error);
      // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿè¦ç¡®ä¿æ˜¾ç¤ºç©ºçš„æˆå°±åˆ—è¡¨è€Œä¸æ˜¯é”™è¯¯çŠ¶æ€
      this.userAchievements = [];
    }
  }

  private async getAchievementMilestones(achievementId: string): Promise<AchievementMilestone[]> {
    if (!this.achievementDAO) return [];
    return await this.achievementDAO.getAchievementMilestones(achievementId);
  }

  // ç§»é™¤tabè¿‡æ»¤æ–¹æ³•ï¼Œç›´æ¥è¿”å›æ‰€æœ‰æˆå°±

  private formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
  }

  private onBack() {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildNavigationBar()

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        this.buildLoadingState()
      } else {
        // æˆå°±åˆ—è¡¨
        this.buildAchievementGrid()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  buildNavigationBar() {
    Row() {
      Button() {
        Image($r('app.media.icon_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        this.onBack();
      })

      Text('æˆå°±ç³»ç»Ÿ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
      Row()
        .width(40)
        .height(40)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .border({ width: { bottom: 0.5 }, color: '#E5E5E5' })
  }

  @Builder
  buildLoadingState() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#007AFF')

      Text('åŠ è½½ä¸­...')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ top: 12 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // ç§»é™¤tabç›¸å…³çš„Builderæ–¹æ³•

  @Builder
  buildAchievementGrid() {
    Grid() {
      ForEach(this.userAchievements, (userAchievement: UserAchievementDetail) => {
        GridItem() {
          this.buildAchievementCard(userAchievement)
        }
      }, (userAchievement: UserAchievementDetail) => userAchievement.template.id || '')
    }
    .columnsTemplate('1fr 1fr') // ä¸€è¡Œæ˜¾ç¤º2ä¸ª
    .rowsGap(12)
    .columnsGap(12)
    .width('100%')
    .layoutWeight(1)
    .padding(16)
  }

  @Builder
  buildEmptyState() {
    Column() {
      Image($r('app.media.ic_achievement_empty'))
        .width(80)
        .height(80)
        .fillColor('#CCCCCC')

      Text('æš‚æ— æˆå°±æ•°æ®')
        .fontSize(16)
        .fontColor('#666666')
        .margin({ top: 16 })

      Text('ç»§ç»­ä½¿ç”¨åº”ç”¨æ¥è§£é”æ›´å¤šæˆå°±å§ï¼')
        .fontSize(14)
        .fontColor('#999999')
        .margin({ top: 8 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildAchievementCard(userAchievement: UserAchievementDetail) {
    Stack() {
      Column({ space: 12 }) {
        // æˆå°±å›¾æ ‡
        Column() {
          Text(userAchievement.template.icon || 'ğŸ†')
            .fontSize(28)
            .opacity(userAchievement.progress.isUnlocked ? 1.0 : 0.6)
        }
        .width(50)
        .height(50)
        .backgroundColor(userAchievement.progress.isUnlocked ? '#E6F3FF' : '#F8F8F8')
        .borderRadius(25)
        .justifyContent(FlexAlign.Center)
        .border({
          width: userAchievement.progress.isUnlocked ? 2 : 1,
          color: userAchievement.progress.isUnlocked ? '#007AFF' : '#E0E0E0'
        })

        // æˆå°±ä¿¡æ¯
        Column({ space: 6 }) {
          Text(userAchievement.template.name)
            .fontSize(14)
            .fontWeight(userAchievement.progress.isUnlocked ? FontWeight.Bold : FontWeight.Medium)
            .fontColor(userAchievement.progress.isUnlocked ? '#333333' : '#888888')
            .textAlign(TextAlign.Center)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // å›ºå®šé«˜åº¦çš„æè¿°æ–‡æœ¬åŒºåŸŸ
          Text(userAchievement.template.description)
            .fontSize(12)
            .fontColor(userAchievement.progress.isUnlocked ? '#666666' : '#999999')
            .textAlign(TextAlign.Center)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .height(32) // å›ºå®šé«˜åº¦ï¼Œç¡®ä¿ä¸¤è¡Œæ–‡æœ¬çš„ç©ºé—´
            .lineHeight(16) // è®¾ç½®è¡Œé«˜

          // è¿›åº¦ä¿¡æ¯
          if (userAchievement.template.targetValue) {
            Text(`${userAchievement.progress.currentProgress}/${userAchievement.template.targetValue}`)
              .fontSize(11)
              .fontColor(userAchievement.progress.isUnlocked ? '#007AFF' : '#BBBBBB')
              .fontWeight(userAchievement.progress.isUnlocked ? FontWeight.Medium : FontWeight.Normal)
              .textAlign(TextAlign.Center)
              .height(16) // å›ºå®šé«˜åº¦
          } else {
            // å ä½ç©ºé—´ï¼Œä¿æŒå¸ƒå±€ä¸€è‡´
            Text('')
              .height(16)
          }
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)

        // è¿›åº¦æ¡åŒºåŸŸ - å›ºå®šé«˜åº¦
        Column() {
          if (userAchievement.template.targetValue) {
            Progress({ value: userAchievement.progressPercentage, total: 100, type: ProgressType.Linear })
              .width('100%')
              .height(3)
              .color(userAchievement.progress.isUnlocked ? '#00C851' : '#007AFF')
              .backgroundColor('#E5E5E5')
          } else {
            // å ä½ç©ºé—´ï¼Œä¿æŒå¸ƒå±€ä¸€è‡´
            Row()
              .width('100%')
              .height(3)
          }
        }
        .width('100%')
        .height(8) // å›ºå®šè¿›åº¦æ¡åŒºåŸŸé«˜åº¦
        .justifyContent(FlexAlign.Center)
      }
      .width('100%')
      .height(180) // è®¾ç½®å›ºå®šå¡ç‰‡é«˜åº¦
      .padding(12)
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.SpaceBetween) // å‡åŒ€åˆ†å¸ƒå†…å®¹

      // å³ä¸Šè§’è§£é”çŠ¶æ€æ ‡è¯†
      Row() {
        Image($r('app.media.icon_complete'))
          .width(39)
          .fillColor(Color.Red)
          .height(39)
          .zIndex(10)
      }
      .width(50)
      .height(50)
      .justifyContent(FlexAlign.Start)
      .alignItems(VerticalAlign.Center)
      .position({ x: '100%', y: 0 })
      .translate({ x: -50, y: 0 })
      .visibility(userAchievement.progress.isUnlocked?Visibility.Visible:Visibility.Hidden)
    }
    .width('100%')
    .height(180) // ç¡®ä¿Stackå®¹å™¨ä¹Ÿæœ‰å›ºå®šé«˜åº¦
    .backgroundColor(userAchievement.progress.isUnlocked ? '#FFFFFF' : '#FAFAFA')
    .borderRadius(12)
    .shadow({
      radius: userAchievement.progress.isUnlocked ? 8 : 4,
      color: userAchievement.progress.isUnlocked ? '#1A000000' : '#0D000000',
      offsetX: 0,
      offsetY: userAchievement.progress.isUnlocked ? 4 : 2
    })
    // æ·»åŠ è¾¹æ¡†å¢å¼ºè§†è§‰æ•ˆæœ
    .border({
      width: userAchievement.progress.isUnlocked ? 2 : 1,
      color: userAchievement.progress.isUnlocked ? '#E6F3FF' : '#F0F0F0'
    })
    .opacity(userAchievement.progress.isUnlocked ? 1.0 : 0.85)
  }
}