import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

interface PersonBudget {
  id: string;
  name: string;
  budget: number;
  allocatedAmount: number;
}

@Entry
@Component
struct BudgetCalculatorPage {
  @State private totalBudget: number = 0;
  @State private peopleCount: number = 1;
  @State private people: PersonBudget[] = [];
  @State private currentPersonName: string = '';
  @State private showEditPersonDialog: boolean = false;
  @State private showAddPersonDialog: boolean = false;
  @State private editingPersonId: string = '';

  
  aboutToAppear() {
    this.initializePeople();
  }
  
  initializePeople() {
    // åˆå§‹åŒ–ä¸€ä¸ªäººçš„é¢„ç®—åˆ†é…
    this.people = [{
      id: '1',
      name: 'æˆå‘˜1',
      budget: 0,
      allocatedAmount: 0
    }];
  }
  

  
  // å¢åŠ äººæ•°
  increasePeopleCount() {
    if (this.peopleCount >= 20) {
      promptAction.showToast({
        message: 'æœ€å¤šæ”¯æŒ20äºº',
        duration: 2000
      });
      return;
    }
    this.peopleCount++;
    this.updatePeopleList();
  }
  
  // å‡å°‘äººæ•°
  decreasePeopleCount() {
    if (this.peopleCount <= 1) {
      promptAction.showToast({
        message: 'è‡³å°‘éœ€è¦1äºº',
        duration: 2000
      });
      return;
    }
    this.peopleCount--;
    this.updatePeopleList();
  }
  
  // æ›´æ–°äººå‘˜åˆ—è¡¨
  private updatePeopleList(): void {
    // è°ƒæ•´äººå‘˜åˆ—è¡¨
    while (this.people.length < this.peopleCount) {
      const newPerson: PersonBudget = {
        id: Date.now().toString() + this.people.length,
        name: `æˆå‘˜${this.people.length + 1}`,
        budget: 0,
        allocatedAmount: 0
      };
      this.people.push(newPerson);
    }
    
    // ç§»é™¤å¤šä½™çš„äººå‘˜
    while (this.people.length > this.peopleCount) {
      this.people.pop();
    }
    
    }
  
  // æ›´æ–°äººå‘˜é¢„ç®—
  updatePersonBudget(personId: string, amount: number) {
    const person = this.people.find(p => p.id === personId);
    if (person) {
      person.budget = amount;
    }
  }
  
  // ä¿å­˜äººå‘˜ä¿¡æ¯
  savePerson() {
    if (this.currentPersonName.trim() === '') {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥æˆå‘˜åç§°',
        duration: 2000
      });
      return;
    }
    
    if (this.editingPersonId) {
      // ç¼–è¾‘ç°æœ‰äººå‘˜ - ä½¿ç”¨å“åº”å¼æ›´æ–°æ–¹æ³•
      const updatedPeople: PersonBudget[] = [];
      for (const person of this.people) {
        if (person.id === this.editingPersonId) {
          const updatedPerson: PersonBudget = {
            id: person.id,
            name: this.currentPersonName,
            budget: person.budget,
            allocatedAmount: person.allocatedAmount
          };
          updatedPeople.push(updatedPerson);
        } else {
          updatedPeople.push(person);
        }
      }
      this.people = updatedPeople;
      this.showEditPersonDialog = false;
    } else {
      // æ·»åŠ æ–°äººå‘˜
      const newPerson: PersonBudget = {
        id: Date.now().toString(),
        name: this.currentPersonName,
        budget: 0,
        allocatedAmount: 0
      };
      this.people.push(newPerson);
      this.peopleCount = this.people.length;
      this.showAddPersonDialog = false;
    }
    
    this.currentPersonName = '';
    this.editingPersonId = '';
  }
  
  // åˆ é™¤äººå‘˜
  deletePerson(personId: string) {
    const index = this.people.findIndex(person => person.id === personId);
    if (index > -1) {
      this.people.splice(index, 1);
      this.peopleCount = this.people.length;
    }
  }
  
  // æ›´æ–°äººå‘˜åˆ†é…é‡‘é¢
  updatePersonAllocation(personId: string, amount: number) {
    const updatedPeople: PersonBudget[] = [];
    for (const person of this.people) {
      if (person.id === personId) {
        const updatedPerson: PersonBudget = {
          id: person.id,
          name: person.name,
          budget: person.budget,
          allocatedAmount: amount
        };
        updatedPeople.push(updatedPerson);
      } else {
        updatedPeople.push(person);
      }
    }
    this.people = updatedPeople;
  }
  


  // æ˜¾ç¤ºç¼–è¾‘äººå‘˜å¯¹è¯æ¡†
  private showEditDialog(person: PersonBudget): void {
    this.currentPersonName = person.name;
    this.editingPersonId = person.id;
    this.showEditPersonDialog = true;
  }
  
  // é‡ç½®é¢„ç®—
  resetBudget() {
    this.totalBudget = 0;
    this.peopleCount = 1;
    this.people = [];
    this.initializePeople();
  }

  // è·å–æ€»åˆ†é…é‡‘é¢
  getTotalAllocated(): number {
    return this.people.reduce((total, person) => total + person.allocatedAmount, 0);
  }

  // è·å–å‰©ä½™é¢„ç®—
  getRemainingBudget(): number {
    return this.totalBudget - this.getTotalAllocated();
  }

  // è·å–åˆ†é…è¿›åº¦
  getAllocationProgress(): number {
    if (this.totalBudget === 0) return 0;
    return (this.getTotalAllocated() / this.totalBudget) * 100;
  }
  
  goBack() {
    router.back();
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Image($r('app.media.icon_back'))
            .width(24)
            .height(24)
            .fillColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.goBack()
        })
        
        Text('é¢„ç®—è®¡ç®—å™¨')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Button() {
          Text('é‡ç½®')
            .fontSize(14)
            .fontColor('#FF4444')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.resetBudget();
        })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      
      Scroll() {
        Column() {
          // æ€»é¢„ç®—è®¾ç½®
          Column() {
            Text('æ€»é¢„ç®—è®¾ç½®')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })
            
            Row() {
              Text('Â¥')
                .fontSize(24)
                .fontColor('#FF6B35')
                .fontWeight(FontWeight.Bold)
              
              TextInput({ placeholder: 'ç‚¹å‡»è¾“å…¥æ€»é¢„ç®—é‡‘é¢' })
                .type(InputType.Number)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF6B35')
                .backgroundColor(Color.Transparent)
                .border({ width: 0 })
                .layoutWeight(1)
                .placeholderColor('#FFB399')
                .placeholderFont({ size: 20 })
                .onChange((value: string) => {
              this.totalBudget = parseFloat(value) || 0;
            })
            }
            .width('100%')
            .height(60)
            .backgroundColor('#FFF5F0')
            .borderRadius(12)
            .padding({ left: 20, right: 20 })
            .alignItems(VerticalAlign.Center)
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .padding(16)
          .margin({ bottom: 16 })
          
          // äººæ•°è®¾ç½®
          Column() {
            Text('å‚ä¸äººæ•°')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })
            
            Row() {
              Button() {
                Text('-')
                  .fontSize(20)
                  .fontColor('#FF6B35')
                  .fontWeight(FontWeight.Bold)
              }
              .width(40)
              .height(40)
              .backgroundColor('#FFF5F0')
              .borderRadius(8)
              .onClick(() => {
                if (this.peopleCount > 1) {
                  this.peopleCount--;
                  this.updatePeopleList();
                } else {
                  promptAction.showToast({
                    message: 'è‡³å°‘éœ€è¦1ä¸ªäººå‚ä¸é¢„ç®—åˆ†é…',
                    duration: 2000
                  });
                }
              })
              
              Text(this.peopleCount.toString())
                .fontSize(20)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .layoutWeight(1)
                .textAlign(TextAlign.Center)
              
              Button() {
                Text('+')
                  .fontSize(20)
                  .fontColor('#FF6B35')
                  .fontWeight(FontWeight.Bold)
              }
              .width(40)
              .height(40)
              .backgroundColor('#FFF5F0')
              .borderRadius(8)
              .onClick(() => {
                if (this.peopleCount < 10) {
                  this.peopleCount++;
                  this.updatePeopleList();
                }
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .alignItems(VerticalAlign.Center)
            
            // é¢„ç®—æ¦‚è§ˆ
            Row() {
              Column() {
                Text('æ€»é¢„ç®—')
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ bottom: 4 })
                
                Text(`Â¥${this.totalBudget.toFixed(2)}`)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              

            }
            .width('100%')
            .padding(10)
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .padding(16)
          .margin({ bottom: 16 })
          
          // é¢„ç®—æ¦‚è§ˆ
          Column() {
            Text('é¢„ç®—æ¦‚è§ˆ')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })
            
            // æ€»ä½“ç»Ÿè®¡
            Row() {
              Column() {
                Text('æ€»é¢„ç®—')
                  .fontSize(12)
                  .fontColor('#999999')
                  .margin({ bottom: 4 })
                
                Text(`Â¥${this.totalBudget}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333333')
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)
              
              Column() {
                Text('å·²åˆ†é…')
                  .fontSize(12)
                  .fontColor('#999999')
                  .margin({ bottom: 4 })
                
                Text(`Â¥${this.getTotalAllocated()}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#2196F3')
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)
              
              Column() {
                Text('å‰©ä½™')
                  .fontSize(12)
                  .fontColor('#999999')
                  .margin({ bottom: 4 })
                
                Text(`Â¥${this.getRemainingBudget()}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.getRemainingBudget() >= 0 ? '#4CAF50' : '#F44336')
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            // åˆ†é…è¿›åº¦æ¡
            Column() {
              Row() {
                Text('åˆ†é…è¿›åº¦')
                  .fontSize(14)
                  .fontColor('#666666')
                
                Blank()
                
                Text(`${this.getAllocationProgress().toFixed(1)}%`)
                  .fontSize(14)
                  .fontColor('#666666')
              }
              .width('100%')
              .margin({ bottom: 8 })
              
              if (this.getTotalAllocated() > this.totalBudget) {
                Row() {
                  Image($r('app.media.ic_warning'))
                    .width(14)
                    .height(14)
                    .fillColor('#F44336')
                    .margin({ right: 4 })
                  
                  Text('åˆ†é…é‡‘é¢è¶…å‡ºé¢„ç®—')
                    .fontSize(12)
                    .fontColor('#F44336')
                }
                .alignItems(VerticalAlign.Center)
                .margin({ top: 4 })
              }
              
              Progress({
                value: this.getTotalAllocated(),
                total: this.totalBudget || 1,
                type: ProgressType.Linear
              })
                .width('100%')
                .height(8)
                .color(this.getTotalAllocated() > this.totalBudget ? '#F44336' : '#2196F3')
                .backgroundColor('#F0F0F0')
                .borderRadius(4)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#F8F9FA')
            .borderRadius(8)
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .padding(16)
          .margin({ bottom: 16 })
          
          // äººå‘˜åˆ†é…
          Column() {
            Row() {
              Text('äººå‘˜åˆ†é…')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            if (this.people.length === 0) {
              Column() {
                Text('ğŸ‘¥')
                  .fontSize(60)
                  .fontColor('#CCCCCC')
                
                Text('è¿˜æ²¡æœ‰å‚ä¸äººå‘˜')
                  .fontSize(16)
                  .fontColor('#999999')
                  .margin({ top: 16 })
                
                Text('è®¾ç½®äººæ•°æˆ–æ·»åŠ äººå‘˜å¼€å§‹åˆ†é…é¢„ç®—')
                  .fontSize(14)
                  .fontColor('#CCCCCC')
                  .margin({ top: 8 })
              }
              .width('100%')
              .height(120)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            } else {
              // äººå‘˜åˆ—è¡¨
              Column() {
                ForEach(this.people, (person: PersonBudget, index: number) => {
                  Column() {
                    Row() {
                      Text('ğŸ‘¤')
                        .fontSize(20)
                        .margin({ right: 12 })
                      
                      Column() {
                        Text(person.name)
                          .fontSize(16)
                          .fontWeight(FontWeight.Medium)
                          .fontColor('#333333')
                          .alignSelf(ItemAlign.Start)
                      }
                      .layoutWeight(1)
                      .alignItems(HorizontalAlign.Start)

                      Image($r('app.media.icon_edit'))
                        .width(18)
                        .height(18)
                        .fillColor('#333333')
                        .visibility(Visibility.None)
                        .onClick(() => this.showEditDialog(person))
                        .margin({ right: 4 })
                      
                      if (this.people.length > 1) {
                        Image($r('app.media.icon_delete'))
                          .width(22)
                          .height(22)
                          .fillColor(Color.Red)
                          .margin({ left: 4 })
                          .onClick(() => this.deletePerson(person.id))
                       }
                    }
                    .width('100%')
                    .alignItems(VerticalAlign.Center)
                    .margin({ bottom: 12 })

                    // åˆ†é…é‡‘é¢æ»‘åŠ¨æ¡
                    Column() {
                      TextInput({
                        text: person.allocatedAmount.toString(),
                        placeholder: 'Â¥ è¯·è¾“å…¥åˆ†é…é‡‘é¢'
                      })
                        .width('100%')
                        .height(48)
                        .type(InputType.Number)
                        .fontSize(18)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#FF6B35')
                        .backgroundColor('#FFF5F0')
                        .borderRadius(10)
                        .padding({ left: 16, right: 16 })
                        .placeholderColor('#FFB399')
                        .placeholderFont({ size: 16 })
                        .border({ width: 0 })
                        .onChange((value: string) => {
                          const amount = parseFloat(value) || 0;
                          this.updatePersonAllocation(person.id, amount);
                        })
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Start)
                  }
                  .width('100%')
                  .padding(16)
                  .backgroundColor('#F8F9FA')
                  .borderRadius(8)
                  .margin({ bottom: 12 })
                }, (person: PersonBudget) => person.id)
              }
            }
          }
          .width('100%')
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .padding(16)
        }
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      
      // æ·»åŠ /ç¼–è¾‘äººå‘˜å¯¹è¯æ¡†
      if (this.showEditPersonDialog) {
        Stack() {
          // èƒŒæ™¯é®ç½©
          Rect()
            .width('100%')
            .height('100%')
            .fill('#80000000')
            .onClick(() => {
              this.showEditPersonDialog = false;
            })
          
          // å¯¹è¯æ¡†å†…å®¹
          Column() {
            Text(this.editingPersonId ? 'ç¼–è¾‘äººå‘˜' : 'æ·»åŠ äººå‘˜')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .margin({ bottom: 20 })
            
            // äººå‘˜å§“å
            Column() {
              Text('å§“å')
                .fontSize(14)
                .fontColor('#666666')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })
              
              TextInput({ placeholder: 'ç‚¹å‡»è¾“å…¥å§“å', text: this.currentPersonName })
                .fontSize(16)
                .backgroundColor('#FFFFFF')
                .borderRadius(8)
                .borderWidth(2)
                .borderColor('#FF6B35')
                .padding({ left: 16, right: 16, top: 12, bottom: 12 })
                .placeholderColor('#CCCCCC')
                .placeholderFont({ size: 14 })
                .onChange((value: string) => {
                  this.currentPersonName = value;
                })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 24 })
            
            // æŒ‰é’®
            Row() {
              Button('å–æ¶ˆ')
                .fontSize(16)
                .fontColor('#666666')
                .backgroundColor('#F5F5F5')
                .borderRadius(8)
                .layoutWeight(1)
                .margin({ right: 8 })
                .onClick(() => {
                  this.showEditPersonDialog = false;
                })
              
              Button('ä¿å­˜')
                .fontSize(16)
                .fontColor('#FFFFFF')
                .backgroundColor('#FF6B35')
                .borderRadius(8)
                .layoutWeight(1)
                .margin({ left: 8 })
                .onClick(() => this.savePerson())
            }
            .width('100%')
          }
          .width('90%')
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .padding(24)
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }
}