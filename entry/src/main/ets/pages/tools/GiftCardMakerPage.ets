import router from '@ohos.router';
import { BusinessError } from '@ohos.base';
import image from '@ohos.multimedia.image';
import componentSnapshot from '@ohos.arkui.componentSnapshot';
import promptAction from '@ohos.promptAction';
import photoAccessHelper from '@ohos.file.photoAccessHelper';
import { Context } from '@ohos.abilityAccessCtrl';
import common from '@ohos.app.ability.common';
import fs from '@ohos.file.fs';

interface CardTemplate {
  id: string;
  name: string;
  preview: string;
  backgroundColor: string;
  textColor: string;
  accentColor: string;
  style: 'classic' | 'modern' | 'cute' | 'elegant';
}

interface CardData {
  template: CardTemplate;
  customMessage: string;
  senderName: string;
  receiverName: string;
}

@Entry
@Component
struct GiftCardMakerPage {
  @State selectedTemplate: CardTemplate | null = null;
  @State customMessage: string = '';
  @State senderName: string = '';
  @State receiverName: string = '';
  @State isSaving: boolean = false;
  
  // é¢„ç½®æ¨¡æ¿
  private templates: CardTemplate[] = [
    {
      id: 'classic_1',
      name: 'ç»å…¸ç¥ç¦',
      preview: '/common/images/card_classic_1.png',
      backgroundColor: '#FFFFFF',
      textColor: '#333333',
      accentColor: '#FF6B35',
      style: 'classic'
    },
    {
      id: 'modern_1',
      name: 'ç°ä»£ç®€çº¦',
      preview: '/common/images/card_modern_1.png',
      backgroundColor: '#F8F9FA',
      textColor: '#2C3E50',
      accentColor: '#3498DB',
      style: 'modern'
    },
    {
      id: 'cute_1',
      name: 'å¯çˆ±é£æ ¼',
      preview: '/common/images/card_cute_1.png',
      backgroundColor: '#FFE5E5',
      textColor: '#E91E63',
      accentColor: '#FF69B4',
      style: 'cute'
    },
    {
      id: 'elegant_1',
      name: 'ä¼˜é›…é‡‘è‰²',
      preview: '/common/images/card_elegant_1.png',
      backgroundColor: '#1A1A1A',
      textColor: '#FFFFFF',
      accentColor: '#FFD700',
      style: 'elegant'
    },
    {
      id: 'classic_2',
      name: 'æ¸©é¦¨ç²‰è‰²',
      preview: '/common/images/card_classic_2.png',
      backgroundColor: '#FFF0F5',
      textColor: '#8B4B8B',
      accentColor: '#DDA0DD',
      style: 'classic'
    },
    {
      id: 'modern_2',
      name: 'æ¸…æ–°ç»¿è‰²',
      preview: '/common/images/card_modern_2.png',
      backgroundColor: '#F0FFF0',
      textColor: '#2E8B57',
      accentColor: '#32CD32',
      style: 'modern'
    },
    {
      id: 'cute_2',
      name: 'æ¢¦å¹»ç´«è‰²',
      preview: '/common/images/card_cute_2.png',
      backgroundColor: '#F5F0FF',
      textColor: '#6A5ACD',
      accentColor: '#9370DB',
      style: 'cute'
    },
    {
      id: 'elegant_2',
      name: 'æ·±è“å•†åŠ¡',
      preview: '/common/images/card_elegant_2.png',
      backgroundColor: '#191970',
      textColor: '#FFFFFF',
      accentColor: '#87CEEB',
      style: 'elegant'
    }
  ];
  
  aboutToAppear() {
    // è®¾ç½®é»˜è®¤æ¨¡æ¿
    this.selectedTemplate = this.templates[0];
  }
  
  selectTemplate(template: CardTemplate) {
    this.selectedTemplate = template;
  }
  
  // éªŒè¯è¡¨å•æ˜¯å¦å®Œæ•´
  private isFormValid(): boolean {
    return this.selectedTemplate !== null && 
           this.receiverName.trim().length > 0 && 
           this.customMessage.trim().length > 0;
  }
  
  // è·å–ç¼ºå¤±çš„å­—æ®µä¿¡æ¯
  private getMissingFields(): string[] {
    const missing: string[] = [];
    if (!this.selectedTemplate) {
      missing.push('æ¨¡æ¿');
    }
    if (!this.receiverName.trim()) {
      missing.push('æ”¶ä»¶äºº');
    }
    if (!this.customMessage.trim()) {
      missing.push('ç¥ç¦è¯­');
    }
    return missing;
  }
  
  // æ˜¾ç¤ºç¼ºå¤±å­—æ®µçš„æç¤º
  private showMissingFieldsToast() {
    const missingFields = this.getMissingFields();
    if (missingFields.length > 0) {
      const message = `è¯·å¡«å†™ï¼š${missingFields.join('ã€')}`;
      promptAction.showToast({
        message: message,
        duration: 2000
      });
    }
  }
  
  togglePreview() {
    if (!this.isFormValid()) {
      this.showMissingFieldsToast();
      return;
    }
    
    // è·³è½¬åˆ°é¢„è§ˆé¡µé¢
    const cardData: CardData = {
      template: this.selectedTemplate!,
      customMessage: this.customMessage,
      senderName: this.senderName,
      receiverName: this.receiverName
    };
    
    router.pushUrl({
      url: 'pages/tools/GiftCardPreviewPage',
      params: {
        cardData: cardData
      }
    }).catch((error: Error) => {
      console.error('è·³è½¬é¢„è§ˆé¡µé¢å¤±è´¥:', error);
      promptAction.showToast({
        message: 'è·³è½¬å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    });
  }
  
  async saveCard() {
    if (!this.selectedTemplate || !this.customMessage.trim()) {
      return;
    }
    
    try {
      this.isSaving = true;
      
      await this.generateAndSaveCard();
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      this.showSuccessMessage();
      
    } catch (error) {
      console.error('ä¿å­˜å¡ç‰‡å¤±è´¥:', error);
      this.showErrorMessage(error as Error);
    } finally {
      this.isSaving = false;
    }
  }
  
  async generateAndSaveCard() {
    try {
      // 1. ä½¿ç”¨componentSnapshotæˆªå–å¡ç‰‡é¢„è§ˆ
      const pixelMap = await componentSnapshot.get('giftCardPreview');
      
      if (!pixelMap) {
        throw new Error('æˆªå›¾å¤±è´¥');
      }
      
      // 2. è·å–åº”ç”¨ä¸Šä¸‹æ–‡
      const context = getContext(this) as common.UIAbilityContext;
      
      // 3. åˆ›å»ºPhotoAccessHelperå®ä¾‹
      const phAccessHelper = photoAccessHelper.getPhotoAccessHelper(context);
      
      // 4. å°†PixelMapè½¬æ¢ä¸ºArrayBuffer
      const imagePackerApi = image.createImagePacker();
      const packOpts: image.PackingOption = {
        format: 'image/jpeg',
        quality: 90
      };
      
      const arrayBuffer = await imagePackerApi.packing(pixelMap, packOpts);
      
      // 5. ç”Ÿæˆæ–‡ä»¶å
      const timestamp = new Date().getTime();
      const fileName = `gift_card_${timestamp}.jpg`;
      
      // 6. åˆ›å»ºç›¸å†Œèµ„æº
      const uri = await phAccessHelper.createAsset(photoAccessHelper.PhotoType.IMAGE, 'jpg');
      
      // 7. æ‰“å¼€æ–‡ä»¶å¹¶å†™å…¥å›¾ç‰‡æ•°æ®
      const file = await fs.open(uri, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE);
      await fs.write(file.fd, arrayBuffer);
      await fs.close(file.fd);
      
      console.log('ç¤¼ç‰©å¡å·²æˆåŠŸä¿å­˜åˆ°ç›¸å†Œ');
      
    } catch (error) {
      console.error('ç”Ÿæˆå¡ç‰‡å¤±è´¥:', error);
      const businessError = error as BusinessError;
      if (businessError.code === 201) {
        throw new Error('éœ€è¦ç›¸å†Œè®¿é—®æƒé™æ‰èƒ½ä¿å­˜å›¾ç‰‡');
      } else if (businessError.code === 14000011) {
        throw new Error('æˆªå›¾å¤±è´¥ï¼Œè¯·é‡è¯•');
      } else {
        throw new Error('ä¿å­˜åˆ°ç›¸å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥å­˜å‚¨ç©ºé—´');
      }
    }
  }


  
  showSuccessMessage() {
    // æ˜¾ç¤ºä¿å­˜æˆåŠŸçš„æç¤º
    console.log('å¡ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ');
  }

  showErrorMessage(error: Error) {
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    let message = 'ä¿å­˜å¤±è´¥';
    if (error.message.includes('æƒé™')) {
      message = 'éœ€è¦ç›¸å†Œè®¿é—®æƒé™æ‰èƒ½ä¿å­˜å›¾ç‰‡';
    } else if (error.message.includes('æˆªå›¾')) {
      message = 'æˆªå›¾å¤±è´¥ï¼Œè¯·é‡è¯•';
    } else if (error.message.includes('ä¿å­˜')) {
      message = 'ä¿å­˜åˆ°ç›¸å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥å­˜å‚¨ç©ºé—´';
    }
    console.error('ä¿å­˜ç¤¼ç‰©å¡å¤±è´¥:', message);
  }
  
  goBack() {
    router.back();
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Image($r('app.media.icon_back'))
            .width(24)
            .height(24)
            .fillColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.goBack()
        })
        
        Text('ç¤¼ç‰©å¡åˆ¶ä½œå™¨')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Button() {
          Text('é¢„è§ˆ')
            .fontSize(16)
            .fontColor(this.isFormValid() ? '#FF6B35' : '#CCCCCC')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .opacity(this.isFormValid() ? 1.0 : 0.6)
        .onClick(() => this.togglePreview())
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      
      // ç¼–è¾‘æ¨¡å¼
        Scroll() {
          Column() {
            // æ¨¡æ¿é€‰æ‹©
            Column() {
              Text('é€‰æ‹©æ¨¡æ¿')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 16 })
              
              Grid() {
                ForEach(this.templates, (template: CardTemplate) => {
                  GridItem() {
                    Column() {
                      // æ¨¡æ¿é¢„è§ˆ
                      Column() {
                        Text('ç¤¼ç‰©å¡')
                          .fontSize(12)
                          .fontColor(template.textColor)
                          .fontWeight(FontWeight.Bold)
                        
                        Text('â¤ï¸')
                          .fontSize(16)
                          .margin({ top: 4 })
                        
                        Text('ç¥ç¦è¯­')
                          .fontSize(10)
                          .fontColor(template.accentColor)
                          .margin({ top: 4 })
                      }
                      .width('100%')
                      .height(80)
                      .justifyContent(FlexAlign.Center)
                      .backgroundColor(template.backgroundColor)
                      .borderRadius(8)
                      .border({
                        width: this.selectedTemplate?.id === template.id ? 2 : 1,
                        color: this.selectedTemplate?.id === template.id ? '#FF6B35' : '#E0E0E0'
                      })
                      
                      Text(template.name)
                        .fontSize(12)
                        .fontColor('#666666')
                        .margin({ top: 8 })
                        .textAlign(TextAlign.Center)
                    }
                    .onClick(() => this.selectTemplate(template))
                  }
                })
              }
              .columnsTemplate('1fr 1fr 1fr 1fr')
              .columnsGap(12)
              .rowsGap(16)
              .width('100%')
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
            
            // æ–‡å­—ç¼–è¾‘
            Column() {
              Text('ç¼–è¾‘å†…å®¹')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 16 })
              
              // æ”¶ä»¶äºº
              Column() {
                Text('æ”¶ä»¶äºº')
                  .fontSize(14)
                  .fontColor('#666666')
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })
                
                TextInput({ placeholder: 'è¾“å…¥æ”¶ä»¶äººå§“å', text: this.receiverName })
                  .fontSize(16)
                  .backgroundColor('#F8F9FA')
                  .borderRadius(8)
                  .padding({ left: 16, right: 16 })
                  .onChange((value: string) => {
                    this.receiverName = value;
                  })
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .margin({ bottom: 16 })
              
              // ç¥ç¦è¯­
              Column() {
                Text('ç¥ç¦è¯­')
                  .fontSize(14)
                  .fontColor('#666666')
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })
                
                TextArea({ placeholder: 'å†™ä¸‹ä½ çš„ç¥ç¦è¯­...', text: this.customMessage })
                  .fontSize(16)
                  .backgroundColor('#F8F9FA')
                  .borderRadius(8)
                  .padding(16)
                  .height(120)
                  .onChange((value: string) => {
                    this.customMessage = value;
                  })
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .margin({ bottom: 16 })
              
              // å‘ä»¶äºº
              Column() {
                Text('å‘ä»¶äºº')
                  .fontSize(14)
                  .fontColor('#666666')
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })
                
                TextInput({ placeholder: 'è¾“å…¥ä½ çš„å§“å' })
                  .fontSize(16)
                  .backgroundColor('#F8F9FA')
                  .borderRadius(8)
                  .padding({ left: 16, right: 16 })
                  .onChange((value: string) => {
                    this.senderName = value;
                  })
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
            
            // å¿«é€Ÿæ¨¡æ¿æ–‡å­—
            Column() {
              Text('å¿«é€Ÿæ¨¡æ¿')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 16 })
              
              Flex({ wrap: FlexWrap.Wrap }) {
                ForEach(this.getQuickTemplates(), (template: string) => {
                  Button(template)
                    .fontSize(12)
                    .fontColor('#666666')
                    .backgroundColor('#F5F5F5')
                    .borderRadius(16)
                    .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                    .margin({ right: 8, bottom: 8 })
                    .onClick(() => {
                      this.customMessage = template;
                    })
                })
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
          }
          .padding(16)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }
  
  @Builder
  CardPreview() {
    if (this.selectedTemplate) {
      Stack() {
        // å¡ç‰‡èƒŒæ™¯
        Rect()
          .width(300)
          .height(200)
          .fill(this.selectedTemplate.backgroundColor)
          .borderRadius(16)
          .shadow({
            radius: 20,
            color: '#00000020',
            offsetX: 0,
            offsetY: 8
          })
        
        // å¡ç‰‡å†…å®¹
        Column() {
          // è£…é¥°å…ƒç´ 
          Text('ğŸ')
            .fontSize(24)
            .margin({ bottom: 8 })
          
          // æ”¶ä»¶äºº
          if (this.receiverName) {
            Text(`äº²çˆ±çš„ ${this.receiverName}`)
              .fontSize(14)
              .fontColor(this.selectedTemplate!.textColor)
              .margin({ bottom: 12 })
          }
          
          // ç¥ç¦è¯­
          Text(this.customMessage || 'åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„ç¥ç¦è¯­...')
            .fontSize(16)
            .fontColor(this.selectedTemplate!.textColor)
            .textAlign(TextAlign.Center)
            .maxLines(4)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .lineHeight(24)
            .margin({ bottom: 16 })
          
          // å‘ä»¶äºº
          if (this.senderName) {
            Text(`â€”â€” ${this.senderName}`)
              .fontSize(12)
              .fontColor(this.selectedTemplate!.accentColor)
              .alignSelf(ItemAlign.End)
          }
        }
        .width(260)
        .padding(20)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
  }
  
  getQuickTemplates(): string[] {
    return [
      'ç”Ÿæ—¥å¿«ä¹ï¼æ„¿ä½ çš„æ¯ä¸€å¤©éƒ½å……æ»¡é˜³å…‰å’Œå¿«ä¹ï¼',
      'æ„Ÿè°¢ä½ ä¸€ç›´ä»¥æ¥çš„é™ªä¼´ï¼Œè¿™ä»½å°ç¤¼ç‰©ä»£è¡¨æˆ‘çš„å¿ƒæ„ã€‚',
      'æ„¿è¿™ä»½ç¤¼ç‰©èƒ½å¸¦ç»™ä½ æ¸©æš–å’ŒæƒŠå–œï¼',
      'è™½ç„¶ç¤¼ç‰©ä¸è´µé‡ï¼Œä½†æ‰¿è½½ç€æˆ‘æ»¡æ»¡çš„ç¥ç¦ã€‚',
      'å¸Œæœ›ä½ ä¼šå–œæ¬¢è¿™ä»½ç²¾å¿ƒæŒ‘é€‰çš„ç¤¼ç‰©ï¼',
      'æ„¿æˆ‘ä»¬çš„å‹è°Šå¦‚è¿™ä»½ç¤¼ç‰©ä¸€æ ·çè´µï¼',
      'æ–°å¹´å¿«ä¹ï¼æ„¿æ–°çš„ä¸€å¹´é‡Œä¸€åˆ‡é¡ºåˆ©ï¼',
      'æ­å–œä½ ï¼è¿™ä»½ç¤¼ç‰©æ˜¯å¯¹ä½ æˆå°±çš„å°å°åº†ç¥ã€‚',
      'è°¢è°¢ä½ çš„å¸®åŠ©ï¼Œè¿™æ˜¯æˆ‘çš„ä¸€ç‚¹å¿ƒæ„ã€‚',
      'æ„¿è¿™ä»½ç¤¼ç‰©èƒ½è®©ä½ æ„Ÿå—åˆ°æˆ‘çš„å…³çˆ±ã€‚'
    ];
  }
}