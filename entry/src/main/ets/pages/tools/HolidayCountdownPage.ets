import router from '@ohos.router';

interface Holiday {
  id: string;
  name: string;
  date: string; // YYYY-MM-DD format
  icon: string;
  color: string;
  description: string;
  isAnnual: boolean; // ÊòØÂê¶ÊØèÂπ¥ÈáçÂ§ç
}

interface CountdownInfo {
  days: number;
  hours: number;
  minutes: number;
  seconds: number;
  isPast: boolean;
}

@Entry
@Component
struct HolidayCountdownPage {
  @State holidays: Holiday[] = [];
  @State currentTime: number = Date.now();
  private timer: number = -1;
  
  aboutToAppear() {
    this.loadHolidays();
    this.startTimer();
  }
  
  aboutToDisappear() {
    if (this.timer !== -1) {
      clearInterval(this.timer);
    }
  }
  
  loadHolidays() {
    const currentYear = new Date().getFullYear();
    const nextYear = currentYear + 1;
    
    this.holidays = [
      {
        id: '1',
        name: 'Êò•ËäÇ',
        date: `${nextYear}-02-10`, // 2025Âπ¥Êò•ËäÇ
        icon: 'üßß',
        color: '#F44336',
        description: '‰∏≠ÂõΩ‰º†ÁªüÊñ∞Âπ¥ÔºåÈòñÂÆ∂Âõ¢ÂúÜÁöÑÈáçË¶ÅËäÇÊó•',
        isAnnual: true
      },
      {
        id: '2',
        name: 'ÊÉÖ‰∫∫ËäÇ',
        date: `${nextYear}-02-14`,
        icon: 'üíï',
        color: '#E91E63',
        description: 'Êµ™Êº´ÁöÑÁà±ÊÉÖËäÇÊó•ÔºåË°®ËææÁà±ÊÑèÁöÑÂ•ΩÊó∂Êú∫',
        isAnnual: true
      },
      {
        id: '3',
        name: 'Â¶áÂ•≥ËäÇ',
        date: `${nextYear}-03-08`,
        icon: 'üå∏',
        color: '#9C27B0',
        description: 'ÂêëË∫´ËæπÁöÑÂ•≥ÊÄßË°®ËææÂÖ≥Áà±ÂíåÊÑüË∞¢',
        isAnnual: true
      },
      {
        id: '4',
        name: 'ÊØç‰∫≤ËäÇ',
        date: `${nextYear}-05-11`, // 2025Âπ¥ÊØç‰∫≤ËäÇÔºà5ÊúàÁ¨¨‰∫å‰∏™Âë®Êó•Ôºâ
        icon: 'üåπ',
        color: '#FF9800',
        description: 'ÊÑüÊÅ©ÊØç‰∫≤ÔºåË°®ËææÂØπÊØçÁà±ÁöÑÊÑüÊøÄ',
        isAnnual: true
      },
      {
        id: '5',
        name: 'ÂÑøÁ´•ËäÇ',
        date: `${nextYear}-06-01`,
        icon: 'üéà',
        color: '#4CAF50',
        description: 'Â±û‰∫éÂ≠©Â≠ê‰ª¨ÁöÑÂø´‰πêËäÇÊó•',
        isAnnual: true
      },
      {
        id: '6',
        name: 'Áà∂‰∫≤ËäÇ',
        date: `${nextYear}-06-15`, // 2025Âπ¥Áà∂‰∫≤ËäÇÔºà6ÊúàÁ¨¨‰∏â‰∏™Âë®Êó•Ôºâ
        icon: 'üëî',
        color: '#2196F3',
        description: 'ÂêëÁà∂‰∫≤Ë°®ËææÊï¨ÊÑèÂíåÊÑüË∞¢ÁöÑËäÇÊó•',
        isAnnual: true
      },
      {
        id: '7',
        name: '‰∏≠ÁßãËäÇ',
        date: `${nextYear}-10-06`, // 2025Âπ¥‰∏≠ÁßãËäÇ
        icon: 'ü•Æ',
        color: '#FF9800',
        description: 'Âõ¢ÂúÜ‰Ω≥ËäÇÔºåËµèÊúàÂìÅÊúàÈ•º',
        isAnnual: true
      },
      {
        id: '8',
        name: '‰∏áÂú£ËäÇ',
        date: `${nextYear}-10-31`,
        icon: 'üéÉ',
        color: '#FF5722',
        description: 'Á•ûÁßòÊúâË∂£ÁöÑË•øÊñπËäÇÊó•',
        isAnnual: true
      },
      {
        id: '9',
        name: 'ÊÑüÊÅ©ËäÇ',
        date: `${nextYear}-11-27`, // 2025Âπ¥ÊÑüÊÅ©ËäÇÔºà11ÊúàÁ¨¨Âõõ‰∏™Âë®ÂõõÔºâ
        icon: 'ü¶É',
        color: '#8BC34A',
        description: 'ÊÑüÊÅ©Ë∫´ËæπÁöÑ‰∫∫Âíå‰∫ã',
        isAnnual: true
      },
      {
        id: '10',
        name: 'Âú£ËØûËäÇ',
        date: `${nextYear}-12-25`,
        icon: 'üéÑ',
        color: '#4CAF50',
        description: 'ÂÖÖÊª°Ê∏©È¶®ÂíåÁ•ùÁ¶èÁöÑËäÇÊó•',
        isAnnual: true
      }
    ];
    
    // ÊåâÊó•ÊúüÊéíÂ∫è
    this.holidays.sort((a, b) => {
      const dateA = new Date(a.date).getTime();
      const dateB = new Date(b.date).getTime();
      return dateA - dateB;
    });
  }
  
  startTimer() {
    this.timer = setInterval(() => {
      this.currentTime = Date.now();
    }, 1000);
  }
  
  getCountdown(holiday: Holiday): CountdownInfo {
    const targetDate = new Date(holiday.date).getTime();
    const now = this.currentTime;
    const diff = targetDate - now;
    
    if (diff <= 0) {
      return {
        days: 0,
        hours: 0,
        minutes: 0,
        seconds: 0,
        isPast: true
      };
    }
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    return {
      days,
      hours,
      minutes,
      seconds,
      isPast: false
    };
  }
  
  getUpcomingHolidays(): Holiday[] {
    return this.holidays.filter(holiday => {
      const countdown = this.getCountdown(holiday);
      return !countdown.isPast;
    }).slice(0, 3); // Âè™ÊòæÁ§∫ÊúÄËøëÁöÑ3‰∏™ËäÇÊó•
  }
  
  formatCountdownText(countdown: CountdownInfo): string {
    if (countdown.isPast) {
      return 'Â∑≤ËøáÊúü';
    }
    
    if (countdown.days > 0) {
      return `${countdown.days}Â§© ${countdown.hours}Â∞èÊó∂`;
    } else if (countdown.hours > 0) {
      return `${countdown.hours}Â∞èÊó∂ ${countdown.minutes}ÂàÜÈíü`;
    } else {
      return `${countdown.minutes}ÂàÜ ${countdown.seconds}Áßí`;
    }
  }
  
  getCountdownStatus(countdown: CountdownInfo): string {
    if (countdown.isPast) {
      return 'Â∑≤ËøáÊúü';
    }
    
    if (countdown.days === 0 && countdown.hours === 0 && countdown.minutes < 60) {
      return 'Âç≥Â∞ÜÂà∞Êù•';
    } else if (countdown.days === 0) {
      return '‰ªäÂ§©';
    } else if (countdown.days === 1) {
      return 'ÊòéÂ§©';
    } else if (countdown.days <= 7) {
      return 'Êú¨Âë®';
    } else if (countdown.days <= 30) {
      return 'Êú¨Êúà';
    } else {
      return 'ËæÉËøú';
    }
  }
  
  getStatusColor(countdown: CountdownInfo): string {
    if (countdown.isPast) {
      return '#999999';
    }
    
    if (countdown.days === 0) {
      return '#F44336'; // Á∫¢Ëâ≤ - ‰ªäÂ§©
    } else if (countdown.days <= 7) {
      return '#FF9800'; // Ê©ôËâ≤ - ‰∏ÄÂë®ÂÜÖ
    } else if (countdown.days <= 30) {
      return '#4CAF50'; // ÁªøËâ≤ - ‰∏ÄÊúàÂÜÖ
    } else {
      return '#2196F3'; // ËìùËâ≤ - ËæÉËøú
    }
  }
  
  goBack() {
    router.back();
  }
  
  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      Row() {
        Button() {
          Text('‚Üê')
              .fontSize(20)
              .fontColor('#333333')
            .width(24)
            .height(24)
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => this.goBack())
        
        Text('ËäÇÊó•ÂÄíËÆ°Êó∂')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Row()
          .width(40)
          .height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      
      Scroll() {
        Column() {
          // Âç≥Â∞ÜÂà∞Êù•ÁöÑËäÇÊó•
          Column() {
            Text('Âç≥Â∞ÜÂà∞Êù•')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 20 })
            
            ForEach(this.getUpcomingHolidays(), (holiday: Holiday, index: number) => {
              
              Column() {
                Row() {
                  // ËäÇÊó•ÂõæÊ†áÂíå‰ø°ÊÅØ
                  Row() {
                    Text(holiday.icon)
                      .fontSize(32)
                      .margin({ right: 16 })
                    
                    Column() {
                      Text(holiday.name)
                        .fontSize(18)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#333333')
                        .alignSelf(ItemAlign.Start)
                      
                      Text(holiday.description)
                        .fontSize(14)
                        .fontColor('#666666')
                        .alignSelf(ItemAlign.Start)
                        .margin({ top: 4 })
                      
                      Text(holiday.date)
                        .fontSize(12)
                        .fontColor('#999999')
                        .alignSelf(ItemAlign.Start)
                        .margin({ top: 2 })
                    }
                    .alignItems(HorizontalAlign.Start)
                    .layoutWeight(1)
                  }
                  .layoutWeight(1)
                  .alignItems(VerticalAlign.Center)
                  
                  // ÂÄíËÆ°Êó∂‰ø°ÊÅØ
                  Column() {
                    Text(this.formatCountdownText(this.getCountdown(holiday)))
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor(this.getStatusColor(this.getCountdown(holiday)))
                      .textAlign(TextAlign.Center)
                    
                    Text(this.getCountdownStatus(this.getCountdown(holiday)))
                      .fontSize(12)
                      .fontColor(this.getStatusColor(this.getCountdown(holiday)))
                      .textAlign(TextAlign.Center)
                      .margin({ top: 4 })
                      .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                      .backgroundColor(this.getStatusColor(this.getCountdown(holiday)) + '20')
                      .borderRadius(10)
                  }
                  .alignItems(HorizontalAlign.Center)
                }
                .width('100%')
                .padding(20)
                .alignItems(VerticalAlign.Center)
                
                // ËØ¶ÁªÜÂÄíËÆ°Êó∂Ôºà‰ªÖÂØπÊúÄËøëÁöÑËäÇÊó•ÊòæÁ§∫Ôºâ
                if (index === 0 && !this.getCountdown(holiday).isPast) {
                  Row() {
                    // Â§©Êï∞
                    Column() {
                      Text(this.getCountdown(holiday).days.toString())
                        .fontSize(24)
                        .fontWeight(FontWeight.Bold)
                        .fontColor(holiday.color)
                      
                      Text('Â§©')
                        .fontSize(12)
                        .fontColor('#666666')
                        .margin({ top: 4 })
                    }
                    .layoutWeight(1)
                    .alignItems(HorizontalAlign.Center)
                    
                    Text(':')
                      .fontSize(20)
                      .fontColor('#CCCCCC')
                      .margin({ left: 8, right: 8 })
                    
                    // Â∞èÊó∂
                    Column() {
                      Text(this.getCountdown(holiday).hours.toString().padStart(2, '0'))
                        .fontSize(24)
                        .fontWeight(FontWeight.Bold)
                        .fontColor(holiday.color)
                      
                      Text('Â∞èÊó∂')
                        .fontSize(12)
                        .fontColor('#666666')
                        .margin({ top: 4 })
                    }
                    .layoutWeight(1)
                    .alignItems(HorizontalAlign.Center)
                    
                    Text(':')
                      .fontSize(20)
                      .fontColor('#CCCCCC')
                      .margin({ left: 8, right: 8 })
                    
                    // ÂàÜÈíü
                    Column() {
                      Text(this.getCountdown(holiday).minutes.toString().padStart(2, '0'))
                        .fontSize(24)
                        .fontWeight(FontWeight.Bold)
                        .fontColor(holiday.color)
                      
                      Text('ÂàÜÈíü')
                        .fontSize(12)
                        .fontColor('#666666')
                        .margin({ top: 4 })
                    }
                    .layoutWeight(1)
                    .alignItems(HorizontalAlign.Center)
                    
                    Text(':')
                      .fontSize(20)
                      .fontColor('#CCCCCC')
                      .margin({ left: 8, right: 8 })
                    
                    // ÁßíÊï∞
                    Column() {
                      Text(this.getCountdown(holiday).seconds.toString().padStart(2, '0'))
                        .fontSize(24)
                        .fontWeight(FontWeight.Bold)
                        .fontColor(holiday.color)
                      
                      Text('Áßí')
                        .fontSize(12)
                        .fontColor('#666666')
                        .margin({ top: 4 })
                    }
                    .layoutWeight(1)
                    .alignItems(HorizontalAlign.Center)
                  }
                  .width('100%')
                  .padding({ left: 20, right: 20, bottom: 20 })
                  .justifyContent(FlexAlign.Center)
                }
              }
              .width('100%')
              .backgroundColor('#FFFFFF')
              .borderRadius(16)
              .margin({ bottom: 16 })
              .shadow({
                radius: 8,
                color: '#1A000000',
                offsetX: 0,
                offsetY: 2
              })
            })
          }
          .width('100%')
          .margin({ bottom: 24 })
          
          // ÂÖ®Âπ¥ËäÇÊó•ÂàóË°®
          Column() {
            Text('ÂÖ®Âπ¥ËäÇÊó•')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })
            
            Column() {
              ForEach(this.holidays, (holiday: Holiday) => {
                
                Row() {
                  Text(holiday.icon)
                    .fontSize(20)
                    .margin({ right: 12 })
                  
                  Column() {
                    Text(holiday.name)
                      .fontSize(16)
                      .fontColor('#333333')
                      .alignSelf(ItemAlign.Start)
                    
                    Text(holiday.date)
                      .fontSize(12)
                      .fontColor('#999999')
                      .alignSelf(ItemAlign.Start)
                      .margin({ top: 2 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)
                  
                  Text(this.getCountdown(holiday).isPast ? 'Â∑≤ËøáÊúü' : `${this.getCountdown(holiday).days}Â§©Âêé`)
                    .fontSize(14)
                    .fontColor(this.getCountdown(holiday).isPast ? '#999999' : this.getStatusColor(this.getCountdown(holiday)))
                    .fontWeight(FontWeight.Medium)
                }
                .width('100%')
                .padding({ top: 12, bottom: 12 })
                .alignItems(VerticalAlign.Center)
                .border({ width: { bottom: 1 }, color: '#F0F0F0' })
              })
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
          }
          .width('100%')
        }
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }
}