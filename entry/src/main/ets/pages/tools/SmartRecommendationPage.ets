import router from '@ohos.router';

interface RecommendationQuestion {
  id: string;
  question: string;
  options: string[];
  selectedOption: string;
}

interface GiftSuggestion {
  id: string;
  name: string;
  category: string;
  price: string;
  reason: string;
  image: string;
  rating: number;
}

@Entry
@Component
struct SmartRecommendationPage {
  @State currentStep: number = 0;
  @State questions: RecommendationQuestion[] = [];
  @State suggestions: GiftSuggestion[] = [];
  @State isAnalyzing: boolean = false;
  @State showResults: boolean = false;

  aboutToAppear() {
    this.loadQuestions();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Image($r('app.media.icon_back'))
            .width(24)
            .height(24)
            .fillColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back();
        })

        Text('ğŸ¤– æ™ºèƒ½ç¤¼ç‰©æ¨è')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Button() {
          Text('é‡æ–°å¼€å§‹')
            .fontSize(14)
            .fontColor('#FF6B35')
        }
        .width(80)
        .height(32)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.resetRecommendation();
        })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)

      if (this.isAnalyzing) {
        // åˆ†æä¸­çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(60)
            .height(60)
            .color('#FF6B35')

          Text('AIæ­£åœ¨åˆ†æä¸­...')
            .fontSize(16)
            .fontColor('#333333')
            .margin({ top: 20 })

          Text('æ ¹æ®æ‚¨çš„å›ç­”ä¸ºæ‚¨æ¨èæœ€åˆé€‚çš„ç¤¼ç‰©')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 8 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else if (this.showResults) {
        // æ¨èç»“æœ
        this.buildResultsView();
      } else {
        // é—®ç­”æµç¨‹
        this.buildQuestionView();
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }

  @Builder
  buildQuestionView() {
    Column() {
      // è¿›åº¦æŒ‡ç¤ºå™¨
      Row() {
        Text(`${this.currentStep + 1}/${this.questions.length}`)
          .fontSize(14)
          .fontColor('#666666')

        Blank()

        Progress({
          value: this.currentStep + 1,
          total: this.questions.length,
          type: ProgressType.Linear
        })
          .width(200)
          .height(4)
          .color('#FF6B35')
          .backgroundColor('#F0F0F0')
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)

      Scroll() {
        Column() {
          if (this.currentStep < this.questions.length) {
            Text(this.questions[this.currentStep].question)
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 30 })

            // é€‰é¡¹åˆ—è¡¨
            Column() {
              ForEach(this.questions[this.currentStep].options, (option: string, index: number) => {
                Row() {
                  Text(option)
                    .fontSize(16)
                    .fontColor(this.questions[this.currentStep].selectedOption === option ? '#FF6B35' : '#333333')
                    .layoutWeight(1)

                  if (this.questions[this.currentStep].selectedOption === option) {
                    Image($r('app.media.icon_check'))
                      .width(20)
                      .height(20)
                      .fillColor('#FF6B35')
                  }
                }
                .width('100%')
                .height(60)
                .padding({ left: 20, right: 20 })
                .backgroundColor(this.questions[this.currentStep].selectedOption === option ? '#FFF5F0' : Color.White)
                .borderRadius(12)
                .border({
                  width: 2,
                  color: this.questions[this.currentStep].selectedOption === option ? '#FF6B35' : '#F0F0F0'
                })
                .margin({ bottom: 12 })
                .onClick(() => {
                  this.selectOption(this.questions[this.currentStep].id, option);
                })
              }, (option: string) => option)
            }
            .width('100%')
          }
        }
        .width('100%')
        .padding(20)
      }
      .layoutWeight(1)

      // åº•éƒ¨æŒ‰é’®
      Row() {
        if (this.currentStep > 0) {
          Button('ä¸Šä¸€æ­¥')
            .fontSize(16)
            .fontColor('#666666')
            .backgroundColor('#F0F0F0')
            .borderRadius(25)
            .width(100)
            .height(50)
            .onClick(() => {
              this.previousStep();
            })
        }

        Blank()

        Button(this.currentStep === this.questions.length - 1 ? 'è·å–æ¨è' : 'ä¸‹ä¸€æ­¥')
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor(this.canProceed() ? '#FF6B35' : '#CCCCCC')
          .borderRadius(25)
          .width(120)
          .height(50)
          .enabled(this.canProceed())
          .onClick(() => {
            if (this.currentStep === this.questions.length - 1) {
              this.generateRecommendations();
            } else {
              this.nextStep();
            }
          })
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)
    }
  }

  @Builder
  buildResultsView() {
    Scroll() {
      Column() {
        // ç»“æœæ ‡é¢˜
        Text('ğŸ ä¸ºæ‚¨æ¨èä»¥ä¸‹ç¤¼ç‰©')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ bottom: 20 })

        // æ¨èåˆ—è¡¨
        ForEach(this.suggestions, (suggestion: GiftSuggestion) => {
          Column() {
            Row() {
              Image(suggestion.image)
                .width(80)
                .height(80)
                .borderRadius(8)
                .backgroundColor('#F0F0F0')

              Column() {
                Text(suggestion.name)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                  .alignSelf(ItemAlign.Start)

                Text(suggestion.category)
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ top: 4 })
                  .alignSelf(ItemAlign.Start)

                Text(suggestion.price)
                  .fontSize(14)
                  .fontColor('#FF6B35')
                  .fontWeight(FontWeight.Medium)
                  .margin({ top: 8 })
                  .alignSelf(ItemAlign.Start)

                // è¯„åˆ†
                Row() {
                  ForEach([0, 1, 2, 3, 4], (starIndex: number) => {
                    Text('â­')
                      .fontSize(12)
                      .fontColor(starIndex < suggestion.rating ? '#FFD700' : '#E0E0E0')
                  }, (starIndex: number) => starIndex.toString())
                }
                .margin({ top: 4 })
              }
              .layoutWeight(1)
              .margin({ left: 12 })
              .alignItems(HorizontalAlign.Start)
            }
            .width('100%')
            .alignItems(VerticalAlign.Top)

            Text(`æ¨èç†ç”±ï¼š${suggestion.reason}`)
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 12 })
              .alignSelf(ItemAlign.Start)

            Button('æŸ¥çœ‹è¯¦æƒ…')
              .fontSize(14)
              .fontColor('#FF6B35')
              .backgroundColor('#FFF5F0')
              .borderRadius(20)
              .height(36)
              .width(100)
              .margin({ top: 12 })
              .alignSelf(ItemAlign.End)
              .onClick(() => {
                console.info('æŸ¥çœ‹ç¤¼ç‰©è¯¦æƒ…:', suggestion.id);
              })
          }
          .width('100%')
          .padding(16)
          .backgroundColor(Color.White)
          .borderRadius(12)
          .margin({ bottom: 12 })
        })

        // é‡æ–°æ¨èæŒ‰é’®
        Button('é‡æ–°æ¨è')
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor('#FF6B35')
          .borderRadius(25)
          .width(200)
          .height(50)
          .margin({ top: 20, bottom: 20 })
          .onClick(() => {
            this.resetRecommendation();
          })
      }
      .width('100%')
      .padding(20)
    }
    .layoutWeight(1)
  }

  private loadQuestions(): void {
    this.questions = [
      {
        id: '1',
        question: 'æ‚¨è¦é€ç¤¼ç»™è°ï¼Ÿ',
        options: ['æ‹äºº/é…å¶', 'å®¶äºº', 'æœ‹å‹', 'åŒäº‹', 'é•¿è¾ˆ'],
        selectedOption: ''
      },
      {
        id: '2',
        question: 'ä»€ä¹ˆåœºåˆé€ç¤¼ï¼Ÿ',
        options: ['ç”Ÿæ—¥', 'èŠ‚æ—¥åº†ç¥', 'çºªå¿µæ—¥', 'æ„Ÿè°¢/é“æ­‰', 'æ—¥å¸¸è¡¨è¾¾'],
        selectedOption: ''
      },
      {
        id: '3',
        question: 'æ‚¨çš„é¢„ç®—èŒƒå›´ï¼Ÿ',
        options: ['50å…ƒä»¥ä¸‹', '50-200å…ƒ', '200-500å…ƒ', '500-1000å…ƒ', '1000å…ƒä»¥ä¸Š'],
        selectedOption: ''
      },
      {
        id: '4',
        question: 'æ”¶ç¤¼äººçš„æ€§åˆ«ï¼Ÿ',
        options: ['ç”·æ€§', 'å¥³æ€§', 'ä¸ç¡®å®š'],
        selectedOption: ''
      },
      {
        id: '5',
        question: 'æ”¶ç¤¼äººçš„å¹´é¾„æ®µï¼Ÿ',
        options: ['å„¿ç«¥(0-12å²)', 'é’å°‘å¹´(13-18å²)', 'é’å¹´(19-35å²)', 'ä¸­å¹´(36-55å²)', 'è€å¹´(55å²ä»¥ä¸Š)'],
        selectedOption: ''
      }
    ];
  }

  private selectOption(questionId: string, option: string): void {
    const questionIndex = this.questions.findIndex(q => q.id === questionId);
    if (questionIndex !== -1) {
      this.questions[questionIndex].selectedOption = option;
    }
  }

  private canProceed(): boolean {
    if (this.currentStep < this.questions.length) {
      return this.questions[this.currentStep].selectedOption !== '';
    }
    return false;
  }

  private nextStep(): void {
    if (this.currentStep < this.questions.length - 1) {
      this.currentStep++;
    }
  }

  private previousStep(): void {
    if (this.currentStep > 0) {
      this.currentStep--;
    }
  }

  private generateRecommendations(): void {
    this.isAnalyzing = true;
    
    // æ¨¡æ‹ŸAIåˆ†æè¿‡ç¨‹
    setTimeout(() => {
      this.suggestions = [
        {
          id: '1',
          name: 'å®šåˆ¶ç…§ç‰‡ç›¸å†Œ',
          category: 'çºªå¿µå“',
          price: 'ï¿¥128',
          reason: 'æ ¹æ®æ‚¨çš„é€‰æ‹©ï¼Œè¿™æ˜¯ä¸€ä»½å……æ»¡å›å¿†å’Œä¸ªäººæ„ä¹‰çš„ç¤¼ç‰©',
          image: '',
          rating: 5
        },
        {
          id: '2',
          name: 'é¦™è–°èœ¡çƒ›å¥—è£…',
          category: 'ç”Ÿæ´»ç”¨å“',
          price: 'ï¿¥89',
          reason: 'è¥é€ æ¸©é¦¨æ°›å›´ï¼Œé€‚åˆè¡¨è¾¾å…³æ€€ä¹‹æ„',
          image: '',
          rating: 4
        },
        {
          id: '3',
          name: 'æ‰‹å·¥å·§å…‹åŠ›ç¤¼ç›’',
          category: 'ç¾é£Ÿ',
          price: 'ï¿¥156',
          reason: 'ç”œèœœçš„å‘³é“ä¼ é€’ç”œèœœçš„å¿ƒæ„',
          image: '',
          rating: 4
        }
      ];
      
      this.isAnalyzing = false;
      this.showResults = true;
    }, 2000);
  }

  private resetRecommendation(): void {
    this.currentStep = 0;
    this.showResults = false;
    this.isAnalyzing = false;
    this.suggestions = [];
    this.questions.forEach(question => {
      question.selectedOption = '';
    });
  }
}