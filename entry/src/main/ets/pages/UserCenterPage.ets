import { Gift, GiftCategory, Scenario } from '../model/GiftModel';
import { GiftRecommendationService } from '../service/GiftRecommendationService';
import router from '@ohos.router';

// ç”¨æˆ·ä¿¡æ¯æ¥å£
interface UserInfo {
  id: string;
  name: string;
  avatar: string;
  email: string;
  phone: string;
  memberLevel: string;
  joinDate: string;
}

// ä»·æ ¼åŒºé—´æ¥å£
interface PriceRange {
  min: number;
  max: number;
}

// ç”¨æˆ·åå¥½è®¾ç½®æ¥å£
interface UserPreferences {
  favoriteCategories: GiftCategory[];
  priceRange: PriceRange;
  reminderEnabled: boolean;
  notificationEnabled: boolean;
  theme: 'light' | 'dark';
}

// å†å²è®°å½•æ¥å£
interface GiftHistory {
  id: string;
  gift: Gift;
  viewTime: string;
  action: 'view' | 'favorite' | 'share';
}

@Entry
@Component
struct UserCenterPage {
  @State userInfo: UserInfo = {
    id: '1',
    name: 'ç¤¼ç‰©è¾¾äºº',
    avatar: 'ğŸ‘¤',
    email: 'user@example.com',
    phone: '138****8888',
    memberLevel: 'VIP',
    joinDate: '2023-01-01'
  };
  @State favoriteGifts: Gift[] = [];
  @State giftHistory: GiftHistory[] = [];
  @State userPreferences: UserPreferences = {
    favoriteCategories: [GiftCategory.FLOWERS, GiftCategory.JEWELRY],
    priceRange: { min: 100, max: 1000 } as PriceRange,
    reminderEnabled: true,
    notificationEnabled: true,
    theme: 'light'
  };
  @State currentTab: number = 0;
  @State loading: boolean = false;
  private giftService: GiftRecommendationService = GiftRecommendationService.getInstance();

  aboutToAppear() {
    this.loadUserData();
  }

  build() {
    Column() {
      this.buildHeader()
      this.buildUserProfile()
      this.buildTabBar()
      this.buildTabContent()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }

  @Builder
  buildHeader() {
    Row() {
      Text('â†')
        .fontSize(24)
        .fontColor('#333333')
        .onClick(() => {
          router.back();
        })

      Text('ä¸ªäººä¸­å¿ƒ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Text('âš™ï¸')
        .fontSize(24)
        .onClick(() => {
          // è·³è½¬åˆ°è®¾ç½®é¡µé¢
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildUserProfile() {
    Column() {
      Row() {
        // å¤´åƒ
        Column() {
          Text(this.userInfo.avatar)
            .fontSize(40)
        }
        .width(80)
        .height(80)
        .backgroundColor('#E3F2FD')
        .borderRadius(40)
        .justifyContent(FlexAlign.Center)
        .margin({ right: 16 })

        // ç”¨æˆ·ä¿¡æ¯
        Column() {
          Row() {
            Text(this.userInfo.name)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
            
            Text(this.userInfo.memberLevel)
              .fontSize(12)
              .fontColor('#FF9800')
              .backgroundColor('#FFF3E0')
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .borderRadius(10)
              .margin({ left: 8 })
          }
          .margin({ bottom: 8 })

          Text(`é‚®ç®±: ${this.userInfo.email}`)
            .fontSize(14)
            .fontColor('#666666')
            .margin({ bottom: 4 })

          Text(`æ‰‹æœº: ${this.userInfo.phone}`)
            .fontSize(14)
            .fontColor('#666666')
            .margin({ bottom: 4 })

          Text(`åŠ å…¥æ—¶é—´: ${this.userInfo.joinDate}`)
            .fontSize(12)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 20 })

      // ç»Ÿè®¡ä¿¡æ¯
      Row() {
        this.buildStatItem('æ”¶è—', this.favoriteGifts.length.toString())
        this.buildStatItem('æµè§ˆ', this.giftHistory.length.toString())
        this.buildStatItem('åˆ†äº«', '12')
        this.buildStatItem('ç§¯åˆ†', '2580')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .margin({ bottom: 16 })
  }

  @Builder
  buildStatItem(label: string, value: string) {
    Column() {
      Text(value)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#4CAF50')
        .margin({ bottom: 4 })
      
      Text(label)
        .fontSize(12)
        .fontColor('#999999')
    }
  }

  @Builder
  buildTabBar() {
    Row() {
      this.buildTabItem('æ”¶è—å¤¹', 0)
      this.buildTabItem('æµè§ˆå†å²', 1)
      this.buildTabItem('åå¥½è®¾ç½®', 2)
    }
    .width('100%')
    .height(48)
    .backgroundColor(Color.White)
    .margin({ bottom: 16 })
  }

  @Builder
  buildTabItem(title: string, index: number) {
    Text(title)
      .fontSize(16)
      .fontColor(this.currentTab === index ? '#4CAF50' : '#666666')
      .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Normal)
      .layoutWeight(1)
      .textAlign(TextAlign.Center)
      .height('100%')
      .backgroundColor(this.currentTab === index ? '#E8F5E8' : Color.Transparent)
      .onClick(() => {
        this.currentTab = index;
      })
  }

  @Builder
  buildTabContent() {
    if (this.currentTab === 0) {
      this.buildFavoriteList()
    } else if (this.currentTab === 1) {
      this.buildHistoryList()
    } else {
      this.buildPreferencesSettings()
    }
  }

  @Builder
  buildFavoriteList() {
    if (this.favoriteGifts.length === 0) {
      Column() {
        Text('ğŸ“')
          .fontSize(48)
          .margin({ bottom: 16 })
        
        Text('æš‚æ— æ”¶è—çš„ç¤¼ç‰©')
          .fontSize(16)
          .fontColor('#999999')
          .margin({ bottom: 8 })
        
        Text('å»å‘ç°æ›´å¤šç²¾ç¾ç¤¼ç‰©å§')
          .fontSize(14)
          .fontColor('#CCCCCC')
        
        Button('å»æ¨èé¡µé¢')
          .backgroundColor('#4CAF50')
          .fontColor(Color.White)
          .borderRadius(20)
          .margin({ top: 20 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/GiftRecommendationPage' });
          })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    } else {
      List() {
        ForEach(this.favoriteGifts, (gift: Gift) => {
          ListItem() {
            this.buildGiftCard(gift, true)
          }
          .margin({ bottom: 12 })
        })
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16 })
    }
  }

  @Builder
  buildHistoryList() {
    if (this.giftHistory.length === 0) {
      Column() {
        Text('ğŸ“‹')
          .fontSize(48)
          .margin({ bottom: 16 })
        
        Text('æš‚æ— æµè§ˆè®°å½•')
          .fontSize(16)
          .fontColor('#999999')
          .margin({ bottom: 8 })
        
        Text('å¼€å§‹æ¢ç´¢ç¤¼ç‰©ä¸–ç•Œå§')
          .fontSize(14)
          .fontColor('#CCCCCC')
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    } else {
      List() {
        ForEach(this.giftHistory, (history: GiftHistory) => {
          ListItem() {
            this.buildHistoryCard(history)
          }
          .margin({ bottom: 12 })
        })
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16 })
    }
  }

  @Builder
  buildPreferencesSettings() {
    List() {
      ListItem() {
        this.buildCategoryPreferenceSection()
      }
      .margin({ bottom: 16 })
      
      ListItem() {
        this.buildPriceRangeSection()
      }
      .margin({ bottom: 16 })
      
      ListItem() {
        this.buildNotificationSection()
      }
      .margin({ bottom: 16 })
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ left: 16, right: 16 })
  }

  @Builder
  buildCategoryPreferenceSection() {
    Column() {
      Text('åå¥½åˆ†ç±»')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 12 })
      
      this.buildCategoryPreferences()
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildPriceRangeSection() {
    Column() {
      Text('ä»·æ ¼åŒºé—´')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 12 })
      
      this.buildPriceRangeSettings()
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildNotificationSection() {
    Column() {
      Text('é€šçŸ¥è®¾ç½®')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 12 })
      
      this.buildNotificationSettings()
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildCategoryPreferences() {
    Flex({ wrap: FlexWrap.Wrap }) {
      this.buildCategoryChip('é²œèŠ±', GiftCategory.FLOWERS)
      this.buildCategoryChip('ç å®', GiftCategory.JEWELRY)
      this.buildCategoryChip('æ•°ç ', GiftCategory.ELECTRONICS)
      this.buildCategoryChip('æœé¥°', GiftCategory.CLOTHING)
      this.buildCategoryChip('ç¾å¦†', GiftCategory.COSMETICS)
      this.buildCategoryChip('ä¹¦ç±', GiftCategory.BOOKS)
      this.buildCategoryChip('è¿åŠ¨', GiftCategory.SPORTS)
      this.buildCategoryChip('å®¶å±…', GiftCategory.HOME)
      this.buildCategoryChip('ç¾é£Ÿ', GiftCategory.FOOD)
    }
  }

  @Builder
  buildCategoryChip(label: string, category: GiftCategory) {
    Text(label)
      .fontSize(14)
      .fontColor(this.userPreferences.favoriteCategories.includes(category) ? Color.White : '#666666')
      .backgroundColor(this.userPreferences.favoriteCategories.includes(category) ? '#4CAF50' : '#F0F0F0')
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .borderRadius(16)
      .margin({ right: 8, bottom: 8 })
      .onClick(() => {
        const index = this.userPreferences.favoriteCategories.indexOf(category);
        if (index > -1) {
          this.userPreferences.favoriteCategories.splice(index, 1);
        } else {
          this.userPreferences.favoriteCategories.push(category);
        }
      })
  }

  @Builder
  buildPriceRangeSettings() {
    Column() {
      Row() {
        Text('æœ€ä½ä»·æ ¼:')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ right: 8 })
        
        Text(`Â¥${this.userPreferences.priceRange.min}`)
          .fontSize(14)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      Row() {
        Text('æœ€é«˜ä»·æ ¼:')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ right: 8 })
        
        Text(`Â¥${this.userPreferences.priceRange.max}`)
          .fontSize(14)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      
      Button('è°ƒæ•´ä»·æ ¼åŒºé—´')
        .backgroundColor('#E3F2FD')
        .fontColor('#2196F3')
        .fontSize(14)
        .borderRadius(16)
        .margin({ top: 12 })
        .onClick(() => {
          // æ‰“å¼€ä»·æ ¼è®¾ç½®å¼¹çª—
        })
    }
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildNotificationSettings() {
    Column() {
      Row() {
        Text('é€ç¤¼æé†’')
          .fontSize(14)
          .fontColor('#333333')
          .layoutWeight(1)
        
        Toggle({ type: ToggleType.Switch, isOn: this.userPreferences.reminderEnabled })
          .onChange((isOn: boolean) => {
            this.userPreferences.reminderEnabled = isOn;
          })
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      Row() {
        Text('æ¨é€é€šçŸ¥')
          .fontSize(14)
          .fontColor('#333333')
          .layoutWeight(1)
        
        Toggle({ type: ToggleType.Switch, isOn: this.userPreferences.notificationEnabled })
          .onChange((isOn: boolean) => {
            this.userPreferences.notificationEnabled = isOn;
          })
      }
      .width('100%')
    }
  }

  @Builder
  buildGiftCard(gift: Gift, showFavorite: boolean = false) {
    Row() {
      // ç¤¼ç‰©å›¾ç‰‡
      Column() {
        Text('ğŸ')
          .fontSize(24)
      }
      .width(60)
      .height(60)
      .backgroundColor('#F5F5F5')
      .borderRadius(8)
      .justifyContent(FlexAlign.Center)
      .margin({ right: 12 })

      // ç¤¼ç‰©ä¿¡æ¯
      Column() {
        Text(gift.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .margin({ bottom: 4 })
        
        Text(gift.description)
          .fontSize(14)
          .fontColor('#666666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 8 })
        
        Row() {
          Text(`Â¥${gift.price}`)
            .fontSize(16)
            .fontColor('#FF5722')
            .fontWeight(FontWeight.Bold)
          
          Text(this.getCategoryText(gift.category))
            .fontSize(12)
            .fontColor('#999999')
            .backgroundColor('#F0F0F0')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(4)
            .margin({ left: 8 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // æ“ä½œæŒ‰é’®
      if (showFavorite) {
        Text('â¤ï¸')
          .fontSize(20)
          .onClick(() => {
            // å–æ¶ˆæ”¶è—
            const index = this.favoriteGifts.findIndex(item => item.id === gift.id);
            if (index > -1) {
              this.favoriteGifts.splice(index, 1);
            }
          })
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .onClick(() => {
      // è·³è½¬åˆ°ç¤¼ç‰©è¯¦æƒ…é¡µ
    })
  }

  @Builder
  buildHistoryCard(history: GiftHistory) {
    Row() {
      // ç¤¼ç‰©å›¾ç‰‡
      Column() {
        Text('ğŸ')
          .fontSize(24)
      }
      .width(60)
      .height(60)
      .backgroundColor('#F5F5F5')
      .borderRadius(8)
      .justifyContent(FlexAlign.Center)
      .margin({ right: 12 })

      // ç¤¼ç‰©ä¿¡æ¯
      Column() {
        Text(history.gift.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .margin({ bottom: 4 })
        
        Row() {
          Text(this.getActionText(history.action))
            .fontSize(12)
            .fontColor('#4CAF50')
            .backgroundColor('#E8F5E8')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(4)
          
          Text(history.viewTime)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ left: 8 })
        }
        .margin({ bottom: 4 })
        
        Text(`Â¥${history.gift.price}`)
          .fontSize(14)
          .fontColor('#FF5722')
          .fontWeight(FontWeight.Medium)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .onClick(() => {
      // è·³è½¬åˆ°ç¤¼ç‰©è¯¦æƒ…é¡µ
    })
  }

  private async loadUserData() {
    this.loading = true;
    
    try {
      // æ¨¡æ‹ŸåŠ è½½ç”¨æˆ·æ•°æ®
      setTimeout(() => {
        // åŠ è½½æ”¶è—çš„ç¤¼ç‰©
        this.favoriteGifts = [];
        
        // åŠ è½½æµè§ˆå†å²
        this.giftHistory = [];
        
        this.loading = false;
      }, 1000);
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
      this.loading = false;
    }
  }



  private getCategoryText(category: GiftCategory): string {
    switch (category) {
      case GiftCategory.FLOWERS:
        return 'é²œèŠ±';
      case GiftCategory.JEWELRY:
        return 'ç å®';
      case GiftCategory.ELECTRONICS:
        return 'æ•°ç ';
      case GiftCategory.CLOTHING:
        return 'æœé¥°';
      case GiftCategory.COSMETICS:
        return 'ç¾å¦†';
      case GiftCategory.BOOKS:
        return 'ä¹¦ç±';
      case GiftCategory.SPORTS:
        return 'è¿åŠ¨';
      case GiftCategory.HOME:
        return 'å®¶å±…';
      case GiftCategory.FOOD:
        return 'ç¾é£Ÿ';
      case GiftCategory.TOYS:
        return 'å…¶ä»–';
      default:
        return 'æœªçŸ¥';
    }
  }

  private getActionText(action: string): string {
    switch (action) {
      case 'view':
        return 'æµè§ˆ';
      case 'favorite':
        return 'æ”¶è—';
      case 'share':
        return 'åˆ†äº«';
      default:
        return 'æœªçŸ¥';
    }
  }
}