import { Gift, Scenario, GiftCategory, PriceRange } from '../model/GiftModel';
import { GiftRecommendationService } from '../service/GiftRecommendationService';
import router from '@ohos.router';

// åœºæ™¯ä¿¡æ¯æ¥å£
interface ScenarioInfo {
  key: Scenario;
  name: string;
  icon: string;
  description: string;
  color: string;
  tips: string[];
}

@Entry
@Component
struct ScenarioPage {
  @State private selectedScenario: Scenario | undefined = undefined;
  @State private scenarioName: string = '';
  @State private scenarioGifts: Gift[] = [];
  @State private loading: boolean = false;
  
  private giftService = GiftRecommendationService.getInstance();
  
  // åœºæ™¯æ•°æ®
  private scenarios: ScenarioInfo[] = [
    {
      key: Scenario.BIRTHDAY,
      name: 'ç”Ÿæ—¥ç¤¼ç‰©',
      icon: 'ğŸ‚',
      description: 'ä¸ºç”Ÿæ—¥åº†ç¥æŒ‘é€‰å®Œç¾ç¤¼ç‰©',
      color: '#FF6B6B',
      tips: ['æ ¹æ®å¹´é¾„é€‰æ‹©', 'è€ƒè™‘ä¸ªäººå…´è¶£', 'æ³¨é‡çºªå¿µæ„ä¹‰']
    },
    {
      key: Scenario.VALENTINE,
      name: 'æƒ…äººèŠ‚',
      icon: 'ğŸ’',
      description: 'è¡¨è¾¾çˆ±æ„çš„æµªæ¼«ç¤¼ç‰©',
      color: '#E91E63',
      tips: ['æµªæ¼«ä¸ºä¸»', 'ä¸ªæ€§åŒ–å®šåˆ¶', 'æƒ…æ„Ÿä»·å€¼é‡äºä»·æ ¼']
    },
    {
      key: Scenario.ANNIVERSARY,
      name: 'çºªå¿µæ—¥',
      icon: 'ğŸ’',
      description: 'çºªå¿µé‡è¦æ—¶åˆ»çš„ç‰¹æ®Šç¤¼ç‰©',
      color: '#9C27B0',
      tips: ['çºªå¿µæ„ä¹‰', 'ä¿å­˜ä»·å€¼', 'æƒ…æ„Ÿå…±é¸£']
    },
    {
      key: Scenario.CHRISTMAS,
      name: 'åœ£è¯èŠ‚',
      icon: 'ğŸ„',
      description: 'æ¸©é¦¨èŠ‚æ—¥çš„ç¥ç¦ç¤¼ç‰©',
      color: '#4CAF50',
      tips: ['èŠ‚æ—¥æ°›å›´', 'å®¶åº­æ¸©é¦¨', 'åˆ†äº«å¿«ä¹']
    },
    {
      key: Scenario.GRADUATION,
      name: 'æ¯•ä¸šç¤¼ç‰©',
      icon: 'ğŸ“',
      description: 'åº†ç¥å­¦ä¸šæˆå°±çš„åŠ±å¿—ç¤¼ç‰©',
      color: '#2196F3',
      tips: ['å®ç”¨æ€§å¼º', 'åŠ±å¿—æ„ä¹‰', 'æœªæ¥å¯¼å‘']
    },
    {
      key: Scenario.WEDDING,
      name: 'å©šç¤¼ç¤¼ç‰©',
      icon: 'ğŸ’’',
      description: 'ç¥ç¦æ–°äººçš„ç¾å¥½ç¤¼ç‰©',
      color: '#FF9800',
      tips: ['æˆåŒæˆå¯¹', 'å®ç”¨å®¶å±…', 'ç¾å¥½å¯“æ„']
    },
    {
      key: Scenario.THANK_YOU,
      name: 'æ„Ÿè°¢ç¤¼ç‰©',
      icon: 'ğŸ™',
      description: 'è¡¨è¾¾æ„Ÿæ¿€ä¹‹æƒ…çš„è´´å¿ƒç¤¼ç‰©',
      color: '#607D8B',
      tips: ['å¿ƒæ„ä¸ºé‡', 'å®ç”¨è´´å¿ƒ', 'ä¸å®œè¿‡è´µ']
    },
    {
      key: Scenario.APOLOGY,
      name: 'é“æ­‰ç¤¼ç‰©',
      icon: 'ğŸŒ¹',
      description: 'è¡¨è¾¾æ­‰æ„çš„è¯šæ„ç¤¼ç‰©',
      color: '#795548',
      tips: ['è¯šæ„ä¸ºå…ˆ', 'å¯¹æ–¹å–œå¥½', 'é€‚åº¦ä»·å€¼']
    }
  ];

  aboutToAppear() {
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¼ å…¥çš„åœºæ™¯å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    if (params && params['scenario']) {
      this.selectedScenario = params['scenario'] as Scenario;
      this.scenarioName = params['scenarioName'] as string || this.getScenarioName(this.selectedScenario);
      this.loadScenarioGifts();
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      this.buildHeader()
      
      // åœºæ™¯è¯¦æƒ…é¡µï¼ˆç¤¼ç‰©åˆ—è¡¨ï¼‰
      this.buildScenarioDetail()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  goBack() {
    router.back();
  }

  @Builder
  buildHeader() {
    Row() {
      Button() {
        Image($r('app.media.icon_back'))
          .width(24)
          .height(24)
          .fillColor('#333333')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        this.goBack()
      })
      
      Text(this.scenarioName || 'ç¤¼ç‰©æ¨è')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      Blank().width(40)
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceBetween)
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Color.White)
  }



  @Builder
  buildScenarioDetail() {
    Column() {
      // åœºæ™¯ä»‹ç»å¡ç‰‡
      this.buildScenarioIntro()
      
      // æ¨èç¤¼ç‰©åˆ—è¡¨
      this.buildGiftList()
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildScenarioIntro() {
    Column() {
      if (this.selectedScenario) {
        Row() {
          Text(this.getScenarioIcon())
            .fontSize(32)
            .margin({ right: 16 })
          
          Column() {
            Text(this.getScenarioName(this.selectedScenario))
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
            
            Text(this.getScenarioDescription())
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 4 })
              .alignSelf(ItemAlign.Start)
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
        
        // é€‰ç¤¼è´´å£«
        Column() {
          Text('é€‰ç¤¼è´´å£«')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 8 })
          
          ForEach(this.getScenarioTips(), (tip: string, index: number) => {
            Row() {
              Text(`${index + 1}.`)
                .fontSize(12)
                .fontColor(this.getScenarioColor())
                .width(20)
              
              Text(tip)
                .fontSize(12)
                .fontColor('#666666')
                .layoutWeight(1)
            }
            .width('100%')
            .margin({ bottom: 4 })
          })
        }
        .width('100%')
        .margin({ top: 16 })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 8, bottom: 16 })
  }

  @Builder
  buildGiftList() {
    Column() {
      Row() {
        Text('æ¨èç¤¼ç‰©')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
        
        Blank()
        
        Text(`å…±${this.scenarioGifts.length}ä»¶`)
          .fontSize(14)
          .fontColor('#666666')
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 12 })
      
      if (this.loading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#4CAF50')
          
          Text('æ­£åœ¨åŠ è½½æ¨èç¤¼ç‰©...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 16 })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        List() {
          ForEach(this.scenarioGifts, (gift: Gift) => {
            ListItem() {
              this.buildGiftCard(gift)
            }
            .margin({ bottom: 12 })
          })
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, bottom: 16 })
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildGiftCard(gift: Gift) {
    Row() {
      // ç¤¼ç‰©å›¾ç‰‡å ä½
      Column() {
        Image(gift.imageUrl)
      }
      .width(80)
      .height(80)
      .borderRadius(8)
      .justifyContent(FlexAlign.Center)
      
      // ç¤¼ç‰©ä¿¡æ¯
      Column() {
        Text(gift.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Text(gift.description)
          .fontSize(12)
          .fontColor('#666666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 4 })
        
        Row() {
          Row() {
            Text('â­')
              .fontSize(12)
            Text(`${gift.rating}`)
              .fontSize(12)
              .fontColor('#666666')
            Text(`(${gift.reviewCount})`)
              .fontSize(10)
              .fontColor('#999999')
          }
        }
        .width('100%')
        .margin({ top: 8 })
        
        // é€‚ç”¨åœºæ™¯æ ‡ç­¾
        if (gift.meaning) {
          Text(`ğŸ’ ${gift.meaning}`)
            .fontSize(10)
            .fontColor('#4CAF50')
            .backgroundColor('#E8F5E8')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(8)
            .margin({ top: 4 })
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
      }
      .layoutWeight(1)
      .margin({ left: 12 })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(() => {
      // ç‚¹å‡»æŸ¥çœ‹ç¤¼ç‰©è¯¦æƒ…
      console.log('æŸ¥çœ‹ç¤¼ç‰©è¯¦æƒ…:', gift.name);
    })
  }

  private loadScenarioGifts() {
    if (!this.selectedScenario) return;
    
    this.loading = true;
    
    // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½
    setTimeout(() => {
      const response = this.giftService.getRecommendations({
        scenario: this.selectedScenario
      });
      this.scenarioGifts = response.gifts;
      this.loading = false;
    }, 500);
  }

  private getScenarioName(scenario: Scenario): string {
    const found = this.scenarios.find(s => s.key === scenario);
    return found ? found.name : 'æœªçŸ¥åœºæ™¯';
  }

  private getCurrentScenario(): ScenarioInfo | undefined {
    return this.scenarios.find(s => s.key === this.selectedScenario);
  }

  private getScenarioIcon(): string {
    const scenario = this.getCurrentScenario();
    return scenario ? scenario.icon : 'ğŸ';
  }

  private getScenarioDescription(): string {
    const scenario = this.getCurrentScenario();
    return scenario ? scenario.description : '';
  }

  private getScenarioColor(): string {
    const scenario = this.getCurrentScenario();
    return scenario ? scenario.color : '#4CAF50';
  }

  private getScenarioTips(): string[] {
    const scenario = this.getCurrentScenario();
    return scenario ? scenario.tips : [];
  }
}