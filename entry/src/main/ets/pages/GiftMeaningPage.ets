import { Gift, GiftCategory, Scenario } from '../model/GiftModel';
import { GiftRecommendationService } from '../service/GiftRecommendationService';
import router from '@ohos.router';

// ç¤¼ç‰©å«ä¹‰ä¿¡æ¯æ¥å£
interface GiftMeaning {
  id: string;
  name: string;
  category: GiftCategory;
  symbolism: string; // è±¡å¾æ„ä¹‰
  culturalBackground: string; // æ–‡åŒ–èƒŒæ™¯
  occasions: Scenario[]; // é€‚ç”¨åœºåˆ
  tips: string[]; // é€ç¤¼å°è´´å£«
  taboos: string[]; // é€ç¤¼ç¦å¿Œ
  image: string;
  color: string;
}

@Entry
@Component
struct GiftMeaningPage {
  @State selectedCategory: GiftCategory | null = null;
  @State giftMeanings: GiftMeaning[] = [];
  @State searchText: string = '';
  @State loading: boolean = false;
  private scroller: Scroller = new Scroller();
  private giftService: GiftRecommendationService = GiftRecommendationService.getInstance();

  aboutToAppear() {
    this.loadGiftMeanings();
  }

  build() {
    Column() {
      this.buildHeader()
      this.buildSearchBar()
      this.buildCategoryFilter()
      this.buildMeaningList()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }

  @Builder
  buildHeader() {
    Row() {
      Text('â†')
        .fontSize(24)
        .fontColor('#333333')
        .onClick(() => {
          router.back();
        })

      Text('ç¤¼ç‰©å«ä¹‰è§£è¯»')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Row()
        .width(24)
        .height(24)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildSearchBar() {
    Row() {
      Text('ğŸ”')
        .fontSize(20)
        .margin({ right: 8 })

      TextInput({ placeholder: 'æœç´¢ç¤¼ç‰©åç§°æˆ–å«ä¹‰' })
        .layoutWeight(1)
        .backgroundColor(Color.Transparent)
        .border({ width: 0 })
        .onChange((value: string) => {
          this.searchText = value;
          this.filterGiftMeanings();
        })
    }
    .width('100%')
    .height(44)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .borderRadius(22)
    .margin({ left: 16, right: 16, top: 16, bottom: 16 })
  }

  @Builder
  buildCategoryFilter() {
    Scroll(this.scroller) {
      Row() {
        this.buildCategoryChip('å…¨éƒ¨', null)
        this.buildCategoryChip('é²œèŠ±', GiftCategory.FLOWERS)
        this.buildCategoryChip('ç å®', GiftCategory.JEWELRY)
        this.buildCategoryChip('æ•°ç ', GiftCategory.ELECTRONICS)
        this.buildCategoryChip('æœé¥°', GiftCategory.CLOTHING)
        this.buildCategoryChip('ç¾å¦†', GiftCategory.COSMETICS)
        this.buildCategoryChip('ä¹¦ç±', GiftCategory.BOOKS)
        this.buildCategoryChip('è¿åŠ¨', GiftCategory.SPORTS)
        this.buildCategoryChip('å®¶å±…', GiftCategory.HOME)
        this.buildCategoryChip('ç¾é£Ÿ', GiftCategory.FOOD)
        this.buildCategoryChip('å…¶ä»–', GiftCategory.TOYS)
      }
      .padding({ left: 16, right: 16 })
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off)
    .width('100%')
    .margin({ bottom: 16 })
  }

  @Builder
  buildCategoryChip(label: string, category: GiftCategory | null) {
    Text(label)
      .fontSize(14)
      .fontColor(this.selectedCategory === category ? Color.White : '#666666')
      .backgroundColor(this.selectedCategory === category ? '#4CAF50' : '#F0F0F0')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .borderRadius(16)
      .margin({ right: 12 })
      .onClick(() => {
        this.selectedCategory = category;
        this.filterGiftMeanings();
      })
  }

  @Builder
  buildMeaningList() {
    if (this.loading) {
      Column() {
        LoadingProgress()
          .width(40)
          .height(40)
          .color('#4CAF50')
        
        Text('åŠ è½½ä¸­...')
          .fontSize(14)
          .fontColor('#999999')
          .margin({ top: 16 })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    } else {
      List() {
        ForEach(this.getFilteredMeanings(), (meaning: GiftMeaning) => {
          ListItem() {
            this.buildMeaningCard(meaning)
          }
          .margin({ bottom: 16 })
        })
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16 })
    }
  }

  @Builder
  buildMeaningCard(meaning: GiftMeaning) {
    Column() {
      // ç¤¼ç‰©åŸºæœ¬ä¿¡æ¯
      Row() {
        Column() {
          Text('ğŸ')
            .fontSize(32)
        }
        .width(60)
        .height(60)
        .backgroundColor(meaning.color)
        .borderRadius(30)
        .justifyContent(FlexAlign.Center)
        .margin({ right: 16 })

        Column() {
          Text(meaning.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 4 })

          Text(this.getCategoryText(meaning.category))
            .fontSize(12)
            .fontColor('#999999')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .backgroundColor('#F0F0F0')
            .borderRadius(4)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 16 })

      // è±¡å¾æ„ä¹‰
      Column() {
        Row() {
          Text('ğŸ’«')
            .fontSize(16)
            .margin({ right: 8 })
          
          Text('è±¡å¾æ„ä¹‰')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
        }
        .margin({ bottom: 8 })

        Text(meaning.symbolism)
          .fontSize(14)
          .fontColor('#666666')
          .lineHeight(20)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      .margin({ bottom: 16 })

      // æ–‡åŒ–èƒŒæ™¯
      Column() {
        Row() {
          Text('ğŸ“š')
            .fontSize(16)
            .margin({ right: 8 })
          
          Text('æ–‡åŒ–èƒŒæ™¯')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
        }
        .margin({ bottom: 8 })

        Text(meaning.culturalBackground)
          .fontSize(14)
          .fontColor('#666666')
          .lineHeight(20)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      .margin({ bottom: 16 })

      // é€‚ç”¨åœºåˆ
      Column() {
        Row() {
          Text('ğŸ¯')
            .fontSize(16)
            .margin({ right: 8 })
          
          Text('é€‚ç”¨åœºåˆ')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
        }
        .margin({ bottom: 8 })

        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(meaning.occasions, (occasion: Scenario) => {
            Text(this.getScenarioText(occasion))
              .fontSize(12)
              .fontColor('#4CAF50')
              .backgroundColor('#E8F5E8')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
              .margin({ right: 8, bottom: 8 })
          })
        }
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      .margin({ bottom: 16 })

      // é€ç¤¼å°è´´å£«
      if (meaning.tips.length > 0) {
        Column() {
          Row() {
            Text('ğŸ’¡')
              .fontSize(16)
              .margin({ right: 8 })
            
            Text('é€ç¤¼å°è´´å£«')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
          }
          .margin({ bottom: 8 })

          ForEach(meaning.tips, (tip: string) => {
            Row() {
              Text('â€¢')
                .fontSize(14)
                .fontColor('#4CAF50')
                .margin({ right: 8 })
              
              Text(tip)
                .fontSize(14)
                .fontColor('#666666')
                .layoutWeight(1)
            }
            .width('100%')
            .margin({ bottom: 4 })
          })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
        .margin({ bottom: 16 })
      }

      // é€ç¤¼ç¦å¿Œ
      if (meaning.taboos.length > 0) {
        Column() {
          Row() {
            Text('âš ï¸')
              .fontSize(16)
              .margin({ right: 8 })
            
            Text('é€ç¤¼ç¦å¿Œ')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#FF5722')
          }
          .margin({ bottom: 8 })

          ForEach(meaning.taboos, (taboo: string) => {
            Row() {
              Text('â€¢')
                .fontSize(14)
                .fontColor('#FF5722')
                .margin({ right: 8 })
              
              Text(taboo)
                .fontSize(14)
                .fontColor('#666666')
                .layoutWeight(1)
            }
            .width('100%')
            .margin({ bottom: 4 })
          })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(() => {
      // å¯ä»¥è·³è½¬åˆ°ç¤¼ç‰©è¯¦æƒ…é¡µ
    })
  }

  private loadGiftMeanings() {
    this.loading = true;
    
    // æ¨¡æ‹ŸåŠ è½½ç¤¼ç‰©å«ä¹‰æ•°æ®
    setTimeout(() => {
      this.giftMeanings = [
        {
          id: '1',
          name: 'ç«ç‘°èŠ±',
          category: GiftCategory.FLOWERS,
          symbolism: 'ç«ç‘°èŠ±è±¡å¾ç€çˆ±æƒ…ã€ç¾ä¸½å’Œæ¿€æƒ…ã€‚çº¢ç«ç‘°ä»£è¡¨çƒ­çƒˆçš„çˆ±æƒ…ï¼Œç²‰ç«ç‘°ä»£è¡¨åˆæ‹å’Œæ„Ÿæ¿€ï¼Œç™½ç«ç‘°ä»£è¡¨çº¯æ´çš„çˆ±æƒ…ã€‚',
          culturalBackground: 'ç«ç‘°åœ¨å¤å¸Œè…Šç¥è¯ä¸­æ˜¯çˆ±ç¥é˜¿èŠ™ç½—ç‹„è’‚çš„è±¡å¾ï¼Œåœ¨ä¸­ä¸–çºªæ¬§æ´²ï¼Œç«ç‘°æˆä¸ºäº†çˆ±æƒ…å’Œç¾ä¸½çš„ä»£åè¯ã€‚åœ¨ä¸­å›½æ–‡åŒ–ä¸­ï¼Œç«ç‘°ä¹Ÿè¢«èµ‹äºˆäº†æµªæ¼«å’Œçˆ±æƒ…çš„å«ä¹‰ã€‚',
          occasions: [Scenario.VALENTINE, Scenario.ANNIVERSARY, Scenario.WEDDING],
          tips: ['é€‰æ‹©æ–°é²œçš„ç«ç‘°èŠ±', 'ä¸åŒé¢œè‰²ä»£è¡¨ä¸åŒå«ä¹‰', 'æ­é…ç²¾ç¾åŒ…è£…æ›´æ˜¾å¿ƒæ„'],
          taboos: ['é¿å…é€é»„ç«ç‘°ç»™æ‹äººï¼ˆä»£è¡¨å‹è°Šï¼‰', 'ä¸è¦é€æ¯èçš„èŠ±æœµ'],
          image: '',
          color: '#FFE4E1'
        },
        {
          id: '2',
          name: 'é’»çŸ³æˆ’æŒ‡',
          category: GiftCategory.JEWELRY,
          symbolism: 'é’»çŸ³è±¡å¾ç€æ°¸æ’ã€åšè´å’Œçº¯æ´ã€‚æˆ’æŒ‡ä»£è¡¨ç€æ‰¿è¯ºå’Œçº¦å®šï¼Œé’»çŸ³æˆ’æŒ‡å¯“æ„ç€æ°¸æ’çš„çˆ±æƒ…å’Œä¸å˜çš„æ‰¿è¯ºã€‚',
          culturalBackground: 'é’»çŸ³è¢«èª‰ä¸º"å®çŸ³ä¹‹ç‹"ï¼Œåœ¨å¤ä»£è¢«è®¤ä¸ºå…·æœ‰ç¥ç§˜çš„åŠ›é‡ã€‚ç°ä»£ç¤¾ä¼šä¸­ï¼Œé’»çŸ³æˆ’æŒ‡æˆä¸ºäº†æ±‚å©šå’Œç»“å©šçš„ç»å…¸é€‰æ‹©ã€‚',
          occasions: [Scenario.WEDDING, Scenario.ANNIVERSARY, Scenario.VALENTINE],
          tips: ['é€‰æ‹©æœ‰è¯ä¹¦çš„é’»çŸ³', 'è€ƒè™‘4Cæ ‡å‡†ï¼ˆåˆ‡å·¥ã€é¢œè‰²ã€å‡€åº¦ã€å…‹æ‹‰ï¼‰', 'é€‰æ‹©åˆé€‚çš„æˆ’æŒ‡å°ºå¯¸'],
          taboos: ['ä¸è¦é€‰æ‹©æœ‰ç‘•ç–µçš„é’»çŸ³', 'é¿å…åœ¨ä¸åˆé€‚çš„åœºåˆèµ é€'],
          image: '',
          color: '#E6F3FF'
        },
        {
          id: '3',
          name: 'å·§å…‹åŠ›',
          category: GiftCategory.FOOD,
          symbolism: 'å·§å…‹åŠ›è±¡å¾ç€ç”œèœœã€æ¸©æš–å’Œå…³çˆ±ã€‚å®ƒèƒ½å¤Ÿåˆºæ¿€å¤§è„‘åˆ†æ³Œå†…å•¡è‚½ï¼Œå¸¦æ¥æ„‰æ‚¦æ„Ÿï¼Œå› æ­¤è¢«è§†ä¸ºçˆ±æƒ…çš„è±¡å¾ã€‚',
          culturalBackground: 'å·§å…‹åŠ›èµ·æºäºå¤ä»£ç›é›…å’Œé˜¿å…¹ç‰¹å…‹æ–‡æ˜ï¼Œè¢«ç§°ä¸º"ç¥çš„é£Ÿç‰©"ã€‚åœ¨æ¬§æ´²ï¼Œå·§å…‹åŠ›æˆä¸ºäº†è´µæ—çš„å¥¢ä¾ˆå“ï¼Œåæ¥é€æ¸æ™®åŠå¹¶æˆä¸ºè¡¨è¾¾çˆ±æ„çš„ç¤¼ç‰©ã€‚',
          occasions: [Scenario.VALENTINE, Scenario.BIRTHDAY, Scenario.THANK_YOU],
          tips: ['é€‰æ‹©é«˜å“è´¨çš„å·§å…‹åŠ›', 'è€ƒè™‘å¯¹æ–¹çš„å£å‘³åå¥½', 'æ³¨æ„ä¿å­˜æ¸©åº¦'],
          taboos: ['æ³¨æ„å¯¹æ–¹æ˜¯å¦æœ‰ç³–å°¿ç—…æˆ–è¿‡æ•', 'é¿å…åœ¨ç‚çƒ­å¤©æ°”é•¿æ—¶é—´æºå¸¦'],
          image: '',
          color: '#F4E4BC'
        }
      ];
      this.loading = false;
    }, 1000);
  }

  private filterGiftMeanings() {
    // æ ¹æ®æœç´¢æ–‡æœ¬å’Œåˆ†ç±»ç­›é€‰
    // è¿™é‡Œå¯ä»¥å®ç°å…·ä½“çš„ç­›é€‰é€»è¾‘
  }

  private getFilteredMeanings(): GiftMeaning[] {
    let filtered = this.giftMeanings;
    
    // æŒ‰åˆ†ç±»ç­›é€‰
    if (this.selectedCategory !== null) {
      filtered = filtered.filter(meaning => meaning.category === this.selectedCategory);
    }
    
    // æŒ‰æœç´¢æ–‡æœ¬ç­›é€‰
    if (this.searchText.trim() !== '') {
      filtered = filtered.filter(meaning => 
        meaning.name.includes(this.searchText) || 
        meaning.symbolism.includes(this.searchText)
      );
    }
    
    return filtered;
  }

  private getCategoryText(category: GiftCategory): string {
    switch (category) {
      case GiftCategory.FLOWERS:
        return 'é²œèŠ±';
      case GiftCategory.JEWELRY:
        return 'ç å®';
      case GiftCategory.ELECTRONICS:
        return 'æ•°ç ';
      case GiftCategory.CLOTHING:
        return 'æœé¥°';
      case GiftCategory.COSMETICS:
        return 'ç¾å¦†';
      case GiftCategory.BOOKS:
        return 'ä¹¦ç±';
      case GiftCategory.SPORTS:
        return 'è¿åŠ¨';
      case GiftCategory.HOME:
        return 'å®¶å±…';
      case GiftCategory.FOOD:
        return 'ç¾é£Ÿ';
      case GiftCategory.TOYS:
        return 'å…¶ä»–';
      default:
        return 'æœªçŸ¥';
    }
  }

  private getScenarioText(scenario: Scenario): string {
    switch (scenario) {
      case Scenario.BIRTHDAY:
        return 'ç”Ÿæ—¥';
      case Scenario.ANNIVERSARY:
        return 'çºªå¿µæ—¥';
      case Scenario.VALENTINE:
        return 'æƒ…äººèŠ‚';
      case Scenario.CHRISTMAS:
        return 'åœ£è¯èŠ‚';
      case Scenario.CHRISTMAS:
        return 'èŠ‚æ—¥';
      case Scenario.GRADUATION:
        return 'æ¯•ä¸š';
      case Scenario.WEDDING:
        return 'å©šç¤¼';
      case Scenario.WEDDING:
        return 'å©šç¤¼';
      case Scenario.APOLOGY:
        return 'é“æ­‰';
      case Scenario.THANK_YOU:
        return 'æ„Ÿè°¢';
      case Scenario.GET_WELL:
        return 'åº·å¤';
      case Scenario.GRADUATION:
        return 'åº†ç¥';
      default:
        return 'å…¶ä»–';
    }
  }
}