import { Gift, Scenario, GiftCategory, PriceRange, Gender, AgeRange, Relationship, Interest, GiftRecommendationRequest } from '../model/GiftModel';
import { GiftRecommendationService } from '../service/GiftRecommendationService';
import router from '@ohos.router';

// äººç¾¤åˆ†æžæŽ¥å£
interface TargetProfile {
  gender?: Gender;
  ageRange?: AgeRange;
  relationship?: Relationship;
  interests: string[];
  budget?: number;
}

// å…´è¶£æ ‡ç­¾æŽ¥å£
interface InterestTag {
  id: string;
  name: string;
  icon: string;
  color: string;
}

@Entry
@Component
struct TargetAnalysisPage {
  @State private targetProfile: TargetProfile = {
    interests: []
  };
  @State private recommendedGifts: Gift[] = [];
  @State private currentStep: number = 1;
  @State private loading: boolean = false;
  @State private showResults: boolean = false;
  
  private giftService = GiftRecommendationService.getInstance();
  
  // å…´è¶£æ ‡ç­¾æ•°æ®
  private interestTags: InterestTag[] = [
    { id: 'sports', name: 'è¿åŠ¨å¥èº«', icon: 'ðŸƒ', color: '#FF6B6B' },
    { id: 'reading', name: 'é˜…è¯»å­¦ä¹ ', icon: 'ðŸ“š', color: '#4ECDC4' },
    { id: 'music', name: 'éŸ³ä¹è‰ºæœ¯', icon: 'ðŸŽµ', color: '#45B7D1' },
    { id: 'cooking', name: 'çƒ¹é¥ªç¾Žé£Ÿ', icon: 'ðŸ‘¨â€ðŸ³', color: '#FFA07A' },
    { id: 'travel', name: 'æ—…è¡ŒæŽ¢ç´¢', icon: 'âœˆï¸', color: '#98D8C8' },
    { id: 'gaming', name: 'æ¸¸æˆå¨±ä¹', icon: 'ðŸŽ®', color: '#F7DC6F' },
    { id: 'fashion', name: 'æ—¶å°šç¾Žå¦†', icon: 'ðŸ’„', color: '#BB8FCE' },
    { id: 'tech', name: 'ç§‘æŠ€æ•°ç ', icon: 'ðŸ“±', color: '#85C1E9' },
    { id: 'pets', name: 'å® ç‰©å…»æŠ¤', icon: 'ðŸ•', color: '#F8C471' },
    { id: 'gardening', name: 'å›­è‰ºæ¤ç‰©', icon: 'ðŸŒ±', color: '#82E0AA' },
    { id: 'photography', name: 'æ‘„å½±æ‹ç…§', icon: 'ðŸ“·', color: '#D7BDE2' },
    { id: 'handcraft', name: 'æ‰‹å·¥åˆ¶ä½œ', icon: 'ðŸŽ¨', color: '#F9E79F' }
  ];

  build() {
    Column() {
      // æ ‡é¢˜æ 
      this.buildHeader()
      
      if (this.showResults) {
        // æŽ¨èç»“æžœé¡µ
        this.buildResultsPage()
      } else {
        // åˆ†æžæ­¥éª¤é¡µ
        this.buildAnalysisSteps()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  buildHeader() {
    Row() {
      Button('â† è¿”å›ž')
        .fontSize(16)
        .backgroundColor(Color.Transparent)
        .fontColor('#333333')
        .onClick(() => {
          router.back();
        })
      
      Text(this.showResults ? 'æŽ¨èç»“æžœ' : 'äººç¾¤åˆ†æž')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      if (!this.showResults) {
        Text(`${this.currentStep}/4`)
          .fontSize(14)
          .fontColor('#666666')
          .backgroundColor('#E0E0E0')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(10)
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Color.White)
  }

  @Builder
  buildAnalysisSteps() {
    Column() {
      // è¿›åº¦æ¡
      this.buildProgressBar()
      
      // æ­¥éª¤å†…å®¹
      if (this.currentStep === 1) {
        this.buildGenderStep()
      } else if (this.currentStep === 2) {
        this.buildAgeStep()
      } else if (this.currentStep === 3) {
        this.buildRelationshipStep()
      } else if (this.currentStep === 4) {
        this.buildInterestsStep()
      }
      
      // åº•éƒ¨æŒ‰é’®
      this.buildBottomButtons()
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildProgressBar() {
    Column() {
      Row() {
        ForEach([1, 2, 3, 4], (step: number) => {
          Circle({ width: 24, height: 24 })
            .fill(step <= this.currentStep ? '#4CAF50' : '#E0E0E0')
            .margin({ right: step < 4 ? 8 : 0 })
          
          if (step < 4) {
            Line()
              .width(40)
              .height(2)
              .backgroundColor(step < this.currentStep ? '#4CAF50' : '#E0E0E0')
              .margin({ right: 8 })
          }
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      
      Row() {
        Text('æ€§åˆ«')
          .fontSize(12)
          .fontColor(this.currentStep >= 1 ? '#4CAF50' : '#999999')
          .width(60)
          .textAlign(TextAlign.Center)
        
        Text('å¹´é¾„')
          .fontSize(12)
          .fontColor(this.currentStep >= 2 ? '#4CAF50' : '#999999')
          .width(60)
          .textAlign(TextAlign.Center)
        
        Text('å…³ç³»')
          .fontSize(12)
          .fontColor(this.currentStep >= 3 ? '#4CAF50' : '#999999')
          .width(60)
          .textAlign(TextAlign.Center)
        
        Text('å…´è¶£')
          .fontSize(12)
          .fontColor(this.currentStep >= 4 ? '#4CAF50' : '#999999')
          .width(60)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)
      .margin({ top: 8 })
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .margin({ bottom: 16 })
  }

  @Builder
  buildGenderStep() {
    Column() {
      Text('è¯·é€‰æ‹©TAçš„æ€§åˆ«')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 8 })
      
      Text('è¿™å°†å¸®åŠ©æˆ‘ä»¬æŽ¨èæ›´åˆé€‚çš„ç¤¼ç‰©')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ bottom: 32 })
      
      Row() {
        this.buildGenderOption('ðŸ‘¨', 'ç”·æ€§', Gender.MALE)
        this.buildGenderOption('ðŸ‘©', 'å¥³æ€§', Gender.FEMALE)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16 })
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildGenderOption(icon: string, label: string, gender: Gender) {
    Column() {
      Text(icon)
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text(label)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.targetProfile.gender === gender ? Color.White : '#333333')
    }
    .width(120)
    .height(140)
    .backgroundColor(this.targetProfile.gender === gender ? '#4CAF50' : '#F5F5F5')
    .borderRadius(16)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.targetProfile.gender = gender;
    })
  }

  @Builder
  buildAgeStep() {
    Column() {
      Text('è¯·é€‰æ‹©TAçš„å¹´é¾„æ®µ')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 8 })
      
      Text('ä¸åŒå¹´é¾„æ®µçš„äººæœ‰ä¸åŒçš„å–œå¥½')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ bottom: 32 })
      
      Grid() {
        GridItem() {
          this.buildAgeOption('ðŸ‘¶', 'å„¿ç«¥\n(0-12å²)', AgeRange.CHILD)
        }
        GridItem() {
          this.buildAgeOption('ðŸ§’', 'é’å°‘å¹´\n(13-17å²)', AgeRange.TEEN)
        }
        GridItem() {
          this.buildAgeOption('ðŸ‘¨', 'é’å¹´\n(18-30å²)', AgeRange.YOUNG_ADULT)
        }
        GridItem() {
          this.buildAgeOption('ðŸ‘¨â€ðŸ’¼', 'æˆå¹´\n(31-50å²)', AgeRange.ADULT)
        }
        GridItem() {
          this.buildAgeOption('ðŸ‘´', 'è€å¹´\n(50å²ä»¥ä¸Š)', AgeRange.SENIOR)
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsGap(16)
      .columnsGap(16)
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16 })
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildAgeOption(icon: string, label: string, ageRange: AgeRange) {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 12 })
      
      Text(label)
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.targetProfile.ageRange === ageRange ? Color.White : '#333333')
        .textAlign(TextAlign.Center)
        .lineHeight(18)
    }
    .width('100%')
    .height(100)
    .backgroundColor(this.targetProfile.ageRange === ageRange ? '#4CAF50' : '#F5F5F5')
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.targetProfile.ageRange = ageRange;
    })
  }

  @Builder
  buildRelationshipStep() {
    Column() {
      Text('ä½ ä»¬çš„å…³ç³»æ˜¯ï¼Ÿ')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 8 })
      
      Text('å…³ç³»ä¸åŒï¼Œç¤¼ç‰©çš„é€‰æ‹©ä¹Ÿä¼šä¸åŒ')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ bottom: 32 })
      
      Grid() {
        GridItem() {
          this.buildRelationshipOption('ðŸ’•', 'æ‹äºº', Relationship.ROMANTIC)
        }
        GridItem() {
          this.buildRelationshipOption('ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦', 'å®¶äºº', Relationship.FAMILY)
        }
        GridItem() {
          this.buildRelationshipOption('ðŸ‘«', 'æœ‹å‹', Relationship.FRIEND)
        }
        GridItem() {
          this.buildRelationshipOption('ðŸ‘”', 'åŒäº‹', Relationship.COLLEAGUE)
        }
        GridItem() {
          this.buildRelationshipOption('ðŸ‘¨â€ðŸ«', 'è€å¸ˆ', Relationship.TEACHER)
        }
        GridItem() {
          this.buildRelationshipOption('ðŸ¤', 'ç†Ÿäºº', Relationship.ACQUAINTANCE)
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsGap(16)
      .columnsGap(16)
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16 })
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildRelationshipOption(icon: string, label: string, relationship: Relationship) {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 12 })
      
      Text(label)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.targetProfile.relationship === relationship ? Color.White : '#333333')
    }
    .width('100%')
    .height(80)
    .backgroundColor(this.targetProfile.relationship === relationship ? '#4CAF50' : '#F5F5F5')
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.targetProfile.relationship = relationship;
    })
  }

  @Builder
  buildInterestsStep() {
    Column() {
      Text('TAçš„å…´è¶£çˆ±å¥½æ˜¯ï¼Ÿ')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 8 })
      
      Text('å¯ä»¥é€‰æ‹©å¤šä¸ªï¼Œè¿™æ ·æŽ¨èä¼šæ›´ç²¾å‡†')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ bottom: 24 })
      
      Grid() {
        ForEach(this.interestTags, (tag: InterestTag) => {
          GridItem() {
            this.buildInterestTag(tag)
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr')
      .rowsGap(12)
      .columnsGap(12)
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16 })
    .layoutWeight(1)
    .justifyContent(FlexAlign.Start)
  }

  @Builder
  buildInterestTag(tag: InterestTag) {
    Column() {
      Text(tag.icon)
        .fontSize(24)
        .margin({ bottom: 8 })
      
      Text(tag.name)
        .fontSize(12)
        .fontColor(this.targetProfile.interests.includes(tag.id) ? Color.White : '#333333')
        .textAlign(TextAlign.Center)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .height(70)
    .backgroundColor(this.targetProfile.interests.includes(tag.id) ? tag.color : '#F5F5F5')
    .borderRadius(8)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      if (this.targetProfile.interests.includes(tag.id)) {
        const index = this.targetProfile.interests.indexOf(tag.id);
        if (index > -1) {
          this.targetProfile.interests.splice(index, 1);
        }
      } else {
        this.targetProfile.interests.push(tag.id);
      }
    })
  }

  @Builder
  buildBottomButtons() {
    Row() {
      if (this.currentStep > 1) {
        Button('ä¸Šä¸€æ­¥')
          .fontSize(16)
          .backgroundColor('#E0E0E0')
          .fontColor('#333333')
          .borderRadius(25)
          .width(100)
          .height(50)
          .onClick(() => {
            this.currentStep--;
          })
      }
      
      Blank()
      
      Button(this.currentStep === 4 ? 'å¼€å§‹åˆ†æž' : 'ä¸‹ä¸€æ­¥')
        .fontSize(16)
        .backgroundColor(this.canProceed() ? '#4CAF50' : '#CCCCCC')
        .fontColor(Color.White)
        .borderRadius(25)
        .width(this.currentStep === 4 ? 120 : 100)
        .height(50)
        .enabled(this.canProceed())
        .onClick(() => {
          if (this.currentStep === 4) {
            this.startAnalysis();
          } else {
            this.currentStep++;
          }
        })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16, bottom: 20 })
    .backgroundColor(Color.White)
  }

  @Builder
  buildResultsPage() {
    Column() {
      // åˆ†æžç»“æžœæ‘˜è¦
      this.buildAnalysisSummary()
      
      // æŽ¨èç¤¼ç‰©åˆ—è¡¨
      this.buildRecommendedGifts()
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildAnalysisSummary() {
    Column() {
      Text('åˆ†æžç»“æžœ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 16 })
      
      Row() {
        Column() {
          Text('æ€§åˆ«')
            .fontSize(12)
            .fontColor('#666666')
          Text(this.getGenderText())
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        
        Column() {
          Text('å¹´é¾„')
            .fontSize(12)
            .fontColor('#666666')
          Text(this.getAgeText())
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        
        Column() {
          Text('å…³ç³»')
            .fontSize(12)
            .fontColor('#666666')
          Text(this.getRelationshipText())
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
      }
      .width('100%')
      
      if (this.targetProfile.interests.length > 0) {
        Column() {
          Text('å…´è¶£çˆ±å¥½')
            .fontSize(12)
            .fontColor('#666666')
            .alignSelf(ItemAlign.Start)
            .margin({ top: 16, bottom: 8 })
          
          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.getSelectedInterests(), (interest: InterestTag) => {
              Text(interest.name)
                .fontSize(12)
                .fontColor(Color.White)
                .backgroundColor(interest.color)
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(12)
                .margin({ right: 8, bottom: 8 })
            })
          }
          .width('100%')
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 8, bottom: 16 })
  }

  @Builder
  buildRecommendedGifts() {
    Column() {
      Row() {
        Text('æŽ¨èç¤¼ç‰©')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
        
        Blank()
        
        Text(`å…±${this.recommendedGifts.length}ä»¶`)
          .fontSize(14)
          .fontColor('#666666')
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 12 })
      
      if (this.loading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#4CAF50')
          
          Text('æ­£åœ¨åˆ†æžæŽ¨è...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 16 })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        List() {
          ForEach(this.recommendedGifts, (gift: Gift) => {
            ListItem() {
              this.buildGiftCard(gift)
            }
            .margin({ bottom: 12 })
          })
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, bottom: 16 })
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildGiftCard(gift: Gift) {
    Row() {
      // ç¤¼ç‰©å›¾ç‰‡å ä½
      Column() {
        Text('ðŸŽ')
          .fontSize(32)
      }
      .width(80)
      .height(80)
      .backgroundColor('#F0F0F0')
      .borderRadius(8)
      .justifyContent(FlexAlign.Center)
      
      // ç¤¼ç‰©ä¿¡æ¯
      Column() {
        Text(gift.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Text(gift.description)
          .fontSize(12)
          .fontColor('#666666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 4 })
        
        Row() {
          Text(`Â¥${gift.price}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B6B')
          
          Blank()
          
          Row() {
            Text('â­')
              .fontSize(12)
            Text(`${gift.rating}`)
              .fontSize(12)
              .fontColor('#666666')
            Text(`(${gift.reviewCount})`)
              .fontSize(10)
              .fontColor('#999999')
          }
        }
        .width('100%')
        .margin({ top: 8 })
        
        // æŽ¨èç†ç”±
        if (gift.meaning) {
          Text(`ðŸ’¡ ${gift.meaning}`)
            .fontSize(10)
            .fontColor('#4CAF50')
            .backgroundColor('#E8F5E8')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(8)
            .margin({ top: 4 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
      }
      .layoutWeight(1)
      .margin({ left: 12 })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(() => {
      // ç‚¹å‡»æŸ¥çœ‹ç¤¼ç‰©è¯¦æƒ…
      console.log('æŸ¥çœ‹ç¤¼ç‰©è¯¦æƒ…:', gift.name);
    })
  }

  private canProceed(): boolean {
    switch (this.currentStep) {
      case 1:
        return this.targetProfile.gender !== undefined;
      case 2:
        return this.targetProfile.ageRange !== undefined;
      case 3:
        return this.targetProfile.relationship !== undefined;
      case 4:
        return this.targetProfile.interests.length > 0;
      default:
        return false;
    }
  }

  private startAnalysis() {
    this.loading = true;
    this.showResults = true;
    
    // æ¨¡æ‹Ÿåˆ†æžè¿‡ç¨‹
    setTimeout(() => {
      const request: GiftRecommendationRequest = {
        targetGroup: {
          gender: this.targetProfile.gender || Gender.UNISEX,
          ageRange: this.targetProfile.ageRange || AgeRange.ADULT,
          relationship: this.targetProfile.relationship || Relationship.FRIEND,
          interests: []
        }
      };
      const response = this.giftService.getRecommendations(request);
      this.recommendedGifts = response.gifts;
      this.loading = false;
    }, 1500);
  }

  private getGenderText(): string {
    switch (this.targetProfile.gender) {
      case Gender.MALE:
        return 'ç”·æ€§';
      case Gender.FEMALE:
        return 'å¥³æ€§';
      default:
        return 'æœªé€‰æ‹©';
    }
  }

  private getAgeText(): string {
    switch (this.targetProfile.ageRange) {
      case AgeRange.CHILD:
        return 'å„¿ç«¥';
      case AgeRange.TEEN:
        return 'é’å°‘å¹´';
      case AgeRange.YOUNG_ADULT:
        return 'é’å¹´';
      case AgeRange.ADULT:
        return 'æˆå¹´';
      case AgeRange.SENIOR:
        return 'è€å¹´';
      default:
        return 'æœªé€‰æ‹©';
    }
  }

  private getRelationshipText(): string {
    switch (this.targetProfile.relationship) {
      case Relationship.ROMANTIC:
        return 'æ‹äºº';
      case Relationship.FAMILY:
        return 'å®¶äºº';
      case Relationship.FRIEND:
        return 'æœ‹å‹';
      case Relationship.COLLEAGUE:
        return 'åŒäº‹';
      case Relationship.TEACHER:
        return 'è€å¸ˆ';
      case Relationship.BOSS:
        return 'è€æ¿';
      case Relationship.ACQUAINTANCE:
        return 'ç†Ÿäºº';
      default:
        return 'æœªé€‰æ‹©';
    }
  }

  private getSelectedInterests(): InterestTag[] {
    return this.interestTags.filter(tag => this.targetProfile.interests.includes(tag.id));
  }
}