import { Gift, GiftRecommendationRequest, Scenario, GiftCategory, PriceRange, Gender, AgeRange, Relationship } from '../model/GiftModel';
import { GiftRecommendationService } from '../service/GiftRecommendationService';

@Entry
@Component
struct GiftRecommendationPage {
  @State private gifts: Gift[] = [];
  @State private loading: boolean = false;
  @State private selectedScenario: Scenario | undefined = undefined;
  @State private selectedCategory: GiftCategory | undefined = undefined;
  @State private selectedPriceRange: PriceRange | undefined = undefined;
  @State private selectedGender: Gender | undefined = undefined;
  @State private selectedAgeRange: AgeRange | undefined = undefined;
  @State private selectedRelationship: Relationship | undefined = undefined;
  @State private searchKeyword: string = '';
  @State private recommendationReason: string = '';
  
  private giftService = GiftRecommendationService.getInstance();

  aboutToAppear() {
    this.loadRecommendations();
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      this.buildHeader()
      
      // ç­›é€‰åŒºåŸŸ
      this.buildFilterSection()
      
      // æ¨èç†ç”±
      if (this.recommendationReason) {
        this.buildRecommendationReason()
      }
      
      // ç¤¼ç‰©åˆ—è¡¨
      this.buildGiftList()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  buildHeader() {
    Row() {
      Text('ç¤¼ç‰©æ¨è')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
      
      Blank()
      
      Button('é‡ç½®ç­›é€‰')
        .fontSize(14)
        .backgroundColor('#FF6B6B')
        .fontColor(Color.White)
        .borderRadius(15)
        .padding({ left: 12, right: 12, top: 6, bottom: 6 })
        .onClick(() => {
          this.resetFilters();
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Color.White)
  }

  @Builder
  buildFilterSection() {
    Column() {
      // æœç´¢æ¡†
      TextInput({ placeholder: 'æœç´¢ç¤¼ç‰©å…³é”®è¯...' })
        .width('100%')
        .height(40)
        .backgroundColor('#F8F8F8')
        .borderRadius(20)
        .padding({ left: 16, right: 16 })
        .onChange((value: string) => {
          this.searchKeyword = value;
        })
        .onSubmit(() => {
          this.loadRecommendations();
        })
      
      // åœºæ™¯é€‰æ‹©
      this.buildScenarioFilter()
      
      // åˆ†ç±»é€‰æ‹©
      this.buildCategoryFilter()
      
      // ä»·æ ¼åŒºé—´
      this.buildPriceRangeFilter()
      
      // ç›®æ ‡äººç¾¤
      this.buildTargetGroupFilter()
      
      // æœç´¢æŒ‰é’®
      Button('å¼€å§‹æ¨è')
        .width('100%')
        .height(44)
        .backgroundColor('#4CAF50')
        .fontColor(Color.White)
        .borderRadius(22)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .margin({ top: 16 })
        .onClick(() => {
          this.loadRecommendations();
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ top: 8 })
  }

  @Builder
  buildScenarioFilter() {
    Column() {
      Text('é€ç¤¼åœºæ™¯')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#666666')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })
      
      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
        ForEach([
          { key: Scenario.BIRTHDAY, label: 'ç”Ÿæ—¥' },
          { key: Scenario.ANNIVERSARY, label: 'çºªå¿µæ—¥' },
          { key: Scenario.VALENTINE, label: 'æƒ…äººèŠ‚' },
          { key: Scenario.CHRISTMAS, label: 'åœ£è¯èŠ‚' },
          { key: Scenario.GRADUATION, label: 'æ¯•ä¸š' },
          { key: Scenario.WEDDING, label: 'å©šç¤¼' },
          { key: Scenario.THANK_YOU, label: 'æ„Ÿè°¢' },
          { key: Scenario.APOLOGY, label: 'é“æ­‰' }
        ], (item: Record<string, Object>) => {
          Button(item.label as string)
            .fontSize(12)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .margin({ right: 8, bottom: 8 })
            .backgroundColor(this.selectedScenario === (item.key as Scenario) ? '#4CAF50' : '#E0E0E0')
            .fontColor(this.selectedScenario === (item.key as Scenario) ? Color.White : '#666666')
            .borderRadius(15)
            .onClick(() => {
              this.selectedScenario = this.selectedScenario === (item.key as Scenario) ? undefined : (item.key as Scenario);
            })
        })
      }
    }
    .width('100%')
    .margin({ top: 16 })
  }

  @Builder
  buildCategoryFilter() {
    Column() {
      Text('ç¤¼ç‰©åˆ†ç±»')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#666666')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })
      
      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
        ForEach([
          { key: GiftCategory.JEWELRY, label: 'ç å®é¦–é¥°' },
          { key: GiftCategory.ELECTRONICS, label: 'æ•°ç ç”µå­' },
          { key: GiftCategory.FLOWERS, label: 'é²œèŠ±ç»¿æ¤' },
          { key: GiftCategory.COSMETICS, label: 'ç¾å¦†æŠ¤è‚¤' },
          { key: GiftCategory.BOOKS, label: 'å›¾ä¹¦æ–‡å…·' },
          { key: GiftCategory.CLOTHING, label: 'æœè£…é…é¥°' },
          { key: GiftCategory.FOOD, label: 'ç¾é£Ÿç‰¹äº§' },
          { key: GiftCategory.TOYS, label: 'ç©å…·æ¸¸æˆ' }
        ], (item: Record<string, Object>) => {
          Button(item.label as string)
            .fontSize(12)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .margin({ right: 8, bottom: 8 })
            .backgroundColor(this.selectedCategory === (item.key as GiftCategory) ? '#2196F3' : '#E0E0E0')
            .fontColor(this.selectedCategory === (item.key as GiftCategory) ? Color.White : '#666666')
            .borderRadius(15)
            .onClick(() => {
              this.selectedCategory = this.selectedCategory === (item.key as GiftCategory) ? undefined : (item.key as GiftCategory);
            })
        })
      }
    }
    .width('100%')
    .margin({ top: 16 })
  }

  @Builder
  buildPriceRangeFilter() {
    Column() {
      Text('ä»·æ ¼åŒºé—´')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#666666')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })
      
      Row() {
        ForEach([
          { key: PriceRange.BUDGET, label: 'ç»æµå‹\n(0-100å…ƒ)' },
          { key: PriceRange.MODERATE, label: 'ä¸­æ¡£å‹\n(100-500å…ƒ)' },
          { key: PriceRange.PREMIUM, label: 'é«˜æ¡£å‹\n(500-1000å…ƒ)' },
          { key: PriceRange.LUXURY, label: 'å¥¢åå‹\n(1000å…ƒ+)' }
        ], (item: Record<string, Object>) => {
          Button(item.label as string)
            .fontSize(11)
            .padding(8)
            .margin({ right: 8 })
            .backgroundColor(this.selectedPriceRange === (item.key as PriceRange) ? '#FF9800' : '#E0E0E0')
            .fontColor(this.selectedPriceRange === (item.key as PriceRange) ? Color.White : '#666666')
            .borderRadius(8)
            .layoutWeight(1)
            .onClick(() => {
              this.selectedPriceRange = this.selectedPriceRange === (item.key as PriceRange) ? undefined : (item.key as PriceRange);
            })
        })
      }
    }
    .width('100%')
    .margin({ top: 16 })
  }

  @Builder
  buildTargetGroupFilter() {
    Column() {
      Text('ç›®æ ‡äººç¾¤')
        .fontSize(14)
        .fontWeight(FontWeight.Medium)
        .fontColor('#666666')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 8 })
      
      // æ€§åˆ«é€‰æ‹©
      Row() {
        Text('æ€§åˆ«ï¼š')
          .fontSize(12)
          .fontColor('#888888')
          .width(50)
        
        ForEach([
          { key: Gender.MALE, label: 'ç”·æ€§' },
          { key: Gender.FEMALE, label: 'å¥³æ€§' },
          { key: Gender.UNISEX, label: 'é€šç”¨' }
        ], (item: Record<string, Object>) => {
          Button(item.label as string)
            .fontSize(11)
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .margin({ right: 6 })
            .backgroundColor(this.selectedGender === (item.key as Gender) ? '#E91E63' : '#F0F0F0')
            .fontColor(this.selectedGender === (item.key as Gender) ? Color.White : '#666666')
            .borderRadius(12)
            .onClick(() => {
              this.selectedGender = this.selectedGender === (item.key as Gender) ? undefined : (item.key as Gender);
            })
        })
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      // å¹´é¾„é€‰æ‹©
      Row() {
        Text('å¹´é¾„ï¼š')
          .fontSize(12)
          .fontColor('#888888')
          .width(50)
        
        ForEach([
          { key: AgeRange.TEEN, label: 'é’å°‘å¹´' },
          { key: AgeRange.YOUNG_ADULT, label: 'é’å¹´' },
          { key: AgeRange.ADULT, label: 'ä¸­å¹´' },
          { key: AgeRange.SENIOR, label: 'é•¿è€…' }
        ], (item: Record<string, Object>) => {
          Button(item.label as string)
            .fontSize(11)
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .margin({ right: 6 })
            .backgroundColor(this.selectedAgeRange === (item.key as AgeRange) ? '#9C27B0' : '#F0F0F0')
            .fontColor(this.selectedAgeRange === (item.key as AgeRange) ? Color.White : '#666666')
            .borderRadius(12)
            .onClick(() => {
              this.selectedAgeRange = this.selectedAgeRange === (item.key as AgeRange) ? undefined : (item.key as AgeRange);
            })
        })
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      // å…³ç³»é€‰æ‹©
      Row() {
        Text('å…³ç³»ï¼š')
          .fontSize(12)
          .fontColor('#888888')
          .width(50)
        
        ForEach([
          { key: Relationship.FAMILY, label: 'å®¶äºº' },
          { key: Relationship.FRIEND, label: 'æœ‹å‹' },
          { key: Relationship.ROMANTIC, label: 'æ‹äºº' },
          { key: Relationship.COLLEAGUE, label: 'åŒäº‹' }
        ], (item: Record<string, Object>) => {
          Button(item.label as string)
            .fontSize(11)
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .margin({ right: 6 })
            .backgroundColor(this.selectedRelationship === (item.key as Relationship) ? '#607D8B' : '#F0F0F0')
            .fontColor(this.selectedRelationship === (item.key as Relationship) ? Color.White : '#666666')
            .borderRadius(12)
            .onClick(() => {
              this.selectedRelationship = this.selectedRelationship === (item.key as Relationship) ? undefined : (item.key as Relationship);
            })
        })
      }
      .width('100%')
    }
    .width('100%')
    .margin({ top: 16 })
  }

  @Builder
  buildRecommendationReason() {
    Row() {
      Text(this.recommendationReason)
        .fontSize(14)
        .fontColor('#4CAF50')
        .fontWeight(FontWeight.Medium)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#E8F5E8')
    .margin({ top: 8 })
  }

  @Builder
  buildGiftList() {
    if (this.loading) {
      Column() {
        LoadingProgress()
          .width(40)
          .height(40)
          .color('#4CAF50')
        
        Text('æ­£åœ¨ä¸ºæ‚¨æ¨èç¤¼ç‰©...')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ top: 16 })
      }
      .width('100%')
      .height(200)
      .justifyContent(FlexAlign.Center)
    } else if (this.gifts.length === 0) {
      Column() {
        Text('ğŸ')
          .fontSize(48)
        
        Text('æš‚æ— æ¨èç»“æœ')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ top: 16 })
        
        Text('è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶')
          .fontSize(14)
          .fontColor('#999999')
          .margin({ top: 8 })
      }
      .width('100%')
      .height(200)
      .justifyContent(FlexAlign.Center)
    } else {
      List() {
        ForEach(this.gifts, (gift: Gift) => {
          ListItem() {
            this.buildGiftCard(gift)
          }
          .margin({ bottom: 12 })
        })
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16, top: 8, bottom: 16 })
    }
  }

  @Builder
  buildGiftCard(gift: Gift) {
    Row() {
      // ç¤¼ç‰©å›¾ç‰‡å ä½
      Column() {
        Text('ğŸ')
          .fontSize(32)
      }
      .width(80)
      .height(80)
      .backgroundColor('#F0F0F0')
      .borderRadius(8)
      .justifyContent(FlexAlign.Center)
      
      // ç¤¼ç‰©ä¿¡æ¯
      Column() {
        Text(gift.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Text(gift.description)
          .fontSize(12)
          .fontColor('#666666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 4 })
        
        Row() {
          Text(`Â¥${gift.price}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B6B')
          
          Blank()
          
          Row() {
            Text('â­')
              .fontSize(12)
            Text(`${gift.rating}`)
              .fontSize(12)
              .fontColor('#666666')
            Text(`(${gift.reviewCount})`)
              .fontSize(10)
              .fontColor('#999999')
          }
        }
        .width('100%')
        .margin({ top: 8 })
        
        // æ ‡ç­¾
        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(gift.tags.slice(0, 3), (tag: string) => {
            Text(tag)
              .fontSize(10)
              .fontColor('#4CAF50')
              .backgroundColor('#E8F5E8')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
              .margin({ right: 4, top: 4 })
          })
        }
        .margin({ top: 4 })
      }
      .layoutWeight(1)
      .margin({ left: 12 })
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(() => {
      // ç‚¹å‡»æŸ¥çœ‹ç¤¼ç‰©è¯¦æƒ…
      console.log('æŸ¥çœ‹ç¤¼ç‰©è¯¦æƒ…:', gift.name);
    })
  }

  private loadRecommendations() {
    this.loading = true;
    
    const request: GiftRecommendationRequest = {
      scenario: this.selectedScenario,
      category: this.selectedCategory,
      priceRange: this.selectedPriceRange,
      targetGroup: {
        gender: this.selectedGender || Gender.UNISEX,
        ageRange: this.selectedAgeRange || AgeRange.ADULT,
        relationship: this.selectedRelationship || Relationship.FRIEND,
        interests: []
      },
      keywords: this.searchKeyword ? [this.searchKeyword] : undefined
    };
    
    // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½
    setTimeout(() => {
      const response = this.giftService.getRecommendations(request);
      this.gifts = response.gifts;
      this.recommendationReason = response.recommendationReason;
      this.loading = false;
    }, 500);
  }

  private resetFilters() {
    this.selectedScenario = undefined;
    this.selectedCategory = undefined;
    this.selectedPriceRange = undefined;
    this.selectedGender = undefined;
    this.selectedAgeRange = undefined;
    this.selectedRelationship = undefined;
    this.searchKeyword = '';
    this.loadRecommendations();
  }
}