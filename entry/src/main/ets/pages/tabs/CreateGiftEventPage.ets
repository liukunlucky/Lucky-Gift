import { GiftEvent, Contact, Inspiration } from '../../model/NewDataModels';
import { GiftEventDAO } from '../../database/GiftEventDAO';
import { ContactDAO } from '../../database/ContactDAO';
import { InspirationDAO } from '../../database/InspirationDAO';
import { NewDatabaseManager } from '../../database/NewDatabaseManager';
import router from '@ohos.router';
import picker from '@ohos.file.picker';
import { BusinessError } from '@ohos.base';

// é¡µé¢å‚æ•°æŽ¥å£
interface PageParams {
  contactId?: string;
  eventId?: string;
  isEdit?: boolean;
  inspirationId?: string;
}

@Entry
@Component
struct CreateGiftEventPage {
  @State eventId: string = '';
  @State isEditMode: boolean = false;
  @State isLoading: boolean = false;
  @State isSaving: boolean = false;
  
  // è¡¨å•æ•°æ®
  @State selectedContact: Contact | null = null;
  @State eventTitle: string = '';
  @State eventDate: string = new Date().toISOString().split('T')[0];
  @State occasion: string = '';
  @State giftIdea: string = '';
  @State actualCost: number = 0;
  @State story: string = '';
  @State reaction: string = '';
  @State mood: string = '';
  @State selectedImages: string[] = [];
  @State reminderEnabled: boolean = false;
  @State reminderDate: string = '';
  @State selectedInspiration: Inspiration | null = null;
  
  // é€‰é¡¹æ•°æ®
  @State contacts: Contact[] = [];
  @State occasions: string[] = [
    'ç”Ÿæ—¥', 'çºªå¿µæ—¥', 'èŠ‚æ—¥', 'æ¯•ä¸š', 'å‡èŒ', 'ç»“å©š', 'ç”Ÿå­', 
    'é“æ­‰', 'æ„Ÿè°¢', 'æƒŠå–œ', 'å®‰æ…°', 'åº†ç¥', 'å…¶ä»–'
  ];
  @State moods: string[] = [
    'å¼€å¿ƒ', 'å…´å¥‹', 'æ„ŸåŠ¨', 'ç´§å¼ ', 'æœŸå¾…', 'æ»¡è¶³', 'æ¸©æš–', 'å…¶ä»–'
  ];
  
  private dbManager = new NewDatabaseManager();
  private giftEventDAO: GiftEventDAO = new GiftEventDAO(this.dbManager);
  private contactDAO: ContactDAO = new ContactDAO(this.dbManager);
  private inspirationDAO: InspirationDAO = new InspirationDAO(this.dbManager);
  
  aboutToAppear() {
    const params: PageParams = router.getParams() as PageParams || {}
    
    if (params.eventId) {
      this.eventId = params.eventId;
      this.isEditMode = true;
    }
    
    this.loadData(params);
  }
  
  async loadData(params: PageParams) {
    try {
      this.isLoading = true;
      
      // åŠ è½½è”ç³»äººåˆ—è¡¨
      this.contacts = await this.contactDAO.getAllContacts();
      
      // å¦‚æžœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼ŒåŠ è½½çŽ°æœ‰æ•°æ®
      if (this.isEditMode && this.eventId) {
        const event = await this.giftEventDAO.getGiftEventById(this.eventId);
        if (event) {
          this.loadEventData(event);
        }
      } else {
        // æ–°å»ºæ¨¡å¼ï¼Œå¤„ç†ä¼ å…¥çš„å‚æ•°
        if (params.contactId) {
          const contact = await this.contactDAO.getContactById(params.contactId);
          if (contact) {
            this.selectedContact = contact;
          }
        }
        
        if (params.inspirationId) {
          const inspiration = await this.inspirationDAO.getInspirationById(params.inspirationId);
          if (inspiration) {
            this.selectedInspiration = inspiration;
            this.giftIdea = inspiration.title;
            this.actualCost = inspiration.budgetRange.min || 0;
          }
        }
      }
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }
  
  loadEventData(event: GiftEvent) {
    this.eventTitle = event.giftIdea;
    this.eventDate = event.date.split('T')[0];
    this.occasion = event.occasion;
    this.giftIdea = event.giftIdea;
    this.actualCost = event.actualCost || 0;
    this.story = event.story || '';
    this.reaction = event.reaction || '';
    this.mood = event.mood || '';
    this.selectedImages = event.images || [];
    this.reminderEnabled = !!event.reminderDate;
    this.reminderDate = event.reminderDate ? event.reminderDate.split('T')[0] : '';
    
    // åŠ è½½è”ç³»äºº
    const contact = this.contacts.find(c => c.id === event.contactId);
    if (contact) {
      this.selectedContact = contact;
    }
  }
  
  async selectImages() {
    try {
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;
      photoSelectOptions.maxSelectNumber = 5 - this.selectedImages.length;
      
      const photoViewPicker = new picker.PhotoViewPicker();
      const photoSelectResult = await photoViewPicker.select(photoSelectOptions);
      
      if (photoSelectResult && photoSelectResult.photoUris) {
        this.selectedImages = [...this.selectedImages, ...photoSelectResult.photoUris];
      }
    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error);
    }
  }
  
  removeImage(index: number) {
    this.selectedImages.splice(index, 1);
  }
  
  async saveEvent() {
    if (!this.validateForm()) {
      return;
    }
    
    try {
      this.isSaving = true;
      
      const eventData: GiftEvent = {
        contactId: this.selectedContact!.id,
        contactName: this.selectedContact!.name,
        date: new Date(this.eventDate).toISOString(),
        occasion: this.occasion,
        giftIdea: this.giftIdea,
        budget: this.actualCost,
        actualCost: this.actualCost,
        story: this.story,
        reaction: this.reaction,
        mood: this.mood,
        images: this.selectedImages,
        tags: [],
        reminderSet: this.reminderEnabled,
        reminderDate: this.reminderEnabled && this.reminderDate ? 
          new Date(this.reminderDate).toISOString() : undefined
      };
      
      if (this.isEditMode) {
        await this.giftEventDAO.updateGiftEvent(this.eventId, eventData);
      } else {
        await this.giftEventDAO.createGiftEvent(eventData as GiftEvent);
      }
      
      // è¿”å›žè®°å½•é¡µé¢
      router.back();
    } catch (error) {
      console.error('ä¿å­˜äº‹ä»¶å¤±è´¥:', error);
    } finally {
      this.isSaving = false;
    }
  }
  
  validateForm(): boolean {
    if (!this.selectedContact) {
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      return false;
    }
    
    if (!this.eventTitle.trim()) {
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      return false;
    }
    
    if (!this.occasion) {
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      return false;
    }
    
    return true;
  }
  
  goBack() {
    router.back();
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => this.goBack())
        
        Text(this.isEditMode ? 'ç¼–è¾‘è®°å½•' : 'åˆ›å»ºè®°å½•')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Button() {
          if (this.isSaving) {
            LoadingProgress()
              .width(20)
              .height(20)
              .color('#FF6B35')
          } else {
            Text('ä¿å­˜')
              .fontSize(16)
              .fontColor('#FF6B35')
          }
        }
        .width(60)
        .height(40)
        .backgroundColor(Color.Transparent)
        .enabled(!this.isSaving)
        .onClick(() => this.saveEvent())
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#FF6B35')
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        Scroll() {
          Column() {
            // åŸºæœ¬ä¿¡æ¯
            Column() {
              Text('åŸºæœ¬ä¿¡æ¯')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Column() {
                // æ”¶ç¤¼äººé€‰æ‹©
                Column() {
                  Row() {
                    Text('æ”¶ç¤¼äºº')
                      .fontSize(14)
                      .fontColor('#666666')
                    
                    Text('*')
                      .fontSize(14)
                      .fontColor('#FF4444')
                      .margin({ left: 2 })
                  }
                  .margin({ bottom: 8 })
                  
                  Button() {
                    Row() {
                      Text(this.selectedContact ? this.selectedContact.name : 'é€‰æ‹©æ”¶ç¤¼äºº')
                        .fontSize(16)
                        .fontColor(this.selectedContact ? '#333333' : '#999999')
                        .layoutWeight(1)
                      
                      Text('â†’')
                        .fontSize(16)
                        .fontColor('#CCCCCC')
                    }
                  }
                  .width('100%')
                  .height(48)
                  .backgroundColor('#F8F9FA')
                  .borderRadius(8)
                  .padding({ left: 16, right: 16 })
                  .onClick(() => {
                    // æ˜¾ç¤ºè”ç³»äººé€‰æ‹©å¼¹çª—
                  })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
                
                // äº‹ä»¶æ ‡é¢˜
                Column() {
                  Row() {
                    Text('äº‹ä»¶æ ‡é¢˜')
                      .fontSize(14)
                      .fontColor('#666666')
                    
                    Text('*')
                      .fontSize(14)
                      .fontColor('#FF4444')
                      .margin({ left: 2 })
                  }
                  .margin({ bottom: 8 })
                  
                  TextInput({ placeholder: 'ä¸ºè¿™æ¬¡é€ç¤¼èµ·ä¸ªåå­—' })
                    .fontSize(16)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .padding({ left: 16, right: 16 })
                    .onChange((value: string) => {
                      this.eventTitle = value;
                    })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
                
                // æ—¥æœŸå’Œåœºåˆ
                Row() {
                  Column() {
                    Column() {
                      Row() {
                        Text('æ—¥æœŸ')
                          .fontSize(14)
                          .fontColor('#666666')
                        
                        Text('*')
                          .fontSize(14)
                          .fontColor('#FF4444')
                          .margin({ left: 2 })
                      }
                      .margin({ bottom: 8 })
                      
                      Button() {
                        Text(this.eventDate)
                          .fontSize(16)
                          .fontColor('#333333')
                      }
                      .width('100%')
                      .height(48)
                      .backgroundColor('#F8F9FA')
                      .borderRadius(8)
                      .onClick(() => {
                        // æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
                      })
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Start)
                    .margin({ bottom: 16 })
                  }
                  .layoutWeight(1)
                  .margin({ right: 8 })
                  
                  Column() {
                    Column() {
                      Row() {
                        Text('åœºåˆ')
                          .fontSize(14)
                          .fontColor('#666666')
                        
                        Text('*')
                          .fontSize(14)
                          .fontColor('#FF4444')
                          .margin({ left: 2 })
                      }
                      .margin({ bottom: 8 })
                      
                      Button() {
                        Row() {
                          Text(this.occasion || 'é€‰æ‹©åœºåˆ')
                            .fontSize(16)
                            .fontColor(this.occasion ? '#333333' : '#999999')
                            .layoutWeight(1)
                          
                          Text('â–¼')
                            .fontSize(12)
                            .fontColor('#999999')
                        }
                      }
                      .width('100%')
                      .height(48)
                      .backgroundColor('#F8F9FA')
                      .borderRadius(8)
                      .padding({ left: 16, right: 16 })
                      .onClick(() => {
                        // æ˜¾ç¤ºåœºåˆé€‰æ‹©å¼¹çª—
                      })
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Start)
                    .margin({ bottom: 16 })
                  }
                  .layoutWeight(1)
                  .margin({ left: 8 })
                }
                .width('100%')
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
            
            // ç¤¼ç‰©ä¿¡æ¯
            Column() {
              Text('ç¤¼ç‰©ä¿¡æ¯')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Column() {
                // ç¤¼ç‰©åˆ›æ„
                Column() {
                  Row() {
                    Text('ç¤¼ç‰©åˆ›æ„')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .margin({ bottom: 8 })
                  
                  if (this.selectedInspiration) {
                    Row() {
                      if (this.selectedInspiration.images?.[0]) {
                        Image(this.selectedInspiration.images[0])
                          .width(60)
                          .height(60)
                          .borderRadius(8)
                          .objectFit(ImageFit.Cover)
                          .margin({ right: 12 })
                      } else {
                        Text('ðŸ’¡')
                          .fontSize(24)
                          .width(60)
                          .height(60)
                          .textAlign(TextAlign.Center)
                          .backgroundColor('#F8F9FA')
                          .borderRadius(8)
                          .margin({ right: 12 })
                      }
                      
                      Column() {
                        Text(this.selectedInspiration.title)
                          .fontSize(16)
                          .fontColor('#333333')
                          .fontWeight(FontWeight.Medium)
                          .maxLines(2)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                        
                        Text(this.selectedInspiration.description)
                          .fontSize(14)
                          .fontColor('#666666')
                          .margin({ top: 4 })
                          .maxLines(2)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                      }
                      .layoutWeight(1)
                      .alignItems(HorizontalAlign.Start)
                      
                      Button('ç§»é™¤')
                        .fontSize(12)
                        .fontColor('#FF4444')
                        .backgroundColor('#FFF5F5')
                        .borderRadius(4)
                        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                        .onClick(() => {
                          this.selectedInspiration = null;
                        })
                    }
                    .width('100%')
                    .padding(12)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .margin({ bottom: 16 })
                  }
                  
                  TextArea({ placeholder: 'æè¿°ä½ çš„ç¤¼ç‰©åˆ›æ„...' })
                    .fontSize(16)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .padding(16)
                    .height(80)
                    .onChange((value: string) => {
                      this.giftIdea = value;
                    })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
                
                // å®žé™…èŠ±è´¹
                Column() {
                  Row() {
                    Text('å®žé™…èŠ±è´¹')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .margin({ bottom: 8 })
                  
                  TextInput({ placeholder: 'è¾“å…¥å®žé™…èŠ±è´¹é‡‘é¢' })
                    .fontSize(16)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .padding({ left: 16, right: 16 })
                    .type(InputType.Number)
                    .onChange((value: string) => {
                      this.actualCost = parseFloat(value) || 0;
                    })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
            
            // ç…§ç‰‡è®°å½•
            Column() {
              Text('ç…§ç‰‡è®°å½•')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Column() {
                if (this.selectedImages.length > 0) {
                  Grid() {
                    ForEach(this.selectedImages, (imageUri: string, index: number) => {
                      GridItem() {
                        Stack() {
                          Image(imageUri)
                            .width('100%')
                            .height('100%')
                            .borderRadius(8)
                            .objectFit(ImageFit.Cover)
                          
                          Button() {
                            Text('Ã—')
                              .fontSize(16)
                              .fontColor('#FFFFFF')
                          }
                          .width(24)
                          .height(24)
                          .backgroundColor('#FF4444')
                          .borderRadius(12)
                          .position({ x: '90%', y: '5%' })
                          .translate({ x: '-50%', y: '0%' })
                          .onClick(() => this.removeImage(index))
                        }
                        .width('100%')
                        .height(80)
                      }
                    })
                    
                    if (this.selectedImages.length < 5) {
                      GridItem() {
                        Button() {
                          Column() {
                            Text('+')
                              .fontSize(24)
                              .fontColor('#CCCCCC')
                            
                            Text('æ·»åŠ ç…§ç‰‡')
                              .fontSize(12)
                              .fontColor('#CCCCCC')
                              .margin({ top: 4 })
                          }
                        }
                        .width('100%')
                        .height(80)
                        .backgroundColor('#F8F9FA')
                        .borderRadius(8)
                        .border({ width: 1, color: '#EEEEEE', style: BorderStyle.Dashed })
                        .onClick(() => this.selectImages())
                      }
                    }
                  }
                  .columnsTemplate('1fr 1fr 1fr')
                  .columnsGap(8)
                  .rowsGap(8)
                  .margin({ bottom: 16 })
                }
                
                Button('æ·»åŠ ç…§ç‰‡')
                  .fontSize(16)
                  .fontColor('#FF6B35')
                  .backgroundColor('#FFF5F0')
                  .borderRadius(8)
                  .border({ width: 1, color: '#FF6B35', style: BorderStyle.Dashed })
                  .onClick(() => this.selectImages())
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
            
            // æƒ…æ„Ÿè®°å½•
            Column() {
              Text('æƒ…æ„Ÿè®°å½•')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Column() {
                // é€ç¤¼æ•…äº‹
                Column() {
                  Row() {
                    Text('é€ç¤¼æ•…äº‹')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .margin({ bottom: 8 })
                  
                  TextArea({ placeholder: 'è®°å½•é€ç¤¼çš„è¿‡ç¨‹å’ŒèƒŒæ™¯...' })
                    .fontSize(16)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .padding(16)
                    .height(80)
                    .onChange((value: string) => {
                      this.story = value;
                    })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
                
                // å¯¹æ–¹ååº”
                Column() {
                  Row() {
                    Text('å¯¹æ–¹ååº”')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .margin({ bottom: 8 })
                  
                  TextArea({ placeholder: 'è®°å½•å¯¹æ–¹æ”¶åˆ°ç¤¼ç‰©æ—¶çš„ååº”...' })
                    .fontSize(16)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .padding(16)
                    .height(80)
                    .onChange((value: string) => {
                      this.reaction = value;
                    })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
                
                // æˆ‘çš„å¿ƒæƒ…
                Column() {
                  Row() {
                    Text('æˆ‘çš„å¿ƒæƒ…')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .margin({ bottom: 8 })
                  
                  Flex({ wrap: FlexWrap.Wrap }) {
                    ForEach(this.moods, (mood: string) => {
                      Button(mood)
                        .fontSize(14)
                        .fontColor(this.mood === mood ? '#FFFFFF' : '#666666')
                        .backgroundColor(this.mood === mood ? '#FF6B35' : '#F5F5F5')
                        .borderRadius(16)
                        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                        .margin({ right: 8, bottom: 8 })
                        .onClick(() => {
                          this.mood = this.mood === mood ? '' : mood;
                        })
                    })
                  }
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
            
            // æé†’è®¾ç½®
            Column() {
              Text('æé†’è®¾ç½®')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Column() {
                Row() {
                  Column() {
                    Text('æ˜Žå¹´æé†’')
                      .fontSize(16)
                      .fontColor('#333333')
                    
                    Text('åœ¨æŒ‡å®šæ—¥æœŸå‰æé†’æˆ‘å‡†å¤‡ç¤¼ç‰©')
                      .fontSize(12)
                      .fontColor('#999999')
                      .margin({ top: 2 })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                  
                  Toggle({ type: ToggleType.Switch, isOn: this.reminderEnabled })
                    .selectedColor('#FF6B35')
                    .onChange((isOn: boolean) => {
                      this.reminderEnabled = isOn;
                    })
                }
                .width('100%')
                .alignItems(VerticalAlign.Center)
                
                if (this.reminderEnabled) {
                  Column() {
                    Column() {
                      Row() {
                        Text('æé†’æ—¥æœŸ')
                          .fontSize(14)
                          .fontColor('#666666')
                      }
                      .margin({ bottom: 8 })
                      
                      Button() {
                        Text(this.reminderDate || 'é€‰æ‹©æé†’æ—¥æœŸ')
                          .fontSize(16)
                          .fontColor(this.reminderDate ? '#333333' : '#999999')
                      }
                      .width('100%')
                      .height(48)
                      .backgroundColor('#F8F9FA')
                      .borderRadius(8)
                      .onClick(() => {
                        // æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
                      })
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Start)
                    .margin({ bottom: 16 })
                  }
                  .margin({ top: 16 })
                }
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
          }
          .padding(16)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }
}