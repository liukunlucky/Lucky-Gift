import { GiftEvent, Contact, Inspiration, Reminder } from '../../model/NewDataModels';
import { GiftEventDAO } from '../../database/GiftEventDAO';
import { ContactDAO } from '../../database/ContactDAO';
import { InspirationDAO } from '../../database/InspirationDAO';
import { ReminderDAO } from '../../database/ReminderDAO';
import { NewDatabaseManager } from '../../database/NewDatabaseManager';
import router from '@ohos.router';
import picker from '@ohos.file.picker';
import reminderAgentManager from '@ohos.reminderAgentManager';
import notificationManager from '@ohos.notificationManager';
// å…¼å®¹çš„TextPickerResultç±»å‹å®šä¹‰
interface CompatibleTextPickerResult {
  index: number | number[];
  value: string | string[];
}

// é¡µé¢å‚æ•°æ¥å£
interface PageParams {
  contactId?: string;
  eventId?: string;
  isEdit?: boolean;
  inspirationId?: string;
}

@Entry
@Component
struct CreateGiftEventPage {
  @State eventId: string = '';
  @State isEditMode: boolean = false;
  @State isLoading: boolean = false;
  @State isSaving: boolean = false;
  
  // è¡¨å•æ•°æ®
  @State selectedContact: Contact | null = null;
  @State recipientName: string = '';
  @State eventTitle: string = '';
  @State eventDate: string = new Date().toISOString().split('T')[0];
  @State occasion: string = '';
  @State giftIdea: string = '';
  @State actualCost: number = 0;
  @State story: string = '';
  @State reaction: string = '';
  @State mood: string = '';
  @State selectedImages: string[] = [];
  @State reminderEnabled: boolean = false;
  @State reminderDate: string = '';
  @State selectedInspiration: Inspiration | null = null;
  
  // é€‰é¡¹æ•°æ®
  @State contacts: Contact[] = [];
  @State occasions: string[] = [
    'ç”Ÿæ—¥', 'çºªå¿µæ—¥', 'èŠ‚æ—¥', 'æ¯•ä¸š', 'å‡èŒ', 'ç»“å©š', 'ç”Ÿå­', 
    'é“æ­‰', 'æ„Ÿè°¢', 'æƒŠå–œ', 'å®‰æ…°', 'åº†ç¥', 'å…¶ä»–'
  ];
  @State moods: string[] = [
    'å¼€å¿ƒ', 'å…´å¥‹', 'æ„ŸåŠ¨', 'ç´§å¼ ', 'æœŸå¾…', 'æ»¡è¶³', 'æ¸©æš–', 'å…¶ä»–'
  ];
  @State showOccasionDialog: boolean = false;
  @State customOccasion: string = '';
  
  // æ·»åŠ è”ç³»äººå¯¹è¯æ¡†ç›¸å…³
  @State showAddContactDialog: boolean = false;
  
  private dbManager = new NewDatabaseManager();
  private giftEventDAO: GiftEventDAO = new GiftEventDAO(this.dbManager);
  private contactDAO: ContactDAO = new ContactDAO(this.dbManager);
  private inspirationDAO: InspirationDAO = new InspirationDAO(this.dbManager);
  private reminderDAO: ReminderDAO = new ReminderDAO(this.dbManager);

  private getIconByMood(mood: string): Resource {
    if (mood==='å¼€å¿ƒ') {
      return $r('app.media.icon_happy');
    }
    if (mood==='å…´å¥‹') {
      return $r('app.media.icon_xf');
    }
    if (mood==='æ„ŸåŠ¨') {
      return $r('app.media.icon_gd');
    }
    if (mood==='ç´§å¼ ') {
      return $r('app.media.icon_jz');
    }
    if (mood==='æœŸå¾…') {
      return $r('app.media.icon_qd');
    }
    if (mood==='æ»¡è¶³') {
      return $r('app.media.icon_mz');
    }
    if (mood==='æ¸©æš–') {
      return $r('app.media.icon_wn');
    }
    return $r('app.media.icon_other');
  }
  async aboutToAppear() {
    const params: PageParams = router.getParams() as PageParams || {}
    
    if (params.eventId) {
      this.eventId = params.eventId;
      this.isEditMode = true;
    }
    
    if (params.isEdit !== undefined) {
      this.isEditMode = params.isEdit;
    }
    
    // ç¡®ä¿æ•°æ®åº“å·²åˆå§‹åŒ–
    try {
      await this.dbManager.initDatabase(getContext(this));
      console.log('æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      console.error('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error);
    }
    
    this.loadData(params);
  }
  
  // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°è”ç³»äººåˆ—è¡¨
  async onPageShow() {
    try {
      // é‡æ–°åŠ è½½è”ç³»äººåˆ—è¡¨ï¼Œä»¥è·å–å¯èƒ½æ–°å¢çš„è”ç³»äºº
      const updatedContacts = await this.contactDAO.getAllContacts();
      this.contacts = updatedContacts;
      console.log('è”ç³»äººåˆ—è¡¨å·²åˆ·æ–°ï¼Œå½“å‰è”ç³»äººæ•°é‡:', this.contacts.length);
    } catch (error) {
      console.error('åˆ·æ–°è”ç³»äººåˆ—è¡¨å¤±è´¥:', error);
    }
  }
  
  async loadData(params: PageParams) {
    try {
      this.isLoading = true;
      
      // åŠ è½½è”ç³»äººåˆ—è¡¨
      this.contacts = await this.contactDAO.getAllContacts();
      
      // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼ŒåŠ è½½ç°æœ‰æ•°æ®
      if (this.isEditMode && this.eventId) {
        const event = await this.giftEventDAO.getGiftEventById(this.eventId);
        if (event) {
          this.loadEventData(event);
        }
      } else {
        // æ–°å»ºæ¨¡å¼ï¼Œå¤„ç†ä¼ å…¥çš„å‚æ•°
        if (params.contactId) {
          const contact = await this.contactDAO.getContactById(params.contactId);
          if (contact) {
            this.selectedContact = contact;
          }
        }
        
        if (params.inspirationId) {
          const inspiration = await this.inspirationDAO.getInspirationById(params.inspirationId);
          if (inspiration) {
            this.selectedInspiration = inspiration;
            this.giftIdea = inspiration.title;
            this.actualCost = inspiration.budgetRange.min || 0;
          }
        }
      }
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }
  
  loadEventData(event: GiftEvent) {
    this.recipientName = event.contactName || '';
    this.eventTitle = event.occasion + ' - ' + event.contactName; // ç»„åˆäº‹ä»¶æ ‡é¢˜
    this.eventDate = event.date.split('T')[0];
    this.occasion = event.occasion;
    this.giftIdea = event.giftIdea;
    this.actualCost = event.actualCost || 0;
    this.story = event.story || '';
    this.reaction = event.reaction || '';
    this.mood = event.mood || '';
    this.selectedImages = event.images || [];
    this.reminderEnabled = !!event.reminderDate;
    this.reminderDate = event.reminderDate ? event.reminderDate.split('T')[0] : '';
    
    // åŠ è½½è”ç³»äºº - ä¿®å¤æ”¶ç¤¼äººæ˜¾ç¤ºé—®é¢˜
    const contact = this.contacts.find(c => c.id === event.contactId);
    if (contact) {
      this.selectedContact = contact;
      // ç¡®ä¿recipientNameä¸selectedContactä¿æŒä¸€è‡´
      this.recipientName = contact.name;
    } else {
      // å¦‚æœæ‰¾ä¸åˆ°è”ç³»äººï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶è”ç³»äººå¯¹è±¡ä»¥ä¿æŒæ•°æ®ä¸€è‡´æ€§
        console.warn('æœªæ‰¾åˆ°å¯¹åº”çš„è”ç³»äººï¼ŒcontactId:', event.contactId);
        if (event.contactName) {
          const tempContact: Contact = {
            id: String(event.contactId || 0),
            name: event.contactName,
            relationship: '',
            avatar: '',
            birthday: '',
            importantDates: [],
            preferences: [],
            notes: '',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          this.selectedContact = tempContact;
          this.recipientName = tempContact.name;
        }
    }
  }
  
  async selectImages() {
    try {
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;
      photoSelectOptions.maxSelectNumber = 3 - this.selectedImages.length;
      
      const photoViewPicker = new picker.PhotoViewPicker();
      const photoSelectResult = await photoViewPicker.select(photoSelectOptions);
      
      if (photoSelectResult && photoSelectResult.photoUris) {
        this.selectedImages = [...this.selectedImages, ...photoSelectResult.photoUris];
      }
    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error);
    }
  }
  
  removeImage(index: number) {
    this.selectedImages.splice(index, 1);
  }
  
  showDatePicker() {
    DatePickerDialog.show({
      start: new Date('1900-1-1'),
      end: new Date('2100-12-31'),
      selected: new Date(this.eventDate),
      onAccept: (value: DatePickerResult) => {
        const selectedDate = new Date(value.year!, value.month! + 1, value.day!);
        this.eventDate = selectedDate.toISOString().split('T')[0];
      }
    });
  }
  
  showOccasionPicker() {
    this.showOccasionDialog = true;
  }
  
  showReminderDatePicker() {
    DatePickerDialog.show({
      start: new Date(),
      end: new Date('2100-12-31'),
      selected: this.reminderDate ? new Date(this.reminderDate) : new Date(),
      onAccept: (value: DatePickerResult) => {
        const selectedDate = new Date(value.year!, value.month! + 1, value.day!);
        this.reminderDate = selectedDate.toISOString().split('T')[0];
      }
    });
  }
  
  async saveEvent() {
    if (!this.validateForm()) {
      console.log('è¡¨å•éªŒè¯å¤±è´¥');
      return;
    }
    
    try {
      this.isSaving = true;
      console.log('å¼€å§‹ä¿å­˜äº‹ä»¶...');
      
      const eventData: GiftEvent = {
        contactId: '', // ä¸å†éœ€è¦contactId
        contactName: this.recipientName,
        date: new Date(this.eventDate).toISOString(),
        occasion: this.occasion,
        giftIdea: this.giftIdea,
        budget: this.actualCost,
        actualCost: this.actualCost,
        story: this.story,
        reaction: this.reaction,
        mood: this.mood,
        images: this.selectedImages,
        tags: [],
        reminderSet: this.reminderEnabled,
        reminderDate: this.reminderEnabled && this.reminderDate ? 
          new Date(this.reminderDate).toISOString() : undefined
      };
      
      console.log('äº‹ä»¶æ•°æ®:', JSON.stringify(eventData));
      
      let eventId: string;
      if (this.isEditMode) {
        console.log('æ›´æ–°äº‹ä»¶:', this.eventId);
        await this.giftEventDAO.updateGiftEvent(this.eventId, eventData);
        eventId = this.eventId;
      } else {
        console.log('åˆ›å»ºæ–°äº‹ä»¶');
        const newId = await this.giftEventDAO.createGiftEvent(eventData as GiftEvent);
        console.log('åˆ›å»ºæˆåŠŸï¼ŒID:', newId);
        eventId = newId;
      }

      // åˆ›å»ºç³»ç»Ÿæé†’å’Œæ•°æ®åº“æé†’è®°å½•
      if (this.reminderEnabled && this.reminderDate) {
        const reminderId = await this.createSystemReminder(eventData);
        if (reminderId) {
          // ä¿å­˜æé†’åˆ°æ•°æ®åº“
          const reminderData: Reminder = {
            id: `reminder_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            type: 'gift_event',
            relatedId: eventId,
            title: `é€ç¤¼æé†’ï¼š${eventData.contactName}`,
            message: `${eventData.occasion} - ${eventData.giftIdea || 'å‡†å¤‡ç¤¼ç‰©'}`,
            reminderDate: new Date(this.reminderDate).toISOString(),
            isActive: true,
            isTriggered: false,
            createdAt: new Date().toISOString()
          };
          
          try {
            await this.reminderDAO.createReminder(reminderData);
            console.log('æé†’å·²ä¿å­˜åˆ°æ•°æ®åº“');
          } catch (error) {
            console.error('ä¿å­˜æé†’åˆ°æ•°æ®åº“å¤±è´¥:', error);
          }
          console.log('ç³»ç»Ÿæé†’åˆ›å»ºæˆåŠŸï¼ŒID:', reminderId);
        }
      }
      
      console.log('ä¿å­˜æˆåŠŸï¼Œè¿”å›è®°å½•é¡µé¢');
      // è¿”å›ä¸»é¡µé¢å¹¶åˆ‡æ¢åˆ°è®°å½•tabï¼Œè§¦å‘æ•°æ®åˆ·æ–°
      router.replaceUrl({
        url: 'pages/MainTabsPage',
        params: {
          targetTab: 1 // åˆ‡æ¢åˆ°è®°å½•tab
        }
      });
    } catch (error) {
      console.error('ä¿å­˜äº‹ä»¶å¤±è´¥:', error);
      // æ˜¾ç¤ºé”™è¯¯æç¤ºç»™ç”¨æˆ·
      AlertDialog.show({
        title: 'ä¿å­˜å¤±è´¥',
        message: 'ä¿å­˜è®°å½•æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
    } finally {
      this.isSaving = false;
    }
  }
  
  // å¯¼èˆªåˆ°æ·»åŠ è”ç³»äººé¡µé¢
  navigateToAddContact() {
    router.pushUrl({
      url: 'pages/profile/ContactFormPage',
      params: {
        isEdit: false
      }
    });
  }
  
  // é€‰æ‹©è”ç³»äºº
  selectContact(contact: Contact) {
    this.selectedContact = contact;
    this.recipientName = contact.name;
  }
  
  // æ˜¾ç¤ºæ”¶ç¤¼äººé€‰æ‹©å™¨
  showRecipientPicker() {
    if (this.contacts.length === 0) {
      AlertDialog.show({
        title: 'æç¤º',
        message: 'æš‚æ— è”ç³»äººï¼Œè¯·å…ˆæ·»åŠ è”ç³»äºº',
        primaryButton: {
          value: 'æ·»åŠ è”ç³»äºº',
          action: () => {
            this.navigateToAddContact();
          }
        },
        secondaryButton: {
          value: 'å–æ¶ˆ',
          action: () => {}
        }
      });
      return;
    }
    
    const contactNames = this.contacts.map(contact => contact.name);
    
    // ç¡®ä¿contactNamesä¸ä¸ºç©º
    if (contactNames.length === 0) {
      console.error('è”ç³»äººåˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤ºé€‰æ‹©å™¨');
      return;
    }
    
    let selectedIndex = 0;
    if (this.selectedContact) {
      const foundIndex = this.contacts.findIndex(contact => contact.id === this.selectedContact!.id);
      selectedIndex = foundIndex >= 0 ? foundIndex : 0;
    }
    
    // ç¡®ä¿selectedIndexåœ¨æœ‰æ•ˆèŒƒå›´å†…
    selectedIndex = Math.max(0, Math.min(selectedIndex, contactNames.length - 1));
    
    TextPickerDialog.show({
      range: contactNames,
      selected: selectedIndex,
      canLoop: false,
      onAccept: (value: CompatibleTextPickerResult) => {
        let index: number = 0;
        if (Array.isArray(value.index)) {
          if (value.index.length > 0) {
            // ä½¿ç”¨forEaché¿å…ç´¢å¼•è®¿é—®
            value.index.forEach((item: number, i: number) => {
              if (i === 0) {
                index = item;
              }
            });
          }
        } else {
          index = value.index as number;
        }
        if (index >= 0 && index < this.contacts.length) {
          let selectedContact: Contact | undefined;
          for (let i = 0; i < this.contacts.length; i++) {
            if (i === index) {
              selectedContact = this.contacts[i];
              break;
            }
          }
          // é¿å…é‡å¤é€‰æ‹©åŒä¸€è”ç³»äººå¯¼è‡´çš„å¾ªç¯
          if (selectedContact && (!this.selectedContact || this.selectedContact.id !== selectedContact.id)) {
            this.selectContact(selectedContact);
          }
        }
      },
      onCancel: () => {
        console.log('å–æ¶ˆé€‰æ‹©æ”¶ç¤¼äºº');
      }
    });
  }

  // åˆ›å»ºç³»ç»Ÿæé†’
  async createSystemReminder(eventData: GiftEvent): Promise<number | null> {
    if (!this.reminderEnabled || !this.reminderDate) {
      return null;
    }

    try {
      const reminderDateTime = new Date(this.reminderDate);
      
      const reminderRequest: reminderAgentManager.ReminderRequestCalendar = {
        reminderType: reminderAgentManager.ReminderType.REMINDER_TYPE_CALENDAR,
        dateTime: {
          year: reminderDateTime.getFullYear(),
          month: reminderDateTime.getMonth() + 1,
          day: reminderDateTime.getDate(),
          hour: 9, // é»˜è®¤ä¸Šåˆ9ç‚¹æé†’
          minute: 0
        },
        title: `é€ç¤¼æé†’ï¼š${eventData.contactName}`,
        content: `${eventData.occasion} - ${eventData.giftIdea || 'å‡†å¤‡ç¤¼ç‰©'}`,
        expiredContent: 'æé†’å·²è¿‡æœŸ',
        snoozeContent: 'ç¨åæé†’',
        notificationId: 100,
        slotType: notificationManager.SlotType.SOCIAL_COMMUNICATION
      };
      
      const reminderId = await reminderAgentManager.publishReminder(reminderRequest);
      console.info('åˆ›å»ºç³»ç»Ÿæé†’æˆåŠŸï¼ŒID:', reminderId);
      return reminderId;
    } catch (error) {
      console.error('åˆ›å»ºç³»ç»Ÿæé†’å¤±è´¥:', error);
      return null;
    }
  }
  
  validateForm(): boolean {
    if (!this.selectedContact) {
      console.log('æ”¶ç¤¼äººä¸èƒ½ä¸ºç©º');
      AlertDialog.show({
        title: 'æç¤º',
        message: 'è¯·é€‰æ‹©æ”¶ç¤¼äºº',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
      return false;
    }
    
    if (!this.occasion) {
      console.log('åœºåˆä¸èƒ½ä¸ºç©º');
      AlertDialog.show({
        title: 'æç¤º',
        message: 'è¯·é€‰æ‹©é€ç¤¼åœºåˆ',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
      return false;
    }
    
    console.log('è¡¨å•éªŒè¯é€šè¿‡');
    return true;
  }
  
  goBack() {
    router.back();
  }
  
  showDeleteConfirmDialog() {
    AlertDialog.show({
      title: 'ç¡®è®¤åˆ é™¤',
      message: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'åˆ é™¤',
        fontColor: '#FF4444',
        action: () => {
          this.deleteEvent();
        }
      }
    });
  }
  
  async deleteEvent() {
    try {
      this.isSaving = true;
      console.log('åˆ é™¤äº‹ä»¶:', this.eventId);
      
      await this.giftEventDAO.deleteGiftEvent(this.eventId);
      
      console.log('åˆ é™¤æˆåŠŸï¼Œè¿”å›è®°å½•é¡µé¢');
      // è¿”å›ä¸»é¡µé¢å¹¶åˆ‡æ¢åˆ°è®°å½•tabï¼Œè§¦å‘æ•°æ®åˆ·æ–°
      router.replaceUrl({
        url: 'pages/MainTabsPage',
        params: {
          targetTab: 1 // åˆ‡æ¢åˆ°è®°å½•tab
        }
      });
    } catch (error) {
      console.error('åˆ é™¤äº‹ä»¶å¤±è´¥:', error);
      AlertDialog.show({
        title: 'åˆ é™¤å¤±è´¥',
        message: 'åˆ é™¤è®°å½•æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
    } finally {
      this.isSaving = false;
    }
  }
  
  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(20)
            .fontColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => this.goBack())
        
        Text(this.isEditMode ? 'ç¼–è¾‘è®°å½•' : 'åˆ›å»ºè®°å½•')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Row() {
          // åˆ é™¤æŒ‰é’®ï¼ˆä»…ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰
          if (this.isEditMode) {
            Button() {
              Text('åˆ é™¤')
                .fontSize(14)
                .fontColor('#FF4444')
            }
            .width(50)
            .height(32)
            .backgroundColor(Color.Transparent)
            .border({ width: 1, color: '#FF4444' })
            .borderRadius(16)
            .margin({ right: 8 })
            .onClick(() => this.showDeleteConfirmDialog())
          }
          
          // ä¿å­˜æŒ‰é’®
          Button() {
            if (this.isSaving) {
              LoadingProgress()
                .width(20)
                .height(20)
                .color('#FF6B35')
            } else {
              Text('ä¿å­˜')
                .fontSize(16)
                .fontColor('#FF6B35')
            }
          }
          .width(60)
          .height(40)
          .backgroundColor(Color.Transparent)
          .enabled(!this.isSaving)
          .onClick(() => this.saveEvent())
        }
        .justifyContent(FlexAlign.End)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#FF6B35')
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        Scroll() {
          Column() {
            // åŸºæœ¬ä¿¡æ¯
            Column() {
              Text('åŸºæœ¬ä¿¡æ¯')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Column() {
                // æ”¶ç¤¼äººé€‰æ‹©
                Column() {
                  Row() {
                    Text('æ”¶ç¤¼äºº')
                      .fontSize(14)
                      .fontColor('#666666')
                    
                    Text('*')
                      .fontSize(14)
                      .fontColor('#FF4444')
                      .margin({ left: 2 })
                  }
                  .margin({ bottom: 8 })
                  
                  if (this.contacts.length > 0) {
                    // æœ‰è”ç³»äººæ—¶æ˜¾ç¤ºä¸‹æ‹‰æ¡†
                    Button() {
                      Row() {
                        Text(this.selectedContact ? this.selectedContact.name : 'é€‰æ‹©æ”¶ç¤¼äºº')
                          .fontSize(16)
                          .fontColor(this.selectedContact ? '#333333' : '#999999')
                          .layoutWeight(1)
                        
                        Text('â–¼')
                          .fontSize(12)
                          .fontColor('#999999')
                      }
                    }
                    .width('100%')
                    .height(48)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .padding({ left: 16, right: 16 })
                    .onClick(() => {
                      this.showRecipientPicker();
                    })
                  } else {
                    // æ²¡æœ‰è”ç³»äººæ—¶æ˜¾ç¤ºæç¤º
                    Column() {
                      Button() {
                        Row() {
                          Text('æš‚æ— è”ç³»äººï¼Œè¯·å…ˆæ·»åŠ å…³ç³»')
                            .fontSize(16)
                            .fontColor('#999999')
                            .layoutWeight(1)
                          
                          Text('æ·»åŠ ')
                            .fontSize(14)
                            .fontColor('#FF6B35')
                        }
                      }
                      .width('100%')
                      .height(48)
                      .backgroundColor('#FFF5F0')
                      .borderRadius(8)
                      .padding({ left: 16, right: 16 })
                      .border({ width: 1, color: '#FF6B35', style: BorderStyle.Dashed })
                      .onClick(() => {
                        this.navigateToAddContact();
                      })
                    }
                  }
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
                
                // äº‹ä»¶æ ‡é¢˜
                Column() {
                  Row() {
                    Text('äº‹ä»¶æ ‡é¢˜')
                      .fontSize(14)
                      .fontColor('#666666')
                    
                    Text('*')
                      .fontSize(14)
                      .fontColor('#FF4444')
                      .margin({ left: 2 })
                  }
                  .margin({ bottom: 8 })
                  
                  TextInput({ placeholder: 'ä¸ºè¿™æ¬¡é€ç¤¼èµ·ä¸ªåå­—', text: this.eventTitle })
                    .fontSize(16)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .padding({ left: 16, right: 16 })
                    .onChange((value: string) => {
                      this.eventTitle = value;
                    })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
                
                // æ—¥æœŸå’Œåœºåˆ
                Row() {
                  Column() {
                    Column() {
                      Row() {
                        Text('æ—¥æœŸ')
                          .fontSize(14)
                          .fontColor('#666666')
                        
                        Text('*')
                          .fontSize(14)
                          .fontColor('#FF4444')
                          .margin({ left: 2 })
                      }
                      .margin({ bottom: 8 })
                      
                      Button() {
                        Text(this.eventDate)
                          .fontSize(16)
                          .fontColor('#333333')
                      }
                      .width('100%')
                      .height(48)
                      .backgroundColor('#F8F9FA')
                      .borderRadius(8)
                      .onClick(() => {
                        this.showDatePicker();
                      })
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Start)
                    .margin({ bottom: 16 })
                  }
                  .layoutWeight(1)
                  .margin({ right: 8 })
                  
                  Column() {
                    Column() {
                      Row() {
                        Text('åœºåˆ')
                          .fontSize(14)
                          .fontColor('#666666')
                        
                        Text('*')
                          .fontSize(14)
                          .fontColor('#FF4444')
                          .margin({ left: 2 })
                      }
                      .margin({ bottom: 8 })
                      
                      Button() {
                        Row() {
                          Text(this.occasion || 'é€‰æ‹©åœºåˆ')
                            .fontSize(16)
                            .fontColor(this.occasion ? '#333333' : '#999999')
                            .layoutWeight(1)
                          
                          Text('â–¼')
                            .fontSize(12)
                            .fontColor('#999999')
                        }
                      }
                      .width('100%')
                      .height(48)
                      .backgroundColor('#F8F9FA')
                      .borderRadius(8)
                      .padding({ left: 16, right: 16 })
                      .onClick(() => {
                        this.showOccasionPicker();
                      })
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Start)
                    .margin({ bottom: 16 })
                  }
                  .layoutWeight(1)
                  .margin({ left: 8 })
                }
                .width('100%')
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
            
            // ç¤¼ç‰©ä¿¡æ¯
            Column() {
              Text('ç¤¼ç‰©ä¿¡æ¯')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Column() {
                // ç¤¼ç‰©åˆ›æ„
                Column() {
                  Row() {
                    Text('ç¤¼ç‰©åˆ›æ„')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .margin({ bottom: 8 })
                  
                  if (this.selectedInspiration) {
                    Row() {
                      if (this.selectedInspiration.images?.[0]) {
                        Image(this.selectedInspiration.images[0])
                          .width(60)
                          .height(60)
                          .borderRadius(8)
                          .objectFit(ImageFit.Cover)
                          .margin({ right: 12 })
                      } else {
                        Text('ğŸ’¡')
                          .fontSize(24)
                          .width(60)
                          .height(60)
                          .textAlign(TextAlign.Center)
                          .backgroundColor('#F8F9FA')
                          .borderRadius(8)
                          .margin({ right: 12 })
                      }
                      
                      Column() {
                        Text(this.selectedInspiration.title)
                          .fontSize(16)
                          .fontColor('#333333')
                          .fontWeight(FontWeight.Medium)
                          .maxLines(2)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                        
                        Text(this.selectedInspiration.description)
                          .fontSize(14)
                          .fontColor('#666666')
                          .margin({ top: 4 })
                          .maxLines(2)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                      }
                      .layoutWeight(1)
                      .alignItems(HorizontalAlign.Start)
                      
                      Button('ç§»é™¤')
                        .fontSize(12)
                        .fontColor('#FF4444')
                        .backgroundColor('#FFF5F5')
                        .borderRadius(4)
                        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                        .onClick(() => {
                          this.selectedInspiration = null;
                        })
                    }
                    .width('100%')
                    .padding(12)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .margin({ bottom: 16 })
                  }
                  
                  TextArea({ placeholder: 'æè¿°ä½ çš„ç¤¼ç‰©åˆ›æ„...', text: this.giftIdea })
                    .fontSize(16)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .padding(16)
                    .height(80)
                    .onChange((value: string) => {
                      this.giftIdea = value;
                    })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
                
                // å®é™…èŠ±è´¹
                Column() {
                  Row() {
                    Text('å®é™…èŠ±è´¹')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .margin({ bottom: 8 })
                  
                  TextInput({ placeholder: 'è¾“å…¥å®é™…èŠ±è´¹é‡‘é¢ï¼ˆå•ä½ï¼šå…ƒï¼‰', text: this.actualCost > 0 ? this.actualCost.toString() : '' })
                    .fontSize(16)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .padding({ left: 16, right: 16 })
                    .type(InputType.Number)
                    .onChange((value: string) => {
                      this.actualCost = parseFloat(value) || 0;
                    })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
            
            // ç…§ç‰‡è®°å½•
            Column() {
              Text('ç…§ç‰‡è®°å½•')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Column() {
                if (this.selectedImages.length > 0) {
                  Grid() {
                    ForEach(this.selectedImages, (imageUri: string, index: number) => {
                      GridItem() {
                        Stack() {
                          Image(imageUri)
                            .width('100%')
                            .height('100%')
                            .borderRadius(8)
                            .objectFit(ImageFit.Cover)
                          
                          Button() {
                            Text('Ã—')
                              .fontSize(16)
                              .fontColor('#FFFFFF')
                          }
                          .width(24)
                          .height(24)
                          .backgroundColor('#FF4444')
                          .borderRadius(12)
                          .position({ x: '90%', y: '5%' })
                          .translate({ x: '-50%', y: '0%' })
                          .onClick(() => this.removeImage(index))
                        }
                        .width('100%')
                        .height(80)
                      }
                    })
                    
                    if (this.selectedImages.length < 3) {
                      GridItem() {
                        Button() {
                          Column() {
                            Text('+')
                              .fontSize(24)
                              .fontColor('#CCCCCC')
                            
                            Text('æ·»åŠ ç…§ç‰‡')
                              .fontSize(12)
                              .fontColor('#CCCCCC')
                              .margin({ top: 4 })
                          }
                        }
                        .width('100%')
                        .height(80)
                        .backgroundColor('#F8F9FA')
                        .borderRadius(8)
                        .border({ width: 1, color: '#CCCCCC', style: BorderStyle.Dashed })
                        .onClick(() => this.selectImages())
                      }
                    }
                  }
                  .columnsTemplate('1fr 1fr 1fr')
                  .columnsGap(8)
                  .rowsGap(8)
                  .margin({ bottom: 16 })
                } else {
                  Button('æœ€å¤šæ·»åŠ 3å¼ ç…§ç‰‡')
                    .fontSize(16)
                    .fontColor('#FF6B35')
                    .backgroundColor('#FFF5F0')
                    .borderRadius(8)
                    .border({ width: 1, color: '#FF6B35', style: BorderStyle.Dashed })
                    .onClick(() => this.selectImages())
                }
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
            
            // æƒ…æ„Ÿè®°å½•
            Column() {
              Text('æƒ…æ„Ÿè®°å½•')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Column() {
                // é€ç¤¼æ•…äº‹
                Column() {
                  Row() {
                    Text('é€ç¤¼æ•…äº‹')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .margin({ bottom: 8 })
                  
                  TextArea({ placeholder: 'è®°å½•é€ç¤¼çš„è¿‡ç¨‹å’ŒèƒŒæ™¯...', text: this.story })
                    .fontSize(16)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(8)
                    .padding(16)
                    .height(80)
                    .onChange((value: string) => {
                      this.story = value;
                    })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
                
                // å¯¹æ–¹ååº”
                Column() {
                  Row() {
                    Text('å¯¹æ–¹ååº”')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .margin({ bottom: 8 })
                  
                  Flex({ wrap: FlexWrap.Wrap }) {
                    ForEach(this.moods, (mood: string) => {
                      Button() {
                        Row() {
                          Image(this.getIconByMood(mood))
                            .width(14)
                            .height(14)
                            .margin({ right: 4 })
                          Text(mood)
                            .fontSize(14)
                        }
                      }
                      .fontColor(this.reaction === mood ? '#FFFFFF' : '#666666')
                      .backgroundColor(this.reaction === mood ? '#FF6B35' : '#F5F5F5')
                      .borderRadius(16)
                      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                      .margin({ right: 8, bottom: 8 })
                      .onClick(() => {
                        this.reaction = this.reaction === mood ? '' : mood;
                      })
                    })
                  }
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
                
                // æˆ‘çš„å¿ƒæƒ…
                Column() {
                  Row() {
                    Text('æˆ‘çš„å¿ƒæƒ…')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .margin({ bottom: 8 })
                  
                  Flex({ wrap: FlexWrap.Wrap }) {
                    ForEach(this.moods, (mood: string) => {
                      Button() {
                        Row() {
                          Image(this.getIconByMood(mood))
                            .width(14)
                            .height(14)
                            .margin({ right: 4 })
                          Text(mood)
                            .fontSize(14)
                        }
                      }
                      .fontColor(this.mood === mood ? '#FFFFFF' : '#666666')
                      .backgroundColor(this.mood === mood ? '#FF6B35' : '#F5F5F5')
                      .borderRadius(16)
                      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                      .margin({ right: 8, bottom: 8 })
                      .onClick(() => {
                        this.mood = this.mood === mood ? '' : mood;
                      })
                    })
                  }
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 16 })
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
            
            // æé†’è®¾ç½®
            Column() {
              Text('æé†’è®¾ç½®')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Column() {
                Row() {
                  Column() {
                    Text('æ˜å¹´æé†’')
                      .fontSize(16)
                      .fontColor('#333333')
                    
                    Text('åœ¨æŒ‡å®šæ—¥æœŸå‰æé†’æˆ‘å‡†å¤‡ç¤¼ç‰©')
                      .fontSize(12)
                      .fontColor('#999999')
                      .margin({ top: 2 })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                  
                  Toggle({ type: ToggleType.Switch, isOn: this.reminderEnabled })
                    .selectedColor('#FF6B35')
                    .onChange((isOn: boolean) => {
                      this.reminderEnabled = isOn;
                    })
                }
                .width('100%')
                .alignItems(VerticalAlign.Center)
                
                if (this.reminderEnabled) {
                  Column() {
                    Column() {
                      Row() {
                        Text('æé†’æ—¥æœŸ')
                          .fontSize(14)
                          .fontColor('#666666')
                      }
                      .margin({ bottom: 8 })
                      
                      Button() {
                        Text(this.reminderDate || 'é€‰æ‹©æé†’æ—¥æœŸ')
                          .fontSize(16)
                          .fontColor(this.reminderDate ? '#333333' : '#999999')
                      }
                      .width('100%')
                      .height(48)
                      .backgroundColor('#F8F9FA')
                      .borderRadius(8)
                      .onClick(() => {
                        this.showReminderDatePicker();
                      })
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Start)
                    .margin({ bottom: 16 })
                  }
                  .margin({ top: 16 })
                }
              }
            }
            .width('100%')
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .padding(16)
            .margin({ bottom: 16 })
          }
          .padding(16)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
    .bindSheet($$this.showOccasionDialog, this.occasionPickerSheet(), {
      height: 400,
      dragBar: true,
      backgroundColor: '#FFFFFF'
    })


    }
  }
  
  @Builder
  occasionPickerSheet() {
    Column() {
      Text('é€‰æ‹©åœºåˆ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ top: 20, bottom: 20 })
      
      List() {
        ForEach(this.occasions, (occasion: string) => {
          ListItem() {
            Row() {
              Text(occasion)
                .fontSize(16)
                .fontColor('#333333')
                .layoutWeight(1)
              
              if (this.occasion === occasion) {
                Text('âœ“')
                  .fontSize(16)
                  .fontColor('#FF6B35')
              }
            }
            .width('100%')
            .height(48)
            .padding({ left: 20, right: 20 })
            .onClick(() => {
              if (occasion === 'å…¶ä»–') {
                // æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥
                this.occasion = '';
                this.showCustomOccasionInput();
              } else {
                this.occasion = occasion;
                this.showOccasionDialog = false;
              }
            })
          }
        })
      }
      .divider({ strokeWidth: 1, color: '#F0F0F0' })
      
      if (this.occasion === '' && this.customOccasion !== '') {
        Column() {
          Text('è‡ªå®šä¹‰åœºåˆ')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 20, bottom: 10 })
          
          TextInput({ placeholder: 'è¯·è¾“å…¥è‡ªå®šä¹‰åœºåˆ', text: this.customOccasion })
            .fontSize(16)
            .backgroundColor('#F8F9FA')
            .borderRadius(8)
            .padding({ left: 16, right: 16 })
            .margin({ bottom: 20 })
            .onChange((value: string) => {
              this.customOccasion = value;
            })
          
          Button('ç¡®å®š')
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#FF6B35')
            .borderRadius(8)
            .width('100%')
            .height(44)
            .onClick(() => {
              if (this.customOccasion.trim()) {
                this.occasion = this.customOccasion.trim();
                this.showOccasionDialog = false;
                this.customOccasion = '';
              }
            })
        }
        .padding({ left: 20, right: 20 })
      }
    }
    .width('100%')
  }

  showCustomOccasionInput() {
    this.customOccasion = '';
  }
}