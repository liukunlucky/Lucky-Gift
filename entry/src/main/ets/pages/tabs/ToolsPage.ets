import router from '@ohos.router';
import { BudgetCalculation, HolidayCountdown } from '../../model/NewDataModels';
import { ToolsDAO } from '../../database/ToolsDAO';
import { NewDatabaseManager } from '../../database/NewDatabaseManager';

// è½®æ’­å›¾å†…å®¹æ¥å£
interface BannerItem {
  id: string;
  title: string;
  subtitle: string;
  description: string;
  backgroundColor: string;
  textColor: string;
  icon: string;
  actionText?: string;
  actionType?: string;
}

// å·¥å…·èœå•æ¥å£
interface ToolMenu {
  id: string;
  title: string;
  description: string;
  icon: Resource;
  color: string;
}


// ç¤¼ç‰©æ¨èæ¥å£
interface GiftRecommendation {
  id: string;
  title: string;
  category: string;
  priceRange: string;
  popularity: number;
  tags: string[];
}


@Component
export struct ToolsPage {
  @State bannerItems: BannerItem[] = [];
  @State giftRecommendations: GiftRecommendation[] = [];
  @State budgetCalculations: BudgetCalculation[] = [];
  @State upcomingHolidays: HolidayCountdown[] = [];
  @State isLoading: boolean = true;
  @State showBudgetCalculator: boolean = false;
  @State totalBudget: string = '';
  @State numberOfPeople: string = '';
  @State calculatedResult: number = 0;
  @State currentBannerIndex: number = 0;
  private dbManager = new NewDatabaseManager();
  private toolsDAO: ToolsDAO = new ToolsDAO(this.dbManager);
  // å·¥å…·èœå•é…ç½®
  private toolMenus: ToolMenu[] = [
    {
      id: 'record',
      title: 'å¿«é€Ÿè®°å½•',
      description: 'è®°å½•é€ç¤¼æƒ³æ³•',
      icon: $r('app.media.icon_record'),
      color: '#4CAF50'
    },
    {
      id: 'reminder',
      title: 'é€ç¤¼æé†’',
      description: 'é‡è¦æ—¥æœŸæé†’',
      icon: $r('app.media.icon_rl'),
      color: '#2196F3'
    },
    {
      id: 'checklist',
      title: 'ç¤¼ç‰©æ¸…å•æ£€æŸ¥',
      description: 'ç¡®ä¿é€ç¤¼ä¸‡æ— ä¸€å¤±',
      icon: $r('app.media.icon_check'),
      color: '#4CAF50'
    },
    {
      id: 'giftcard',
      title: 'ç¤¼ç‰©å¡åˆ¶ä½œå™¨',
      description: 'åˆ¶ä½œç²¾ç¾çš„ç¤¼ç‰©å¡ç‰‡',
      icon: $r('app.media.icon_hk'),
      color: '#E91E63'
    },
    {
      id: 'budget',
      title: 'é¢„ç®—è®¡ç®—å™¨',
      description: 'åˆç†åˆ†é…é€ç¤¼é¢„ç®—',
      icon: $r('app.media.icon_jsq'),
      color: '#FF9800'
    },
    {
      id: 'countdown',
      title: 'èŠ‚æ—¥å€’è®¡æ—¶',
      description: 'ä¸é”™è¿‡é‡è¦èŠ‚æ—¥',
      icon: $r('app.media.icon_rl'),
      color: '#2196F3'
    }
  ];

  aboutToAppear() {
    this.loadData();
    // åŠ è½½è½®æ’­å›¾æ•°æ®
    this.bannerItems = this.getBannerItems();
    // åŠ è½½ç¤¼ç‰©æ¨èæ•°æ®
    this.giftRecommendations = this.getGiftRecommendations();
    // æ¨¡æ‹ŸåŠ è½½å®Œæˆ
    setTimeout(() => {
      this.isLoading = false;
    }, 1000);
  }

  async loadData() {
    try {
      // åŠ è½½è½®æ’­å›¾æ•°æ®
      this.bannerItems = this.getBannerItems();
      // åŠ è½½ç¤¼ç‰©æ¨èæ•°æ®
      this.giftRecommendations = this.getGiftRecommendations();
      // åŠ è½½é¢„ç®—è®¡ç®—æ•°æ®
      this.budgetCalculations = await this.toolsDAO.getAllBudgetCalculations();
      // åŠ è½½èŠ‚æ—¥å€’è®¡æ—¶æ•°æ®
      this.upcomingHolidays = await this.toolsDAO.getUpcomingHolidays(30);
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // è·å–è½®æ’­å›¾æ•°æ®
  getBannerItems(): BannerItem[] {
    return [
      {
        id: '1',
        title: 'ğŸ æ™ºèƒ½ç¤¼ç‰©æ¨è',
        subtitle: 'è®©AIå¸®ä½ é€‰ç¤¼ç‰©',
        description: 'åŸºäºæ”¶ç¤¼äººçš„å–œå¥½å’Œåœºåˆï¼Œä¸ºä½ æ¨èæœ€åˆé€‚çš„ç¤¼ç‰©',
        backgroundColor: '#FF6B35',
        textColor: '#FFFFFF',
        icon: 'ğŸ¤–',
        actionText: 'ç«‹å³ä½“éªŒ',
        actionType: 'recommendation'
      },
      {
        id: '2',
        title: 'ğŸ’ èŠ‚æ—¥ç¤¼ç‰©æŒ‡å—',
        subtitle: 'ä¸åŒèŠ‚æ—¥é€ä»€ä¹ˆ',
        description: 'æƒ…äººèŠ‚ã€ç”Ÿæ—¥ã€çºªå¿µæ—¥...æ¯ä¸ªèŠ‚æ—¥éƒ½æœ‰ä¸“å±æ¨è',
        backgroundColor: '#E91E63',
        textColor: '#FFFFFF',
        icon: 'ğŸ“…',
        actionText: 'æŸ¥çœ‹æŒ‡å—',
        actionType: 'guide'
      },
      {
        id: '3',
        title: 'ğŸ’° é¢„ç®—ä¼˜åŒ–åŠ©æ‰‹',
        subtitle: 'èŠ±æœ€å°‘çš„é’±é€æœ€å¥½çš„ç¤¼',
        description: 'æ ¹æ®ä½ çš„é¢„ç®—ï¼Œæ‰¾åˆ°æ€§ä»·æ¯”æœ€é«˜çš„ç¤¼ç‰©é€‰æ‹©',
        backgroundColor: '#2196F3',
        textColor: '#FFFFFF',
        icon: 'ğŸ’¡',
        actionText: 'å¼€å§‹ä¼˜åŒ–',
        actionType: 'budget'
      },
      {
        id: '4',
        title: 'ğŸ¨ ä¸ªæ€§åŒ–å®šåˆ¶',
        subtitle: 'ç‹¬ä¸€æ— äºŒçš„å¿ƒæ„',
        description: 'å®šåˆ¶ä¸“å±ç¤¼ç‰©ï¼Œè®©ä½ çš„å¿ƒæ„æ›´åŠ ç‰¹åˆ«',
        backgroundColor: '#9C27B0',
        textColor: '#FFFFFF',
        icon: 'âœ¨',
        actionText: 'å¼€å§‹å®šåˆ¶',
        actionType: 'customize'
      }
    ];
  }

  // è·å–ç¤¼ç‰©æ¨èæ•°æ®
  getGiftRecommendations(): GiftRecommendation[] {
    return [
      {
        id: '1',
        title: 'å®šåˆ¶ç…§ç‰‡ç›¸å†Œ',
        category: 'çºªå¿µå“',
        priceRange: '50-200å…ƒ',
        popularity: 95,
        tags: ['ä¸ªæ€§åŒ–', 'çºªå¿µæ„ä¹‰', 'æƒ…ä¾£']
      },
      {
        id: '2',
        title: 'æ™ºèƒ½æ‰‹è¡¨',
        category: 'æ•°ç äº§å“',
        priceRange: '500-2000å…ƒ',
        popularity: 88,
        tags: ['å®ç”¨', 'ç§‘æŠ€', 'å¥åº·']
      },
      {
        id: '3',
        title: 'é¦™è–°èœ¡çƒ›å¥—è£…',
        category: 'ç”Ÿæ´»ç”¨å“',
        priceRange: '80-300å…ƒ',
        popularity: 92,
        tags: ['æµªæ¼«', 'æ”¾æ¾', 'å±…å®¶']
      },
      {
        id: '4',
        title: 'æ‰‹å·¥å·§å…‹åŠ›',
        category: 'ç¾é£Ÿ',
        priceRange: '30-150å…ƒ',
        popularity: 85,
        tags: ['ç”œèœœ', 'ç¾å‘³', 'èŠ‚æ—¥']
      }
    ];
  }

  // è®¡ç®—é¢„ç®—
  calculateBudget() {
    const total = parseFloat(this.totalBudget);
    const people = parseInt(this.numberOfPeople);

    if (total > 0 && people > 0) {
      this.calculatedResult = total / people;
    } else {
      this.calculatedResult = 0;
    }
  }

  // ä¿å­˜é¢„ç®—è®¡ç®—
  async saveBudgetCalculation() {
    if (this.calculatedResult > 0) {
      try {
        const calculation: BudgetCalculation = {
          id: "",
          name: `${this.numberOfPeople}äººé¢„ç®—åˆ†é…`,
          title: `${this.numberOfPeople}äººé¢„ç®—åˆ†é…`,
          totalBudget: parseFloat(this.totalBudget),
          numberOfPeople: parseInt(this.numberOfPeople),
          budgetPerPerson: this.calculatedResult,
          items: [],
          createdAt: ""
        };

        await this.toolsDAO.createBudgetCalculation(calculation);
        this.budgetCalculations = await this.toolsDAO.getAllBudgetCalculations();

        // é‡ç½®è¡¨å•
        this.totalBudget = '';
        this.numberOfPeople = '';
        this.calculatedResult = 0;
        this.showBudgetCalculator = false;
      } catch (error) {
        console.error('ä¿å­˜é¢„ç®—è®¡ç®—å¤±è´¥:', error);
      }
    }
  }

  // å¯¼èˆªåˆ°å·¥å…·é¡µé¢
  navigateToTool(toolId: string) {
    switch (toolId) {
      case 'record':
        router.pushUrl({
          url: 'pages/tools/QuickRecordPage'
        });
        break;
      case 'reminder':
        router.pushUrl({
          url: 'pages/profile/GiftReminderPage'
        });
        break;
      case 'checklist':
        router.pushUrl({
          url: 'pages/tools/GiftChecklistPage'
        });
        break;
      case 'giftcard':
        router.pushUrl({
          url: 'pages/tools/GiftCardMakerPage'
        });
        break;
      case 'budget':
        router.pushUrl({
          url: 'pages/tools/BudgetCalculatorPage'
        });
        break;
      case 'countdown':
        router.pushUrl({
          url: 'pages/tools/HolidayCountdownPage'
        });
        break;
    }
  }

  navigateToGiftCardMaker() {
    router.pushUrl({
      url: 'pages/tools/GiftCardMakerPage'
    });
  }

  navigateToBudgetCalculator() {
    router.pushUrl({
      url: 'pages/tools/BudgetCalculatorPage'
    });
  }

  navigateToHolidayCountdown() {
    router.pushUrl({
      url: 'pages/tools/HolidayCountdownPage'
    });
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}æœˆ${day}æ—¥`;
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Row() {
        Text('å·¥å…·ç™¾å®ç®±')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Blank()

        Text('è®©é€ç¤¼æ›´è½»æ¾')
          .fontSize(14)
          .fontColor('#666666')
      }
      .width('100%')
      .padding({
        left: 20,
        right: 20,
        top: 16,
        bottom: 16
      })
      .backgroundColor(Color.White)

      // å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          if (this.isLoading) {
            // åŠ è½½çŠ¶æ€
            Column() {
              LoadingProgress()
                .width(50)
                .height(50)
                .color('#FF6B35')

              Text('åŠ è½½ä¸­...')
                .fontSize(14)
                .fontColor('#666666')
                .margin({ top: 12 })
            }
            .width('100%')
            .height('60%')
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          } else {
            Column() {
              // å·¥å…·èœå•
              Column() {
                Text('å®ç”¨å·¥å…·')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .margin({ bottom: 20 })
                  .alignSelf(ItemAlign.Start)

                Grid() {
                  ForEach(this.toolMenus, (tool: ToolMenu) => {
                    GridItem() {
                      Column() {
                        Image(tool.icon)
                          .width(24)
                          .height(24)
                          .fillColor('#000000')
                        Blank().height(10)
                        Text(tool.title)
                          .fontSize(14)
                          .fontWeight(FontWeight.Medium)
                          .fontColor('#333333')
                          .margin({ bottom: 6 })
                        Text(tool.description)
                          .fontSize(11)
                          .fontColor('#666666')
                          .textAlign(TextAlign.Center)
                          .maxLines(2)
                      }
                      .width('100%')
                      .height(100)
                      .justifyContent(FlexAlign.Center)
                      .alignItems(HorizontalAlign.Center)
                      .backgroundColor(Color.White)
                      .borderRadius(12)
                      .border({ width: 1, color: '#F0F0F0' })
                      .onClick(() => {
                        this.navigateToTool(tool.id);
                      })
                    }
                  })
                }
                .columnsTemplate('1fr 1fr')
                .rowsGap(12)
                .columnsGap(12)
                .height(324)
              }
              .width('100%')
              .padding({
                left: 20,
                right: 20,
                top: 20,
                bottom: 20
              })
              .backgroundColor('#F8F9FA')
              .margin({ top: 12 })

              // è½®æ’­å›¾
              Column() {
                Swiper() {
                  ForEach(this.bannerItems, (banner: BannerItem) => {
                    Column() {
                      Row() {
                        Column() {
                          Text(banner.title)
                            .fontSize(18)
                            .fontWeight(FontWeight.Bold)
                            .fontColor(banner.textColor)
                            .margin({ bottom: 4 })

                          Text(banner.subtitle)
                            .fontSize(14)
                            .fontColor(banner.textColor)
                            .opacity(0.9)
                            .margin({ bottom: 8 })

                          Text(banner.description)
                            .fontSize(12)
                            .fontColor(banner.textColor)
                            .opacity(0.8)
                            .maxLines(2)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .margin({ bottom: 12 })

                          if (banner.actionText) {
                            Text(banner.actionText)
                              .fontSize(12)
                              .height(32)
                              .backgroundColor(Color.White)
                              .fontColor(banner.backgroundColor)
                              .borderRadius(16)
                              .padding({
                                left: 16,
                                right: 16,
                                top: 6,
                                bottom: 6
                              })
                              .textAlign(TextAlign.Center)
                          }
                        }
                        .layoutWeight(1)
                        .alignItems(HorizontalAlign.Start)

                        Text(banner.icon)
                          .fontSize(48)
                          .margin({ left: 16 })
                      }
                      .width('100%')
                      .height('100%')
                      .padding(20)
                      .justifyContent(FlexAlign.SpaceBetween)
                      .alignItems(VerticalAlign.Center)
                    }
                    .width('100%')
                    .height(160)
                    .backgroundColor(banner.backgroundColor)
                    .borderRadius(12)
                    .onClick(() => {
                      this.handleBannerAction(banner.actionType || '');
                    })
                  })
                }
                .width('100%')
                .height(160)
                .autoPlay(true)
                .interval(4000)
                .indicator(true)
                .loop(true)
                .duration(300)
                .itemSpace(0)
                .indicatorStyle({
                  bottom: 12,
                  right: 12,
                  color: Color.White,
                  selectedColor: '#FFD700'
                })
                .onChange((index: number) => {
                  this.currentBannerIndex = index;
                })
              }
              .width('100%')
              .padding({top: 16, bottom: 16, left: 20, right: 20})
              .margin({ bottom: 8 })


              // çƒ­é—¨ç¤¼ç‰©æ¨è
              Column() {
                Row() {
                  Text('çƒ­é—¨ç¤¼ç‰©æ¨è')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                }
                .width('100%')
                .margin({ bottom: 16 })

                ForEach(this.giftRecommendations, (gift: GiftRecommendation) => {
                  Row() {
                    Column() {
                      Text(gift.title)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#333333')
                        .margin({ bottom: 4 })

                      Row() {
                        Text(gift.category)
                          .fontSize(12)
                          .fontColor('#666666')

                        Text('Â·')
                          .fontSize(12)
                          .fontColor('#CCCCCC')
                          .margin({ left: 8, right: 8 })

                        Text(gift.priceRange)
                          .fontSize(12)
                          .fontColor('#FF6B35')
                      }
                      .margin({ bottom: 8 })

                      Row() {
                        ForEach(gift.tags.slice(0, 3), (tag: string) => {
                          Text(tag)
                            .fontSize(10)
                            .fontColor('#666666')
                            .backgroundColor('#F0F0F0')
                            .borderRadius(8)
                            .padding({
                              left: 6,
                              right: 6,
                              top: 2,
                              bottom: 2
                            })
                            .margin({ right: 4 })
                        })
                      }
                    }
                    .layoutWeight(1)
                    .alignItems(HorizontalAlign.Start)

                    Column() {
                      Text(`${gift.popularity}%`)
                        .fontSize(16)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#FF6B35')

                      Text('çƒ­åº¦')
                        .fontSize(10)
                        .fontColor('#666666')
                    }
                    .alignItems(HorizontalAlign.Center)
                  }
                  .width('100%')
                  .padding({ top: 12, bottom: 12 })
                  .border({ width: { bottom: 1 }, color: '#F0F0F0' })
                  .onClick(() => {
                    this.navigateToGiftDetail(gift.id);
                  })
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .margin({ bottom: 8 })

            }
          }
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }

  // å¤„ç†è½®æ’­å›¾åŠ¨ä½œ
  private handleBannerAction(actionType: string): void {
    switch (actionType) {
      case 'recommendation':
        router.pushUrl({
          url: 'pages/tools/SmartRecommendationPage'
        });
        break;
      case 'guide':
        router.pushUrl({
          url: 'pages/tools/HolidayGuidePage'
        });
        break;
      case 'budget':
        router.pushUrl({
          url: 'pages/tools/BudgetCalculatorPage'
        });
        break;
      case 'customize':
        console.info('ä¸ªæ€§åŒ–å®šåˆ¶');
        break;
      default:
        break;
    }
  }

  // å¯¼èˆªåˆ°æ¨èé¡µé¢
  private navigateToRecommendations(): void {
    console.info('å¯¼èˆªåˆ°æ¨èé¡µé¢');
  }

  // å¯¼èˆªåˆ°ç¤¼ç‰©è¯¦æƒ…
  private navigateToGiftDetail(giftId: string): void {
    console.info('å¯¼èˆªåˆ°ç¤¼ç‰©è¯¦æƒ…:', giftId);
  }
}