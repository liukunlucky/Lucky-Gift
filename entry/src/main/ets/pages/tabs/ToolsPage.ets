import router from '@ohos.router';
import { BudgetCalculation, HolidayCountdown } from '../../model/NewDataModels';
import { ToolsDAO } from '../../database/ToolsDAO';
import { NewDatabaseManager } from '../../database/NewDatabaseManager';

// æ¸…å•é¡¹ç›®æŽ¥å£
interface ChecklistItem {
  id: string;
  title: string;
  description?: string;
  isCompleted?: boolean;
  isChecked?: boolean;
  category: string;
  priority?: 'high' | 'medium' | 'low';
  createdAt: string;
  orderIndex?: number;
  isDefault?: boolean;
}

// å·¥å…·èœå•æŽ¥å£
interface ToolMenu {
  id: string;
  title: string;
  description: string;
  icon: string;
  color: string;
}

@Component
export struct ToolsPage {
  @State checklistItems: ChecklistItem[] = [];
  @State budgetCalculations: BudgetCalculation[] = [];
  @State upcomingHolidays: HolidayCountdown[] = [];
  @State isLoading: boolean = true;
  @State showBudgetCalculator: boolean = false;
  @State totalBudget: string = '';
  @State numberOfPeople: string = '';
  @State calculatedResult: number = 0;
  @State completedCount: number = 0;
  @State totalCount: number = 0;
  
  private dbManager = new NewDatabaseManager();
  private toolsDAO: ToolsDAO = new ToolsDAO(this.dbManager);
  
  // å·¥å…·èœå•é…ç½®
  private toolMenus: ToolMenu[] = [
    {
      id: 'checklist',
      title: 'ç¤¼ç‰©æ¸…å•æ£€æŸ¥',
      description: 'ç¡®ä¿é€ç¤¼ä¸‡æ— ä¸€å¤±',
      icon: 'âœ…',
      color: '#4CAF50'
    },
    {
      id: 'giftcard',
      title: 'ç¤¼ç‰©å¡åˆ¶ä½œå™¨',
      description: 'åˆ¶ä½œç²¾ç¾Žçš„ç¤¼ç‰©å¡ç‰‡',
      icon: 'ðŸ’Œ',
      color: '#E91E63'
    },
    {
      id: 'budget',
      title: 'é¢„ç®—è®¡ç®—å™¨',
      description: 'åˆç†åˆ†é…é€ç¤¼é¢„ç®—',
      icon: 'ðŸ’°',
      color: '#FF9800'
    },
    {
      id: 'countdown',
      title: 'èŠ‚æ—¥å€’è®¡æ—¶',
      description: 'ä¸é”™è¿‡é‡è¦èŠ‚æ—¥',
      icon: 'ðŸ“…',
      color: '#2196F3'
    }
  ];

  aboutToAppear() {
    this.loadData();
  }

  async loadData() {
    try {
      this.isLoading = true;
      
      // åŠ è½½æ£€æŸ¥æ¸…å•ï¼ˆä½¿ç”¨é»˜è®¤æ•°æ®ï¼‰
      this.checklistItems = this.getDefaultChecklistItems();
      
      // åŠ è½½é¢„ç®—è®¡ç®—è®°å½•
      this.budgetCalculations = await this.toolsDAO.getAllBudgetCalculations();
      
      // åŠ è½½å³å°†åˆ°æ¥çš„èŠ‚æ—¥
      this.upcomingHolidays = await this.toolsDAO.getUpcomingHolidays(30);
      
      // æ›´æ–°è®¡æ•°
      this.updateCounts();
    } catch (error) {
      console.error('åŠ è½½å·¥å…·æ•°æ®å¤±è´¥:', error);
      this.checklistItems = this.getDefaultChecklistItems();
      this.upcomingHolidays = [];
      this.updateCounts();
    } finally {
      this.isLoading = false;
    }
  }

  // èŽ·å–é»˜è®¤æ£€æŸ¥æ¸…å•
  getDefaultChecklistItems(): ChecklistItem[] {
    return [
      {
        id: '1',
        category: 'å‡†å¤‡é˜¶æ®µ',
        title: 'äº†è§£æ”¶ç¤¼äººçš„å–œå¥½',
        description: 'è¯¢é—®æœ‹å‹æˆ–è§‚å¯ŸTAçš„å…´è¶£çˆ±å¥½',
        orderIndex: 1,
        isDefault: true,
        createdAt: new Date().toISOString()
      },
      {
        id: '2',
        category: 'å‡†å¤‡é˜¶æ®µ',
        title: 'ç¡®å®šé¢„ç®—èŒƒå›´',
        description: 'æ ¹æ®å…³ç³»äº²å¯†åº¦å’Œç»æµŽèƒ½åŠ›è®¾å®šé¢„ç®—',
        orderIndex: 2,
        isDefault: true,
        createdAt: new Date().toISOString()
      },
      {
        id: '3',
        category: 'é€‰æ‹©é˜¶æ®µ',
        title: 'é€‰æ‹©åˆé€‚çš„ç¤¼ç‰©',
        description: 'ç»“åˆå–œå¥½ã€é¢„ç®—å’Œåœºåˆé€‰æ‹©ç¤¼ç‰©',
        orderIndex: 3,
        isDefault: true,
        createdAt: new Date().toISOString()
      },
      {
        id: '4',
        category: 'é€‰æ‹©é˜¶æ®µ',
        title: 'è€ƒè™‘ç¤¼ç‰©çš„å®žç”¨æ€§',
        description: 'ç¡®ä¿ç¤¼ç‰©å¯¹æ”¶ç¤¼äººæœ‰å®žé™…ä»·å€¼',
        orderIndex: 4,
        isDefault: true,
        createdAt: new Date().toISOString()
      },
      {
        id: '5',
        category: 'è´­ä¹°é˜¶æ®µ',
        title: 'æ¯”è¾ƒä»·æ ¼å’Œè´¨é‡',
        description: 'åœ¨å¤šä¸ªæ¸ é“å¯¹æ¯”ï¼Œé€‰æ‹©æ€§ä»·æ¯”æœ€é«˜çš„',
        orderIndex: 5,
        isDefault: true,
        createdAt: new Date().toISOString()
      },
      {
        id: '6',
        category: 'åŒ…è£…é˜¶æ®µ',
        title: 'ç²¾å¿ƒåŒ…è£…ç¤¼ç‰©',
        description: 'é€‰æ‹©åˆé€‚çš„åŒ…è£…çº¸å’Œè£…é¥°',
        orderIndex: 6,
        isDefault: true,
        createdAt: new Date().toISOString()
      },
      {
        id: '7',
        category: 'åŒ…è£…é˜¶æ®µ',
        title: 'å‡†å¤‡è´ºå¡æˆ–ç¥ç¦è¯­',
        description: 'å†™ä¸‹çœŸè¯šçš„ç¥ç¦å’Œå¿ƒæ„',
        orderIndex: 7,
        isDefault: true,
        createdAt: new Date().toISOString()
      },
      {
        id: '8',
        category: 'é€ç¤¼é˜¶æ®µ',
        title: 'é€‰æ‹©åˆé€‚çš„é€ç¤¼æ—¶æœº',
        description: 'åœ¨åˆé€‚çš„æ—¶é—´å’Œåœºåˆé€å‡ºç¤¼ç‰©',
        orderIndex: 8,
        isDefault: true,
        createdAt: new Date().toISOString()
      }
    ];
  }

  // æ›´æ–°è®¡æ•°
  updateCounts() {
    this.completedCount = this.checklistItems.filter(item => item.isChecked).length;
    this.totalCount = this.checklistItems.length;
  }

  // åˆ‡æ¢æ£€æŸ¥æ¸…å•é¡¹çŠ¶æ€
  toggleChecklistItem(item: ChecklistItem) {
    // æ›´æ–°æœ¬åœ°çŠ¶æ€
    const index = this.checklistItems.findIndex(i => i.id === item.id);
    if (index !== -1) {
      this.checklistItems[index].isChecked = !item.isChecked;
      this.updateCounts();
    }
  }

  // é‡ç½®æ£€æŸ¥æ¸…å•
  resetChecklist() {
    this.checklistItems.forEach(item => {
      item.isChecked = false;
    });
    this.updateCounts();
  }

  // è®¡ç®—é¢„ç®—
  calculateBudget() {
    const total = parseFloat(this.totalBudget);
    const people = parseInt(this.numberOfPeople);
    
    if (total > 0 && people > 0) {
      this.calculatedResult = total / people;
    } else {
      this.calculatedResult = 0;
    }
  }

  // ä¿å­˜é¢„ç®—è®¡ç®—
  async saveBudgetCalculation() {
    if (this.calculatedResult > 0) {
      try {
        const calculation: BudgetCalculation = {
          id: "",
          name: `${this.numberOfPeople}äººé¢„ç®—åˆ†é…`,
          title: `${this.numberOfPeople}äººé¢„ç®—åˆ†é…`,
          totalBudget: parseFloat(this.totalBudget),
          numberOfPeople: parseInt(this.numberOfPeople),
          budgetPerPerson: this.calculatedResult,
          items: [],
          createdAt: ""
        };
        
        await this.toolsDAO.createBudgetCalculation(calculation);
        this.budgetCalculations = await this.toolsDAO.getAllBudgetCalculations();
        
        // é‡ç½®è¡¨å•
        this.totalBudget = '';
        this.numberOfPeople = '';
        this.calculatedResult = 0;
        this.showBudgetCalculator = false;
      } catch (error) {
        console.error('ä¿å­˜é¢„ç®—è®¡ç®—å¤±è´¥:', error);
      }
    }
  }

  // å¯¼èˆªåˆ°å·¥å…·é¡µé¢
  navigateToTool(toolId: string) {
    switch (toolId) {
      case 'checklist':
        // æ˜¾ç¤ºæ£€æŸ¥æ¸…å•è¯¦æƒ…
        break;
      case 'giftcard':
        router.pushUrl({
          url: 'pages/tools/GiftCardMakerPage'
        });
        break;
      case 'budget':
        router.pushUrl({
          url: 'pages/tools/BudgetCalculatorPage'
        });
        break;
      case 'countdown':
        router.pushUrl({
          url: 'pages/tools/HolidayCountdownPage'
        });
        break;
    }
  }

  navigateToGiftCardMaker() {
    router.pushUrl({
      url: 'pages/tools/GiftCardMakerPage'
    });
  }
  
  navigateToBudgetCalculator() {
    router.pushUrl({
      url: 'pages/tools/BudgetCalculatorPage'
    });
  }
  
  navigateToHolidayCountdown() {
    router.pushUrl({
      url: 'pages/tools/HolidayCountdownPage'
    });
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}æœˆ${day}æ—¥`;
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Row() {
        Text('å·¥å…·ç™¾å®ç®±')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
        
        Blank()
        
        Text('è®©é€ç¤¼æ›´è½»æ¾')
          .fontSize(14)
          .fontColor('#666666')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor(Color.White)

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#FF6B35')
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('60%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        Scroll() {
          Column() {
            // å·¥å…·èœå•
            Column() {
              Text('å®žç”¨å·¥å…·')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .margin({ bottom: 16 })
                .alignSelf(ItemAlign.Start)
              
              Grid() {
                ForEach(this.toolMenus, (tool: ToolMenu) => {
                  GridItem() {
                    Column() {
                      Text(tool.icon)
                        .fontSize(32)
                        .margin({ bottom: 8 })
                      
                      Text(tool.title)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#333333')
                        .margin({ bottom: 4 })
                      
                      Text(tool.description)
                        .fontSize(11)
                        .fontColor('#666666')
                        .textAlign(TextAlign.Center)
                        .maxLines(2)
                    }
                    .width('100%')
                    .height(120)
                    .justifyContent(FlexAlign.Center)
                    .alignItems(HorizontalAlign.Center)
                    .backgroundColor(Color.White)
                    .borderRadius(12)
                    .border({ width: 1, color: '#F0F0F0' })
                    .onClick(() => {
                      this.navigateToTool(tool.id);
                    })
                  }
                })
              }
              .columnsTemplate('1fr 1fr')
              .rowsGap(12)
              .columnsGap(12)
              .height(250)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#F8F9FA')
            .margin({ bottom: 8 })

            // å¿«é€Ÿæ£€æŸ¥æ¸…å•
            Column() {
              Row() {
                Text('é€ç¤¼æ£€æŸ¥æ¸…å•')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                
                Blank()
                
                Button('é‡ç½®')
                  .fontSize(12)
                  .height(28)
                  .backgroundColor('#F0F0F0')
                  .fontColor('#666666')
                  .borderRadius(14)
                  .onClick(() => {
                    this.resetChecklist();
                  })
              }
              .width('100%')
              .margin({ bottom: 16 })
              
              // è¿›åº¦æ¡
              Row() {
                Progress({ 
                  value: this.completedCount, 
                  total: this.totalCount, 
                  type: ProgressType.Linear 
                })
                  .layoutWeight(1)
                  .color('#FF6B35')
                  .backgroundColor('#F0F0F0')
                  .height(6)
                
                Text(`${this.completedCount}/${this.totalCount}`)
                  .fontSize(12)
                  .fontColor('#666666')
                  .margin({ left: 12 })
              }
              .width('100%')
              .margin({ bottom: 16 })
              
              // æ£€æŸ¥æ¸…å•é¡¹
              ForEach(this.checklistItems.slice(0, 5), (item: ChecklistItem) => {
                Row() {
                  Checkbox({ name: item.id, group: 'checklist' })
                    .select(item.isChecked)
                    .selectedColor('#FF6B35')
                    .onChange((value: boolean) => {
                      this.toggleChecklistItem(item);
                    })
                  
                  Column() {
                    Text(item.title)
                      .fontSize(14)
                      .fontColor(item.isChecked ? '#999999' : '#333333')
                      .decoration({ type: item.isChecked ? TextDecorationType.LineThrough : TextDecorationType.None })
                    
                    if (item.description) {
                      Text(item.description)
                        .fontSize(12)
                        .fontColor('#666666')
                        .margin({ top: 2 })
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                    }
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                  .margin({ left: 12 })
                }
                .width('100%')
                .padding({ top: 8, bottom: 8 })
                .alignItems(VerticalAlign.Top)
              })
              
              if (this.checklistItems.length > 5) {
                Button(`æŸ¥çœ‹å…¨éƒ¨ ${this.checklistItems.length} é¡¹`)
                  .fontSize(12)
                  .height(32)
                  .backgroundColor('#F0F0F0')
                  .fontColor('#666666')
                  .borderRadius(16)
                  .margin({ top: 8 })
                  .onClick(() => {
                    router.pushUrl({
                      url: 'pages/ChecklistDetailPage'
                    });
                  })
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 8 })

            // å³å°†åˆ°æ¥çš„èŠ‚æ—¥
            if (this.upcomingHolidays.length > 0) {
              Column() {
                Text('å³å°†åˆ°æ¥çš„èŠ‚æ—¥')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .margin({ bottom: 16 })
                  .alignSelf(ItemAlign.Start)
                
                ForEach(this.upcomingHolidays.slice(0, 3), (holiday: HolidayCountdown) => {
                  Row() {
                    Column() {
                      Text(holiday.name)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#333333')
                      
                      Text(this.formatDate(holiday.date))
                        .fontSize(12)
                        .fontColor('#666666')
                        .margin({ top: 2 })
                    }
                    .alignItems(HorizontalAlign.Start)
                    
                    Blank()
                    
                    Column() {
                      Text(`${holiday.daysUntil || 0}`)
                        .fontSize(18)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#FF6B35')
                      
                      Text('å¤©')
                        .fontSize(12)
                        .fontColor('#666666')
                    }
                    .alignItems(HorizontalAlign.Center)
                  }
                  .width('100%')
                  .padding({ top: 12, bottom: 12 })
                  .border({ width: { bottom: 1 }, color: '#F0F0F0' })
                })
                
                Button('æŸ¥çœ‹æ›´å¤šèŠ‚æ—¥')
                  .fontSize(12)
                  .height(32)
                  .backgroundColor('#F0F0F0')
                  .fontColor('#666666')
                  .borderRadius(16)
                  .margin({ top: 12 })
                  .onClick(() => {
                    this.navigateToTool('countdown');
                  })
              }
              .width('100%')
              .padding(16)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .margin({ bottom: 8 })
            }

            // æœ€è¿‘çš„é¢„ç®—è®¡ç®—
            if (this.budgetCalculations.length > 0) {
              Column() {
                Text('æœ€è¿‘çš„é¢„ç®—è®¡ç®—')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .margin({ bottom: 16 })
                  .alignSelf(ItemAlign.Start)
                
                ForEach(this.budgetCalculations.slice(0, 3), (calculation: BudgetCalculation) => {
                  Row() {
                    Column() {
                      Text(calculation.title || 'é¢„ç®—è®¡ç®—')
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#333333')
                      
                      Text(`æ€»é¢„ç®— Â¥${calculation.totalBudget} Â· ${calculation.numberOfPeople}äºº`)
                        .fontSize(12)
                        .fontColor('#666666')
                        .margin({ top: 2 })
                    }
                    .alignItems(HorizontalAlign.Start)
                    
                    Blank()
                    
                    Text(`Â¥${calculation.budgetPerPerson?.toFixed(0)}/äºº`)
                      .fontSize(14)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#FF6B35')
                  }
                  .width('100%')
                  .padding({ top: 12, bottom: 12 })
                  .border({ width: { bottom: 1 }, color: '#F0F0F0' })
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .margin({ bottom: 20 })
            }
          }
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
    .bindSheet($$this.showBudgetCalculator, this.buildBudgetCalculatorDialog(), {
      height: 400,
      dragBar: true
    })
  }

  @Builder
  buildBudgetCalculatorDialog() {
    Column() {
      Text('é¢„ç®—è®¡ç®—å™¨')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 24 })
      
      // æ€»é¢„ç®—è¾“å…¥
      Column() {
        Text('æ€»é¢„ç®—ï¼ˆå…ƒï¼‰')
          .fontSize(14)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
        
        TextInput({ placeholder: 'è¯·è¾“å…¥æ€»é¢„ç®—é‡‘é¢' })
          .type(InputType.Number)
          .height(44)
          .borderRadius(8)
          .backgroundColor('#F8F9FA')
          .onChange((value: string) => {
            this.totalBudget = value;
            this.calculateBudget();
          })
      }
      .width('100%')
      .margin({ bottom: 16 })
      
      // äººæ•°è¾“å…¥
      Column() {
        Text('äººæ•°')
          .fontSize(14)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
        
        TextInput({ placeholder: 'è¯·è¾“å…¥äººæ•°' })
          .type(InputType.Number)
          .height(44)
          .borderRadius(8)
          .backgroundColor('#F8F9FA')
          .onChange((value: string) => {
            this.numberOfPeople = value;
            this.calculateBudget();
          })
      }
      .width('100%')
      .margin({ bottom: 24 })
      
      // è®¡ç®—ç»“æžœ
      if (this.calculatedResult > 0) {
        Column() {
          Text('æ¯äººé¢„ç®—')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ bottom: 8 })
          
          Text(`Â¥${this.calculatedResult.toFixed(2)}`)
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B35')
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#FFF0ED')
        .borderRadius(8)
        .margin({ bottom: 24 })
      }
      
      // æ“ä½œæŒ‰é’®
      Row() {
        Button('å–æ¶ˆ')
          .layoutWeight(1)
          .height(44)
          .backgroundColor('#F0F0F0')
          .fontColor('#333333')
          .borderRadius(22)
          .margin({ right: 8 })
          .onClick(() => {
            this.showBudgetCalculator = false;
            this.totalBudget = '';
            this.numberOfPeople = '';
            this.calculatedResult = 0;
          })
        
        Button('ä¿å­˜')
          .layoutWeight(1)
          .height(44)
          .backgroundColor('#FF6B35')
          .fontColor(Color.White)
          .borderRadius(22)
          .margin({ left: 8 })
          .enabled(this.calculatedResult > 0)
          .onClick(() => {
            this.saveBudgetCalculation();
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(24)
  }
}