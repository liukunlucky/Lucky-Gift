import router from '@ohos.router';
import { Inspiration } from '../../model/NewDataModels';
import { InspirationDAO } from '../../database/InspirationDAO';
import { NewDatabaseManager } from '../../database/NewDatabaseManager';
import { InspirationDataInitializer } from '../../database/InspirationDataInitializer';

// å¿«é€Ÿç­›é€‰å™¨æŽ¥å£
interface QuickFilter {
  label: string;
  type: string;
  value: string;
}

// åˆ†ç±»å¯¼èˆªæŽ¥å£
interface Category {
  title: string;
  icon: string;
  items: string[];
}

@Component
export struct BrowsePage {
  @State inspirations: Inspiration[] = [];
  @State filteredInspirations: Inspiration[] = [];
  @State selectedFilters: string[] = [];
  @State searchKeyword: string = '';
  @State isLoading: boolean = true;
  
  private dbManager = new NewDatabaseManager();
  private inspirationDAO: InspirationDAO = new InspirationDAO(this.dbManager);
  private dataInitializer: InspirationDataInitializer = new InspirationDataInitializer();
  
  // å¿«é€Ÿç­›é€‰å™¨é…ç½®
  private quickFilters: QuickFilter[] = [
    { label: 'ç”Ÿæ—¥', type: 'occasion', value: 'ç”Ÿæ—¥' },
    { label: 'çˆ¶æ¯', type: 'audience', value: 'çˆ¶æ¯' },
    { label: '500å…ƒå†…', type: 'budget', value: '500' },
    { label: 'æ‹äºº', type: 'audience', value: 'æ‹äºº' },
    { label: 'çºªå¿µæ—¥', type: 'occasion', value: 'çºªå¿µæ—¥' },
    { label: 'DIY', type: 'type', value: 'DIYæ‰‹ä½œ' }
  ];
  
  // åˆ†ç±»å¯¼èˆªé…ç½®
  private categories: Category[] = [
    { 
      title: 'æŒ‰å¯¹è±¡é€', 
      icon: 'ðŸ‘¥', 
      items: ['çˆ¶æ¯', 'æ‹äºº', 'æœ‹å‹', 'åŒäº‹', 'å­©å­', 'é•¿è¾ˆ', 'è€å¸ˆ', 'å®¢æˆ·']
    },
    { 
      title: 'æŒ‰åœºåˆé€', 
      icon: 'ðŸŽ‰', 
      items: ['ç”Ÿæ—¥', 'çºªå¿µæ—¥', 'å©šç¤¼', 'èŠ‚æ—¥', 'æ¯•ä¸š', 'é“æ­‰', 'æ„Ÿè°¢', 'åº†ç¥']
    },
    { 
      title: 'æŒ‰å…´è¶£é€', 
      icon: 'ðŸŽ¯', 
      items: ['ç¾Žé£Ÿå®¶', 'è¯»ä¹¦äºº', 'ç§‘æŠ€è¿·', 'æ—…è¡Œå®¶', 'å¥èº«è¾¾äºº', 'è‰ºæœ¯çˆ±å¥½è€…', 'éŸ³ä¹è¿·', 'æ¸¸æˆçŽ©å®¶']
    },
    { 
      title: 'æŒ‰é¢„ç®—é€', 
      icon: 'ðŸ’°', 
      items: ['50å…ƒä»¥ä¸‹', '50-200å…ƒ', '200-500å…ƒ', '500-1000å…ƒ', '1000å…ƒä»¥ä¸Š']
    },
    { 
      title: 'æŒ‰ç±»åž‹é€', 
      icon: 'ðŸŽ', 
      items: ['DIYæ‰‹ä½œ', 'ä½“éªŒä¹‹æ—…', 'è´´å¿ƒæ—¥ç”¨', 'æžæ€ªæƒŠå–œ', 'ç§‘æŠ€æ•°ç ', 'ç¾Žå¦†æŠ¤è‚¤', 'ä¹¦ç±æ–‡å…·', 'è¿åŠ¨æˆ·å¤–']
    }
  ];

  aboutToAppear() {
    this.loadInspirations();
  }

  async loadInspirations() {
    try {
      this.isLoading = true;
      
      // åˆå§‹åŒ–é¢„ç½®æ•°æ®ï¼ˆå¦‚æžœéœ€è¦ï¼‰
      await this.dataInitializer.initializeAllData();
      
      this.inspirations = await this.inspirationDAO.getAllInspirations();
      
      // å¦‚æžœæ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é¢„ç½®æ•°æ®
      if (this.inspirations.length === 0) {
        this.inspirations = this.getMockInspirations();
      }
      
      this.filteredInspirations = this.inspirations;
    } catch (error) {
      console.error('åŠ è½½çµæ„Ÿæ•°æ®å¤±è´¥:', error);
      // å¦‚æžœæ•°æ®åº“ä¸ºç©ºï¼Œæ˜¾ç¤ºç¤ºä¾‹æ•°æ®
      this.inspirations = this.getMockInspirations();
      this.filteredInspirations = this.inspirations;
    } finally {
      this.isLoading = false;
    }
  }

  // èŽ·å–ç¤ºä¾‹çµæ„Ÿæ•°æ®
  getMockInspirations(): Inspiration[] {
    return [
      {
        id: '1',
        title: 'ä¸ºå¥¹å®šåˆ¶ä¸€æœ¬ä¸“å±žæ•…äº‹ä¹¦',
        description: 'æ”¶é›†ä½ ä»¬çš„ç¾Žå¥½å›žå¿†ï¼Œåˆ¶ä½œæˆç²¾ç¾Žçš„æ•…äº‹ä¹¦',
        detailedDescription: 'è¿™æ˜¯ä¸€ä»½å……æ»¡çˆ±æ„çš„ç¤¼ç‰©ï¼Œå°†ä½ ä»¬çš„ç‚¹ç‚¹æ»´æ»´è®°å½•ä¸‹æ¥ï¼Œåˆ¶ä½œæˆç‹¬ä¸€æ— äºŒçš„æ•…äº‹ä¹¦ã€‚å¯ä»¥åŒ…å«ç…§ç‰‡ã€æ–‡å­—ã€æ‰‹ç»˜æ’ç”»ç­‰å…ƒç´ ã€‚',
        images: ['/common/images/story_book.jpg'],
        tags: ['æµªæ¼«', 'çºªå¿µ', 'å®šåˆ¶', 'DIY'],
        targetAudience: ['æ‹äºº'],
        occasions: ['çºªå¿µæ—¥', 'ç”Ÿæ—¥', 'æƒ…äººèŠ‚'],
        interests: ['é˜…è¯»', 'è‰ºæœ¯'],
        budgetRange: { min: 200, max: 500, label: '200-500å…ƒ' },
        giftType: 'DIYæ‰‹ä½œ',
        difficulty: 'medium',
        timeRequired: '3-5å¤©',
        materials: ['ç›¸å†Œ', 'æ‰“å°ç…§ç‰‡', 'å½©ç¬”', 'è£…é¥°è´´çº¸'],
        steps: ['æ”¶é›†ç…§ç‰‡å’Œå›žå¿†', 'è®¾è®¡é¡µé¢å¸ƒå±€', 'æ‰“å°å’Œè£…è®¢', 'æ·»åŠ è£…é¥°å…ƒç´ '],
        tips: ['æå‰å‡†å¤‡ç…§ç‰‡', 'æ³¨æ„æŽ’ç‰ˆç¾Žè§‚', 'å¯ä»¥åŠ å…¥æ‰‹å†™æ–‡å­—'],
        isRecommended: true,
        createdAt: '2024-01-01T00:00:00Z'
      },
      {
        id: '2',
        title: 'äº²æ‰‹åˆ¶ä½œå¦ˆå¦ˆçš„å…»ç”ŸèŒ¶åŒ…',
        description: 'æ ¹æ®å¦ˆå¦ˆçš„ä½“è´¨ï¼Œè°ƒé…ä¸“å±žçš„å…»ç”ŸèŒ¶',
        detailedDescription: 'ä¸ºå¦ˆå¦ˆç²¾å¿ƒè°ƒé…çš„å…»ç”ŸèŒ¶åŒ…ï¼Œæ—¢å®žç”¨åˆè´´å¿ƒã€‚å¯ä»¥æ ¹æ®å­£èŠ‚å’Œå¦ˆå¦ˆçš„èº«ä½“çŠ¶å†µé€‰æ‹©ä¸åŒçš„èŒ¶æã€‚',
        images: ['/common/images/tea_package.jpg'],
        tags: ['å…»ç”Ÿ', 'å¥åº·', 'æ‰‹ä½œ', 'è´´å¿ƒ'],
        targetAudience: ['çˆ¶æ¯'],
        occasions: ['ç”Ÿæ—¥', 'æ¯äº²èŠ‚', 'æ—¥å¸¸å…³æ€€'],
        interests: ['å…»ç”Ÿ', 'èŒ¶è‰º'],
        budgetRange: { min: 50, max: 200, label: '50-200å…ƒ' },
        giftType: 'DIYæ‰‹ä½œ',
        difficulty: 'easy',
        timeRequired: '1-2å¤©',
        materials: ['å„ç§èŒ¶å¶', 'å°å¸ƒè¢‹', 'æ ‡ç­¾', 'åŒ…è£…ç›’'],
        steps: ['äº†è§£å¦ˆå¦ˆä½“è´¨', 'é€‰æ‹©åˆé€‚èŒ¶æ', 'æŒ‰æ¯”ä¾‹è°ƒé…', 'åŒ…è£…æˆå°è¢‹'],
        tips: ['å’¨è¯¢ä¸­åŒ»å»ºè®®', 'æ³¨æ„èŒ¶ææ­é…', 'åˆ¶ä½œç²¾ç¾Žæ ‡ç­¾'],
        isRecommended: true,
        createdAt: '2024-01-02T00:00:00Z'
      },
      {
        id: '3',
        title: 'æ™ºèƒ½æ‰‹çŽ¯å¥åº·ç®¡å®¶',
        description: 'é€ç»™çˆ±è¿åŠ¨çš„æœ‹å‹ï¼Œç›‘æµ‹å¥åº·æ•°æ®',
        detailedDescription: 'çŽ°ä»£äººè¶Šæ¥è¶Šæ³¨é‡å¥åº·ï¼Œä¸€æ¬¾å¥½çš„æ™ºèƒ½æ‰‹çŽ¯å¯ä»¥å¸®åŠ©æœ‹å‹æ›´å¥½åœ°ç®¡ç†å¥åº·ï¼Œè®°å½•è¿åŠ¨æ•°æ®ã€‚',
        images: ['/common/images/smart_watch.jpg'],
        tags: ['ç§‘æŠ€', 'å¥åº·', 'è¿åŠ¨', 'å®žç”¨'],
        targetAudience: ['æœ‹å‹', 'åŒäº‹'],
        occasions: ['ç”Ÿæ—¥', 'æ¯•ä¸š', 'å‡èŒ'],
        interests: ['å¥èº«', 'ç§‘æŠ€'],
        budgetRange: { min: 500, max: 1000, label: '500-1000å…ƒ' },
        giftType: 'ç§‘æŠ€æ•°ç ',
        difficulty: 'easy',
        timeRequired: 'å³ä¹°å³é€',
        isRecommended: false,
        createdAt: '2024-01-03T00:00:00Z'
      }
    ];
  }

  // åº”ç”¨ç­›é€‰
  applyFilters() {
    let result = this.inspirations;
    
    // æœç´¢å…³é”®è¯ç­›é€‰
    if (this.searchKeyword.trim()) {
      const keyword = this.searchKeyword.toLowerCase();
      result = result.filter(item => 
        item.title.toLowerCase().includes(keyword) ||
        item.description.toLowerCase().includes(keyword) ||
        item.tags.some(tag => tag.toLowerCase().includes(keyword))
      );
    }
    
    // å¿«é€Ÿç­›é€‰å™¨
    this.selectedFilters.forEach(filter => {
      const filterConfig = this.quickFilters.find(f => f.label === filter);
      if (filterConfig) {
        switch (filterConfig.type) {
          case 'occasion':
            result = result.filter(item => item.occasions.includes(filterConfig.value));
            break;
          case 'audience':
            result = result.filter(item => item.targetAudience.includes(filterConfig.value));
            break;
          case 'budget':
            const budget = parseInt(filterConfig.value);
            result = result.filter(item => item.budgetRange.max <= budget);
            break;
          case 'type':
            result = result.filter(item => item.giftType === filterConfig.value);
            break;
        }
      }
    });
    
    this.filteredInspirations = result;
  }

  // åˆ‡æ¢ç­›é€‰å™¨
  toggleFilter(filterLabel: string) {
    const index = this.selectedFilters.indexOf(filterLabel);
    if (index > -1) {
      this.selectedFilters.splice(index, 1);
    } else {
      this.selectedFilters.push(filterLabel);
    }
    this.applyFilters();
  }

  // å¯¼èˆªåˆ°åˆ†ç±»é¡µé¢
  navigateToCategory(category: Category) {
    router.pushUrl({
      url: 'pages/CategoryPage',
      params: {
        category: category.title,
        items: category.items
      }
    });
  }

  // å¯¼èˆªåˆ°çµæ„Ÿè¯¦æƒ…é¡µ
  navigateToInspirationDetail(inspiration: Inspiration) {
    router.pushUrl({
      url: 'pages/InspirationDetailPage',
      params: {
        inspirationId: inspiration.id
      }
    });
  }

  // å¯¼èˆªåˆ°ç­›é€‰é¡µé¢
  navigateToFilter(filterType: string, filterValue: string, title?: string) {
    router.pushUrl({
      url: 'pages/tabs/InspirationFilterPage',
      params: {
        filterType: filterType,
        filterValue: filterValue,
        title: title || filterValue
      }
    });
  }

  build() {
    Column() {
      // é¡¶éƒ¨æœç´¢æ 
      Row() {
        TextInput({ placeholder: 'æœç´¢çµæ„Ÿåˆ›æ„...' })
          .layoutWeight(1)
          .height(40)
          .borderRadius(20)
          .backgroundColor('#F0F0F0')
          .padding({ left: 16, right: 16 })
          .onChange((value: string) => {
            this.searchKeyword = value;
            this.applyFilters();
          })
        
        Button('æœç´¢')
          .height(40)
          .margin({ left: 12 })
          .backgroundColor('#FF6B35')
          .borderRadius(20)
          .onClick(() => {
            this.applyFilters();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor(Color.White)

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#FF6B35')
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('60%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        Scroll() {
          Column() {
            // å¿«é€Ÿç­›é€‰å™¨
            Column() {
              Text('å¿«é€Ÿç­›é€‰')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .margin({ bottom: 12 })
                .alignSelf(ItemAlign.Start)
              
              Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
                ForEach(this.quickFilters, (filter: QuickFilter) => {
                  Button(filter.label)
                    .fontSize(12)
                    .height(32)
                    .padding({ left: 12, right: 12 })
                    .margin({ right: 8, bottom: 8 })
                    .backgroundColor(this.selectedFilters.includes(filter.label) ? '#FF6B35' : '#F0F0F0')
                    .fontColor(this.selectedFilters.includes(filter.label) ? Color.White : '#333333')
                    .borderRadius(16)
                    .onClick(() => {
                      this.navigateToFilter('quickFilter', filter.label);
                    })
                })
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .margin({ bottom: 8 })

            // åˆ†ç±»å¯¼èˆª
            Column() {
              Text('åˆ†ç±»æµè§ˆ')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .margin({ bottom: 12 })
                .alignSelf(ItemAlign.Start)
              
              Grid() {
                ForEach(this.categories, (category: Category) => {
                  GridItem() {
                    Column() {
                      Text(category.icon)
                        .fontSize(24)
                        .margin({ bottom: 8 })
                      
                      Text(category.title)
                        .fontSize(14)
                        .fontColor('#333333')
                        .textAlign(TextAlign.Center)
                    }
                    .width('100%')
                    .height(80)
                    .justifyContent(FlexAlign.Center)
                    .alignItems(HorizontalAlign.Center)
                    .backgroundColor('#F8F9FA')
                    .borderRadius(12)
                    .onClick(() => {
                      this.navigateToFilter('category', category.title);
                    })
                  }
                })
              }
              .columnsTemplate('1fr 1fr')
              .rowsGap(12)
              .columnsGap(12)
              .height(180)
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
            .margin({ bottom: 8 })

            // çµæ„ŸæŽ¨èåˆ—è¡¨
            Column() {
              Row() {
                Text('çµæ„ŸæŽ¨è')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                
                Blank()
                
                Text(`å…±${this.filteredInspirations.length}ä¸ªåˆ›æ„`)
                  .fontSize(12)
                  .fontColor('#666666')
              }
              .width('100%')
              .margin({ bottom: 12 })
              
              if (this.filteredInspirations.length === 0) {
                Column() {
                  Text('ðŸ”')
                    .fontSize(48)
                    .margin({ bottom: 12 })
                  
                  Text('æš‚æ— åŒ¹é…çš„çµæ„Ÿ')
                    .fontSize(16)
                    .fontColor('#666666')
                    .margin({ bottom: 8 })
                  
                  Text('è¯•è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…³é”®è¯')
                    .fontSize(14)
                    .fontColor('#999999')
                }
                .width('100%')
                .height(200)
                .justifyContent(FlexAlign.Center)
                .alignItems(HorizontalAlign.Center)
              } else {
                ForEach(this.filteredInspirations, (inspiration: Inspiration) => {
                  this.buildInspirationCard(inspiration)
                })
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor(Color.White)
          }
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }

  @Builder
  buildInspirationCard(inspiration: Inspiration) {
    Column() {
      Row() {
        Column() {
          Text(inspiration.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 8 })
          
          Text(inspiration.description)
            .fontSize(14)
            .fontColor('#666666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 12 })
          
          // æ ‡ç­¾
          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
            ForEach(inspiration.tags.slice(0, 3), (tag: string) => {
              Text(`#${tag}`)
                .fontSize(10)
                .fontColor('#FF6B35')
                .backgroundColor('#FFF0ED')
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius(4)
                .margin({ right: 4, bottom: 4 })
            })
          }
          
          // é¢„ç®—å’Œéš¾åº¦
          Row() {
            Text(inspiration.budgetRange.label)
              .fontSize(12)
              .fontColor('#FF6B35')
              .fontWeight(FontWeight.Medium)
            
            Text('|')
              .fontSize(12)
              .fontColor('#CCCCCC')
              .margin({ left: 8, right: 8 })
            
            Text(inspiration.difficulty === 'easy' ? 'ç®€å•' : inspiration.difficulty === 'medium' ? 'ä¸­ç­‰' : 'å›°éš¾')
              .fontSize(12)
              .fontColor('#666666')
          }
          .margin({ top: 8 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        
        // ç¼©ç•¥å›¾å ä½
        Column() {
          Text('ðŸŽ')
            .fontSize(32)
        }
        .width(80)
        .height(80)
        .backgroundColor('#F0F0F0')
        .borderRadius(8)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .margin({ left: 12 })
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .onClick(() => {
      this.navigateToInspirationDetail(inspiration);
    })
  }
}