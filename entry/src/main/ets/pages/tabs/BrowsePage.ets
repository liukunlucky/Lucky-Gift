import router from '@ohos.router';
import { Inspiration } from '../../model/NewDataModels';
import { InspirationDAO } from '../../database/InspirationDAO';
import { NewDatabaseManager } from '../../database/NewDatabaseManager';
import { InspirationDataInitializer } from '../../database/InspirationDataInitializer';
import { MockData } from '../../data/MockData';
import { common } from '@kit.AbilityKit';
import { 
  RecipientType, 
  OccasionType, 
  BudgetRange as BudgetRangeEnum, 
  GiftType,
  TagInfo,
  TagCategory,
  getTagInfo,
  getRecipientTypeName,
  getOccasionTypeName,
  getBudgetRangeName,
  getGiftTypeName,
  RecipientTypeNames,
  OccasionTypeNames,
  BudgetRangeNames,
  GiftTypeNames
} from '../../model/GiftEnums';
import { TagComponent } from '../../components/TagComponent';

// å¿«é€Ÿç­›é€‰å™¨æ¥å£
interface QuickFilter {
  label: string;
  category: TagCategory;
  value: string;
}

// Selectç»„ä»¶é€‰é¡¹æ¥å£
interface SelectOption {
  value: string;
}

// åˆ†ç±»å¯¼èˆªé¡¹æ¥å£
interface CategoryNavigationItem {
  label: string;
  category: TagCategory;
  value: string;
}

// åˆ†ç±»å¯¼èˆªæ¥å£
interface CategoryNavigation {
  icon: string;
  title: string;
  items: CategoryNavigationItem[];
}

// å¿«é€Ÿç­›é€‰å™¨æ¥å£ï¼ˆå…¼å®¹åŸæœ‰ï¼‰æœç´¢æ¡ä»¶æ¥å£
interface SearchCondition {
  id: string;
  label: string;
  type: string;
  options: SearchOption[];
  selectedValue?: string;
  selectedLabel?: string;
}

// æœç´¢é€‰é¡¹æ¥å£
interface SearchOption {
  label: string;
  value: string;
}



// åˆ†ç±»å¯¼èˆªæ¥å£ï¼ˆä¿ç•™å…¼å®¹ï¼‰
interface Category {
  title: string;
  icon: Resource;
  items: string[];
}

@Component
export struct BrowsePage {
  @State inspirations: Inspiration[] = [];
  @State filteredInspirations: Inspiration[] = [];
  @State selectedFilters: string[] = [];
  @State searchKeyword: string = '';
  @State isLoading: boolean = true;
  
  // æ–°å¢ï¼šå¤šç»´åº¦æœç´¢çŠ¶æ€
  @State searchConditions: SearchCondition[] = [];
  

  
  private dbManager: NewDatabaseManager | null = null;
  private inspirationDAO: InspirationDAO | null = null;
  private dataInitializer: InspirationDataInitializer = new InspirationDataInitializer();
  
  // çƒ­é—¨æ ‡ç­¾é…ç½®ï¼ˆä½¿ç”¨æ–°æšä¸¾ç³»ç»Ÿï¼‰
  private hotTags: QuickFilter[] = [
    { label: getOccasionTypeName(OccasionType.BIRTHDAY), category: TagCategory.OCCASION, value: OccasionType.BIRTHDAY },
    { label: getRecipientTypeName(RecipientType.BOYFRIEND), category: TagCategory.RECIPIENT, value: RecipientType.BOYFRIEND },
    { label: getGiftTypeName(GiftType.DIY_HANDMADE), category: TagCategory.GIFT_TYPE, value: GiftType.DIY_HANDMADE },
    { label: getBudgetRangeName(BudgetRangeEnum.RANGE_100_200), category: TagCategory.BUDGET, value: BudgetRangeEnum.RANGE_100_200 },
    { label: getOccasionTypeName(OccasionType.VALENTINE_DAY), category: TagCategory.OCCASION, value: OccasionType.VALENTINE_DAY },
    { label: getRecipientTypeName(RecipientType.FATHER), category: TagCategory.RECIPIENT, value: RecipientType.FATHER }
  ];

  // åˆ†ç±»å¯¼èˆªé…ç½®ï¼ˆä½¿ç”¨æ–°æšä¸¾ç³»ç»Ÿï¼‰
  private categoryNavigation: CategoryNavigation[] = [
    {
      icon: 'ğŸ‘¤',
      title: 'æŒ‰å¯¹è±¡',
      items: [
        { label: getRecipientTypeName(RecipientType.ELDER_RELATIVE), category: TagCategory.RECIPIENT, value: RecipientType.ELDER_RELATIVE },
        { label: getRecipientTypeName(RecipientType.BOYFRIEND), category: TagCategory.RECIPIENT, value: RecipientType.BOYFRIEND },
        { label: getRecipientTypeName(RecipientType.BESTIE), category: TagCategory.RECIPIENT, value: RecipientType.BESTIE },
        { label: getRecipientTypeName(RecipientType.COLLEAGUE), category: TagCategory.RECIPIENT, value: RecipientType.COLLEAGUE }
      ]
    },
    {
      icon: 'ğŸ‰',
      title: 'æŒ‰åœºåˆ',
      items: [
        { label: getOccasionTypeName(OccasionType.BIRTHDAY), category: TagCategory.OCCASION, value: OccasionType.BIRTHDAY },
        { label: getOccasionTypeName(OccasionType.VALENTINE_DAY), category: TagCategory.OCCASION, value: OccasionType.VALENTINE_DAY },
        { label: getOccasionTypeName(OccasionType.CHRISTMAS), category: TagCategory.OCCASION, value: OccasionType.CHRISTMAS },
        { label: getOccasionTypeName(OccasionType.ANNIVERSARY), category: TagCategory.OCCASION, value: OccasionType.ANNIVERSARY }
      ]
    },
    {
      icon: 'ğŸ',
      title: 'æŒ‰ç±»å‹',
      items: [
        { label: getGiftTypeName(GiftType.DIY_HANDMADE), category: TagCategory.GIFT_TYPE, value: GiftType.DIY_HANDMADE },
        { label: getGiftTypeName(GiftType.TECH_DIGITAL), category: TagCategory.GIFT_TYPE, value: GiftType.TECH_DIGITAL },
        { label: getOccasionTypeName(OccasionType.GRADUATION), category: TagCategory.OCCASION, value: OccasionType.GRADUATION },
        { label: getGiftTypeName(GiftType.BEAUTY_SKINCARE), category: TagCategory.GIFT_TYPE, value: GiftType.BEAUTY_SKINCARE }
      ]
    },
    {
      icon: 'ğŸ’°',
      title: 'æŒ‰é¢„ç®—',
      items: [
        { label: getBudgetRangeName(BudgetRangeEnum.UNDER_50), category: TagCategory.BUDGET, value: BudgetRangeEnum.UNDER_50 },
        { label: getBudgetRangeName(BudgetRangeEnum.RANGE_100_200), category: TagCategory.BUDGET, value: BudgetRangeEnum.RANGE_100_200 },
        { label: getBudgetRangeName(BudgetRangeEnum.RANGE_500_1000), category: TagCategory.BUDGET, value: BudgetRangeEnum.RANGE_500_1000 },
        { label: getBudgetRangeName(BudgetRangeEnum.OVER_2000), category: TagCategory.BUDGET, value: BudgetRangeEnum.OVER_2000 }
      ]
    }
  ];


  async aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®åº“
    const context = getContext(this) as common.UIAbilityContext;
    this.dbManager = new NewDatabaseManager();
    await this.dbManager.initDatabase(context);
    
    // åˆå§‹åŒ–DAO
    this.inspirationDAO = new InspirationDAO(this.dbManager);
    
    this.initializeSearchConditions();
    this.loadInspirations();
  }
  
  // åˆå§‹åŒ–æœç´¢æ¡ä»¶
  initializeSearchConditions() {
    this.searchConditions = [
      {
        id: 'audience',
        label: 'é€ç»™è°',
        type: 'audience',
        options: [
          { label: 'ä¸é™', value: '' },
          { label: RecipientTypeNames[RecipientType.FATHER], value: RecipientType.FATHER },
          { label: RecipientTypeNames[RecipientType.MOTHER], value: RecipientType.MOTHER },
          { label: RecipientTypeNames[RecipientType.GRANDFATHER], value: RecipientType.GRANDFATHER },
          { label: RecipientTypeNames[RecipientType.GRANDMOTHER], value: RecipientType.GRANDMOTHER },
          { label: RecipientTypeNames[RecipientType.ELDER_RELATIVE], value: RecipientType.ELDER_RELATIVE },
          { label: RecipientTypeNames[RecipientType.BOYFRIEND], value: RecipientType.BOYFRIEND },
          { label: RecipientTypeNames[RecipientType.GIRLFRIEND], value: RecipientType.GIRLFRIEND },
          { label: RecipientTypeNames[RecipientType.HUSBAND], value: RecipientType.HUSBAND },
          { label: RecipientTypeNames[RecipientType.WIFE], value: RecipientType.WIFE },
          { label: RecipientTypeNames[RecipientType.BESTIE], value: RecipientType.BESTIE },
          { label: RecipientTypeNames[RecipientType.FRIEND], value: RecipientType.FRIEND },
          { label: RecipientTypeNames[RecipientType.COLLEAGUE], value: RecipientType.COLLEAGUE },
          { label: RecipientTypeNames[RecipientType.BOSS], value: RecipientType.BOSS },
          { label: RecipientTypeNames[RecipientType.TEACHER], value: RecipientType.TEACHER },
          { label: RecipientTypeNames[RecipientType.CHILD], value: RecipientType.CHILD },
          { label: RecipientTypeNames[RecipientType.SIBLING], value: RecipientType.SIBLING },
          { label: RecipientTypeNames[RecipientType.CLASSMATE], value: RecipientType.CLASSMATE },
          { label: RecipientTypeNames[RecipientType.NEIGHBOR], value: RecipientType.NEIGHBOR },
          { label: RecipientTypeNames[RecipientType.CLIENT], value: RecipientType.CLIENT },
          { label: RecipientTypeNames[RecipientType.OTHER], value: RecipientType.OTHER }
        ]
      },
      {
        id: 'occasion',
        label: 'ä»€ä¹ˆåœºåˆ',
        type: 'occasion',
        options: [
          { label: 'ä¸é™', value: '' },
          { label: OccasionTypeNames[OccasionType.BIRTHDAY], value: OccasionType.BIRTHDAY },
          { label: OccasionTypeNames[OccasionType.ANNIVERSARY], value: OccasionType.ANNIVERSARY },
          { label: OccasionTypeNames[OccasionType.WEDDING_ANNIVERSARY], value: OccasionType.WEDDING_ANNIVERSARY },
          { label: OccasionTypeNames[OccasionType.VALENTINE_DAY], value: OccasionType.VALENTINE_DAY },
          { label: OccasionTypeNames[OccasionType.CHRISTMAS], value: OccasionType.CHRISTMAS },
          { label: OccasionTypeNames[OccasionType.NEW_YEAR], value: OccasionType.NEW_YEAR },
          { label: OccasionTypeNames[OccasionType.SPRING_FESTIVAL], value: OccasionType.SPRING_FESTIVAL },
          { label: OccasionTypeNames[OccasionType.MOTHERS_DAY], value: OccasionType.MOTHERS_DAY },
          { label: OccasionTypeNames[OccasionType.FATHERS_DAY], value: OccasionType.FATHERS_DAY },
          { label: OccasionTypeNames[OccasionType.TEACHERS_DAY], value: OccasionType.TEACHERS_DAY },
          { label: OccasionTypeNames[OccasionType.GRADUATION], value: OccasionType.GRADUATION },
          { label: OccasionTypeNames[OccasionType.PROMOTION], value: OccasionType.PROMOTION },
          { label: OccasionTypeNames[OccasionType.NEW_JOB], value: OccasionType.NEW_JOB },
          { label: OccasionTypeNames[OccasionType.HOUSEWARMING], value: OccasionType.HOUSEWARMING },
          { label: OccasionTypeNames[OccasionType.WEDDING], value: OccasionType.WEDDING },
          { label: OccasionTypeNames[OccasionType.BABY_SHOWER], value: OccasionType.BABY_SHOWER },
          { label: OccasionTypeNames[OccasionType.GET_WELL], value: OccasionType.GET_WELL },
          { label: OccasionTypeNames[OccasionType.APOLOGY], value: OccasionType.APOLOGY },
          { label: OccasionTypeNames[OccasionType.THANK_YOU], value: OccasionType.THANK_YOU },
          { label: OccasionTypeNames[OccasionType.ENCOURAGEMENT], value: OccasionType.ENCOURAGEMENT },
          { label: OccasionTypeNames[OccasionType.JUST_BECAUSE], value: OccasionType.JUST_BECAUSE },
          { label: OccasionTypeNames[OccasionType.OTHER], value: OccasionType.OTHER }
        ]
      },
      {
        id: 'budget',
        label: 'é¢„ç®—èŒƒå›´',
        type: 'budget',
        options: [
          { label: 'ä¸é™', value: '' },
          { label: BudgetRangeNames[BudgetRangeEnum.UNDER_50], value: BudgetRangeEnum.UNDER_50 },
          { label: BudgetRangeNames[BudgetRangeEnum.RANGE_50_100], value: BudgetRangeEnum.RANGE_50_100 },
          { label: BudgetRangeNames[BudgetRangeEnum.RANGE_100_200], value: BudgetRangeEnum.RANGE_100_200 },
          { label: BudgetRangeNames[BudgetRangeEnum.RANGE_200_500], value: BudgetRangeEnum.RANGE_200_500 },
          { label: BudgetRangeNames[BudgetRangeEnum.RANGE_500_1000], value: BudgetRangeEnum.RANGE_500_1000 },
          { label: BudgetRangeNames[BudgetRangeEnum.RANGE_1000_2000], value: BudgetRangeEnum.RANGE_1000_2000 },
          { label: BudgetRangeNames[BudgetRangeEnum.OVER_2000], value: BudgetRangeEnum.OVER_2000 }
        ]
      },
      {
        id: 'type',
        label: 'ç¤¼ç‰©ç±»å‹',
        type: 'type',
        options: [
          { label: 'ä¸é™', value: '' },
          { label: GiftTypeNames[GiftType.DIY_HANDMADE], value: GiftType.DIY_HANDMADE },
          { label: GiftTypeNames[GiftType.EXPERIENCE], value: GiftType.EXPERIENCE },
          { label: GiftTypeNames[GiftType.DAILY_ITEMS], value: GiftType.DAILY_ITEMS },
          { label: GiftTypeNames[GiftType.CREATIVE_NOVEL], value: GiftType.CREATIVE_NOVEL },
          { label: GiftTypeNames[GiftType.TECH_DIGITAL], value: GiftType.TECH_DIGITAL },
          { label: GiftTypeNames[GiftType.BEAUTY_SKINCARE], value: GiftType.BEAUTY_SKINCARE },
          { label: GiftTypeNames[GiftType.BOOKS_STATIONERY], value: GiftType.BOOKS_STATIONERY },
          { label: GiftTypeNames[GiftType.CLOTHING_ACCESSORIES], value: GiftType.CLOTHING_ACCESSORIES },
          { label: GiftTypeNames[GiftType.FOOD_BEVERAGE], value: GiftType.FOOD_BEVERAGE },
          { label: GiftTypeNames[GiftType.HOME_DECOR], value: GiftType.HOME_DECOR },
          { label: GiftTypeNames[GiftType.SPORTS_FITNESS], value: GiftType.SPORTS_FITNESS },
          { label: GiftTypeNames[GiftType.TRAVEL_OUTDOOR], value: GiftType.TRAVEL_OUTDOOR },
          { label: GiftTypeNames[GiftType.JEWELRY], value: GiftType.JEWELRY },
          { label: GiftTypeNames[GiftType.FLOWERS_PLANTS], value: GiftType.FLOWERS_PLANTS },
          { label: GiftTypeNames[GiftType.COLLECTIBLES], value: GiftType.COLLECTIBLES },
          { label: GiftTypeNames[GiftType.OTHER], value: GiftType.OTHER }
        ]
      }
    ];
  }

  async loadInspirations() {
    try {
      this.isLoading = true;
      
      if (!this.inspirationDAO) {
        console.error('æ•°æ®åº“æœªåˆå§‹åŒ–');
        this.inspirations = this.getMockInspirations();
        this.filteredInspirations = this.inspirations;
        return;
      }
      
      this.inspirations = await this.inspirationDAO.getAllInspirations();
      
      // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é¢„ç½®æ•°æ®
      if (this.inspirations.length === 0) {
        this.inspirations = this.getMockInspirations();
      }
      
      this.filteredInspirations = this.inspirations;
    } catch (error) {
      console.error('åŠ è½½çµæ„Ÿæ•°æ®å¤±è´¥:', error);
      // å¦‚æœæ•°æ®åº“ä¸ºç©ºï¼Œæ˜¾ç¤ºç¤ºä¾‹æ•°æ®
      this.inspirations = this.getMockInspirations();
      this.filteredInspirations = this.inspirations;
    } finally {
      this.isLoading = false;
    }
  }



  // è·å–ç¤ºä¾‹çµæ„Ÿæ•°æ®
  getMockInspirations(): Inspiration[] {
    return MockData.getAllInspirations();
  }

  // åº”ç”¨ç­›é€‰ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
  applyFilters() {
    let result = this.inspirations;
    
    // æœç´¢å…³é”®è¯ç­›é€‰
    if (this.searchKeyword.trim()) {
      const keyword = this.searchKeyword.toLowerCase();
      result = result.filter(item => 
        item.title.toLowerCase().includes(keyword) ||
        item.description.toLowerCase().includes(keyword) ||
        item.tags.some(tag => tag.toLowerCase().includes(keyword))
      );
    }
    
    // å¤šç»´åº¦æ¡ä»¶ç­›é€‰
    this.searchConditions.forEach(condition => {
      if (condition.selectedValue && condition.selectedValue !== '') {
        switch (condition.type) {
          case 'audience':
            // ç›´æ¥ç”¨æšä¸¾å€¼åœ¨tagså­—æ®µä¸­åŒ¹é…
            const recipientType = condition.selectedValue as RecipientType;
            result = result.filter(item => item.tags.includes(recipientType));
            break;
          case 'occasion':
            // ç›´æ¥ç”¨æšä¸¾å€¼åœ¨tagså­—æ®µä¸­åŒ¹é…
            const occasionType = condition.selectedValue as OccasionType;
            result = result.filter(item => item.tags.includes(occasionType));
            break;
          case 'budget':
            // ç›´æ¥ç”¨æšä¸¾å€¼åœ¨tagså­—æ®µä¸­åŒ¹é…
            const budgetRangeType = condition.selectedValue as BudgetRangeEnum;
            result = result.filter(item => item.tags.includes(budgetRangeType));
            break;
          case 'type':
            // ç›´æ¥ç”¨æšä¸¾å€¼åœ¨tagså­—æ®µä¸­åŒ¹é…
            const giftType = condition.selectedValue as GiftType;
            result = result.filter(item => item.tags.includes(giftType));
            break;
        }
      }
    });
    
    // å…¼å®¹åŸæœ‰çƒ­é—¨æ ‡ç­¾ç­›é€‰
    this.selectedFilters.forEach(filter => {
      const filterConfig = this.hotTags.find(f => f.label === filter);
      if (filterConfig) {
        switch (filterConfig.category) {
          case TagCategory.OCCASION:
            result = result.filter(item => item.occasions.includes(filterConfig.value));
            break;
          case TagCategory.RECIPIENT:
            result = result.filter(item => item.targetAudience.includes(filterConfig.value));
            break;
          case TagCategory.BUDGET:
            const budget = parseInt(filterConfig.value);
            result = result.filter(item => item.budgetRange.max <= budget);
            break;
          case TagCategory.GIFT_TYPE:
            result = result.filter(item => item.giftType === filterConfig.value);
            break;
        }
      }
    });
    
    this.filteredInspirations = result;
  }
  

  
  // é€‰æ‹©æœç´¢æ¡ä»¶
  selectSearchOption(conditionId: string, option: SearchOption) {
    const conditionIndex = this.searchConditions.findIndex(c => c.id === conditionId);
    if (conditionIndex !== -1) {
      // åˆ›å»ºæ–°çš„æ•°ç»„æ¥è§¦å‘çŠ¶æ€æ›´æ–°
      const newConditions: SearchCondition[] = [];
      for (let i = 0; i < this.searchConditions.length; i++) {
        if (i === conditionIndex) {
          const updatedCondition: SearchCondition = {
            id: this.searchConditions[i].id,
            label: this.searchConditions[i].label,
            type: this.searchConditions[i].type,
            options: this.searchConditions[i].options,
            selectedValue: option.value,
            selectedLabel: option.label
          };
          newConditions.push(updatedCondition);
        } else {
          newConditions.push(this.searchConditions[i]);
        }
      }
      this.searchConditions = newConditions;
    }
    this.applyFilters();
  }
  
  // é‡ç½®æ‰€æœ‰ç­›é€‰æ¡ä»¶
  resetAllFilters() {
    // åˆ›å»ºæ–°çš„æ•°ç»„æ¥è§¦å‘çŠ¶æ€æ›´æ–°
    const newConditions: SearchCondition[] = [];
    for (let i = 0; i < this.searchConditions.length; i++) {
      const resetCondition: SearchCondition = {
        id: this.searchConditions[i].id,
        label: this.searchConditions[i].label,
        type: this.searchConditions[i].type,
        options: this.searchConditions[i].options,
        selectedValue: '',
        selectedLabel: ''
      };
      newConditions.push(resetCondition);
    }
    this.searchConditions = newConditions;
    this.selectedFilters = [];
    this.searchKeyword = '';
    this.applyFilters();
  }

  // åˆ‡æ¢ç­›é€‰å™¨
  toggleFilter(filterLabel: string) {
    const index = this.selectedFilters.indexOf(filterLabel);
    if (index > -1) {
      this.selectedFilters.splice(index, 1);
    } else {
      this.selectedFilters.push(filterLabel);
    }
    this.applyFilters();
  }

  // å¯¼èˆªåˆ°åˆ†ç±»é¡µé¢
  navigateToCategory(category: Category) {
    try {
      // è·³è½¬åˆ°ç­›é€‰é¡µé¢ï¼Œä¼ é€’åˆ†ç±»ä¿¡æ¯
      router.pushUrl({
        url: 'pages/tabs/InspirationFilterPage',
        params: {
          filterType: 'category',
          filterValue: category.title,
          title: category.title,
          categoryItems: category.items
        }
      });
      
      console.log('å¯¼èˆªåˆ°åˆ†ç±»é¡µé¢:', category.title);
    } catch (error) {
      console.error('å¯¼èˆªå¤±è´¥:', error);
      
      // å¦‚æœå¯¼èˆªå¤±è´¥ï¼Œåˆ™åœ¨å½“å‰é¡µé¢åº”ç”¨ç­›é€‰
      this.selectedFilters = [];
      this.searchKeyword = '';
      
      // æ ¹æ®åˆ†ç±»è®¾ç½®ç›¸åº”çš„ç­›é€‰æ¡ä»¶
      switch (category.title) {
        case 'æŒ‰å¯¹è±¡é€':
          this.selectedFilters = ['ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å­æ•¬çˆ¶æ¯', 'â¤ï¸ æƒ…ä¾£ä¸“å±'];
          break;
        case 'æŒ‰åœºåˆé€':
          this.selectedFilters = ['ğŸ’ ç”Ÿæ—¥å¿…å¤‡', 'ğŸ‰ èŠ‚æ—¥åº†ç¥'];
          break;
        case 'æŒ‰é¢„ç®—é€':
          this.selectedFilters = ['ğŸ’° ç™¾å…ƒå¥½ç¤¼'];
          break;
        case 'æŒ‰ç±»å‹é€':
          this.selectedFilters = ['ğŸ¨ DIYæ‰‹ä½œ'];
          break;
        case 'æŒ‰å…´è¶£é€':
        case 'æŒ‰å­£èŠ‚é€':
          this.selectedFilters = ['ğŸ‰ èŠ‚æ—¥åº†ç¥'];
          break;
      }
      
      this.applyFilters();
      console.log('åœ¨å½“å‰é¡µé¢åº”ç”¨ç­›é€‰:', category.title, this.selectedFilters);
    }
  }

  // å¯¼èˆªåˆ°çµæ„Ÿè¯¦æƒ…é¡µ
  navigateToInspirationDetail(inspiration: Inspiration) {
    router.pushUrl({
      url: 'pages/InspirationDetailPage',
      params: {
        inspirationId: inspiration.id
      }
    });
  }

  // å¯¼èˆªåˆ°ç­›é€‰é¡µé¢
  navigateToFilter(filterType: string, filterValue: string, title?: string) {
    router.pushUrl({
      url: 'pages/tabs/InspirationFilterPage',
      params: {
        filterType: filterType,
        filterValue: filterValue,
        title: title || filterValue
      }
    });
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æœç´¢æ 
        Row() {
          TextInput({ placeholder: 'æœç´¢çµæ„Ÿåˆ›æ„...' })
            .layoutWeight(1)
            .height(40)
            .borderRadius(20)
            .backgroundColor('#F0F0F0')
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => {
              this.searchKeyword = value;
              this.applyFilters();
            })
          
          // // é‡ç½®æŒ‰é’®
          // Button('é‡ç½®')
          //   .fontSize(14)
          //   .height(40)
          //   .padding({ left: 16, right: 16 })
          //   .backgroundColor('#FF6B35')
          //   .fontColor(Color.White)
          //   .borderRadius(20)
          //   .margin({ left: 12 })
          //   .onClick(() => {
          //     this.resetAllFilters();
          //   })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor(Color.White)
        
        // å¤šç»´åº¦æœç´¢æ¡ä»¶æ  - ä½¿ç”¨Selectç»„ä»¶
        Scroll() {
          Row({ space: 8 }) {
            ForEach(this.searchConditions, (condition: SearchCondition) => {
              Select(condition.options.map((option: SearchOption) => {
                const selectOption: SelectOption = { value: option.label };
                return selectOption;
              }))
                .selected(condition.options.findIndex(option => option.value === condition.selectedValue))
                .value(condition.selectedLabel || condition.label)
                .font({ size: 12 })
                .fontColor('#333333')
                .selectedOptionFont({ size: 12 })
                .optionFont({ size: 12 })
                .backgroundColor('#F8F8F8')
                .borderRadius(16)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .height(28)
                .optionHeight(300)
                .constraintSize({ minWidth: 60 })
                .border({
                  width: 1,
                  color: condition.selectedValue ? '#4CAF50' : '#E0E0E0'
                })
                .onSelect((index: number) => {
                  this.selectSearchOption(condition.id, condition.options[index]);
                })
            }, (condition: SearchCondition) => condition.id)
          }
          .padding({ left: 16, right: 16 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .scrollBar(BarState.Off)
        .width('100%')
        .padding({ top: 12, bottom: 12 })

        if (this.isLoading) {
          // åŠ è½½çŠ¶æ€
          Column() {
            LoadingProgress()
              .width(50)
              .height(50)
              .color('#FF6B35')
            
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 12 })
          }
          .width('100%')
          .height('60%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        } else {
          Scroll() {
            Column() {
              // çµæ„Ÿæ¨èåˆ—è¡¨
              Column() {
                Row() {
                  Text('çµæ„Ÿæ¨è')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                  
                  Blank()
                  
                  Text(`å…±${this.filteredInspirations.length}ä¸ªåˆ›æ„`)
                    .fontSize(12)
                    .fontColor('#666666')
                }
                .width('100%')
                .margin({ bottom: 12 })
                
                if (this.filteredInspirations.length === 0) {
                  Column() {
                    Image($r('app.media.icon_empty'))
                      .width(173)
                      .height(128)
                      .margin({ bottom: 16 })
                    
                    Text('æš‚æ— åŒ¹é…çš„çµæ„Ÿ')
                      .fontSize(16)
                      .fontColor('#666666')
                      .margin({ bottom: 12 })
                    
                    Text('è¯•è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…³é”®è¯')
                      .fontSize(14)
                      .fontColor('#999999')
                  }
                  .width('100%')
                  .layoutWeight(1)
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .padding({ left: 24, right: 24 })
                } else {
                  ForEach(this.filteredInspirations, (inspiration: Inspiration) => {
                    this.buildInspirationCard(inspiration)
                  }, (inspiration: Inspiration) => (inspiration.id || 0).toString())
                }
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 16, bottom: 106 })
              .justifyContent(FlexAlign.Start)
              .alignItems(HorizontalAlign.Start)
            }
          }
          .scrollBar(BarState.Off)
}
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8F9FA')
      

    }
     .width('100%')
     .height('100%')
   }
   
   @Builder
  buildInspirationCard(inspiration: Inspiration) {
    Column() {
      Row() {
        Column() {
          Text(inspiration.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 8 })
          
          Text(inspiration.description)
            .fontSize(14)
            .fontColor('#666666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 12 })
          
          // æ ‡ç­¾ - ä½¿ç”¨æ–°çš„TagComponent
          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start}) {
            ForEach(inspiration.tags.slice(0, 3), (tag: string) => {
              TagComponent({
                tagInfo: this.createTagInfo(tag),
                tagFontSize: 10,
                tagClickable: false,
                tagSelected: false
              }).margin(2)
            })
          }
          
          // éš¾åº¦æ ‡ç­¾
          Row() {
            Text(inspiration.difficulty === 'easy' ? 'ç®€å•' : inspiration.difficulty === 'medium' ? 'ä¸­ç­‰' : 'å›°éš¾')
              .fontSize(10)
              .fontColor(inspiration.difficulty === 'easy' ? '#4CAF50' : inspiration.difficulty === 'medium' ? '#FF9800' : '#F44336')
              .backgroundColor(inspiration.difficulty === 'easy' ? '#E8F5E8' : inspiration.difficulty === 'medium' ? '#FFF3E0' : '#FFEBEE')
              .borderRadius(10)
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .margin(2) // ä¸TagComponentä¿æŒä¸€è‡´çš„margin
          }
          .margin({ top: 8 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        
        // ç¼©ç•¥å›¾ - æ¨ªå›¾æ¯”ä¾‹
        if (inspiration.images && inspiration.images.length > 0) {
          Image(inspiration.images[0])
            .width(120)
            .height(80)
            .borderRadius(8)
            .objectFit(ImageFit.Cover)
        } else {
          Column() {
            Image($r('app.media.ic_gift_placeholder'))
              .width(80)
              .height(53)
          }
          .width(120)
          .height(80)
          .backgroundColor('#F0F0F0')
          .borderRadius(8)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .margin({ left: 16 }) // å¢åŠ å·¦è¾¹è·
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 16 }) // å¢åŠ åº•éƒ¨é—´è·
    .shadow({ radius: 4, color: '#1A000000', offsetX: 0, offsetY: 2 }) // æ·»åŠ é˜´å½±æ•ˆæœ
    .onClick(() => {
      this.navigateToInspirationDetail(inspiration);
    })
  }

  // è¾…åŠ©æ–¹æ³•ï¼šæ ¹æ®æ ‡ç­¾å­—ç¬¦ä¸²æˆ–æšä¸¾å€¼åˆ›å»ºTagInfoå¯¹è±¡
  private createTagInfo(tag: string): TagInfo {
    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯æšä¸¾å€¼ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥ä½¿ç”¨getTagInfo
    // æ£€æŸ¥æ˜¯å¦æ˜¯RecipientTypeæšä¸¾å€¼
    if (tag === RecipientType.BOYFRIEND || tag === RecipientType.GIRLFRIEND || 
        tag === RecipientType.FATHER || tag === RecipientType.MOTHER || 
        tag === RecipientType.FRIEND || tag === RecipientType.COLLEAGUE || 
        tag === RecipientType.CHILD || tag === RecipientType.ELDER_RELATIVE ||
        tag === RecipientType.GRANDFATHER || tag === RecipientType.GRANDMOTHER ||
        tag === RecipientType.HUSBAND || tag === RecipientType.WIFE ||
        tag === RecipientType.BESTIE || tag === RecipientType.BOSS ||
        tag === RecipientType.TEACHER || tag === RecipientType.SIBLING ||
        tag === RecipientType.CLASSMATE || tag === RecipientType.NEIGHBOR ||
        tag === RecipientType.CLIENT || tag === RecipientType.OTHER) {
      const tagInfo = getTagInfo(TagCategory.RECIPIENT, tag);
      if (tagInfo) return tagInfo;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯OccasionTypeæšä¸¾å€¼
    if (tag === OccasionType.BIRTHDAY || tag === OccasionType.VALENTINE_DAY || 
        tag === OccasionType.ANNIVERSARY || tag === OccasionType.CHRISTMAS || 
        tag === OccasionType.NEW_YEAR || tag === OccasionType.MOTHERS_DAY || 
        tag === OccasionType.FATHERS_DAY || tag === OccasionType.GRADUATION || 
        tag === OccasionType.WEDDING || tag === OccasionType.PROMOTION || 
        tag === OccasionType.HOUSEWARMING || tag === OccasionType.APOLOGY || 
        tag === OccasionType.THANK_YOU || tag === OccasionType.GET_WELL) {
      const tagInfo = getTagInfo(TagCategory.OCCASION, tag);
      if (tagInfo) return tagInfo;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯GiftTypeæšä¸¾å€¼
    if (tag === GiftType.JEWELRY || tag === GiftType.BOOKS_STATIONERY || 
        tag === GiftType.TECH_DIGITAL || tag === GiftType.DAILY_ITEMS || 
        tag === GiftType.FOOD_BEVERAGE || tag === GiftType.TRAVEL_OUTDOOR || 
        tag === GiftType.DIY_HANDMADE || tag === GiftType.EXPERIENCE || 
        tag === GiftType.HOME_DECOR || tag === GiftType.SPORTS_FITNESS || 
        tag === GiftType.CREATIVE_NOVEL) {
      const tagInfo = getTagInfo(TagCategory.GIFT_TYPE, tag);
      if (tagInfo) return tagInfo;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯BudgetRangeEnumæšä¸¾å€¼
    if (tag === BudgetRangeEnum.UNDER_50 || tag === BudgetRangeEnum.RANGE_50_100 || 
        tag === BudgetRangeEnum.RANGE_100_200 || tag === BudgetRangeEnum.RANGE_200_500 || 
        tag === BudgetRangeEnum.RANGE_500_1000 || tag === BudgetRangeEnum.RANGE_1000_2000 || 
        tag === BudgetRangeEnum.OVER_2000) {
      const tagInfo = getTagInfo(TagCategory.BUDGET, tag);
      if (tagInfo) return tagInfo;
    }
    
    // å¦‚æœä¸æ˜¯æšä¸¾å€¼ï¼Œå°è¯•æŒ‰å­—ç¬¦ä¸²æŸ¥æ‰¾
    let tagInfo = getTagInfo(TagCategory.GIFT_TYPE, tag);
    if (!tagInfo) {
      tagInfo = getTagInfo(TagCategory.RECIPIENT, tag);
    }
    if (!tagInfo) {
      tagInfo = getTagInfo(TagCategory.OCCASION, tag);
    }
    if (!tagInfo) {
      tagInfo = getTagInfo(TagCategory.BUDGET, tag);
    }
    
    // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„æ ‡ç­¾ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„TagInfo
    if (!tagInfo) {
      const defaultTagInfo: TagInfo = {
        category: TagCategory.GIFT_TYPE,
        value: tag,
        label: tag,
        color: '#B2BEC3' // é»˜è®¤ç°è‰²
      };
      return defaultTagInfo;
    }
    
    return tagInfo;
  }
}