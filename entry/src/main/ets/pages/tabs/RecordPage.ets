import router from '@ohos.router';
import { GiftEvent, Contact } from '../../model/NewDataModels';
import { GiftEventDAO } from '../../database/GiftEventDAO';
import { ContactDAO } from '../../database/ContactDAO';
import { NewDatabaseManager } from '../../database/NewDatabaseManager';
import { MockData } from '../../data/MockData';

@Component
export struct RecordPage {
  @Prop @Watch('onRefreshKeyChanged') refreshKey: number = 0;
  @State giftEvents: GiftEvent[] = [];
  @State filteredEvents: GiftEvent[] = [];
  @State selectedYear: number = new Date().getFullYear();
  @State selectedContact: string = '';
  @State isLoading: boolean = true;
  @State showFilterDialog: boolean = false;
  
  private dbManager = new NewDatabaseManager();
  private giftEventDAO: GiftEventDAO = new GiftEventDAO(this.dbManager);
  private contactDAO: ContactDAO = new ContactDAO(this.dbManager);
  private availableYears: number[] = [];
  private contacts: Contact[] = [];

  async aboutToAppear() {
    // ç¡®ä¿æ•°æ®åº“å·²åˆå§‹åŒ–
    try {
      await this.dbManager.initDatabase(getContext(this));
      console.log('è®°å½•é¡µé¢ï¼šæ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      console.error('è®°å½•é¡µé¢ï¼šæ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error);
    }
    
    this.loadData();
  }

  onRefreshKeyChanged() {
    console.log('è®°å½•é¡µé¢ï¼šæ£€æµ‹åˆ°åˆ·æ–°ä¿¡å·ï¼Œé‡æ–°åŠ è½½æ•°æ®...');
    this.loadData();
  }

  async loadData() {
    try {
      this.isLoading = true;
      console.log('è®°å½•é¡µé¢ï¼šå¼€å§‹åŠ è½½æ•°æ®...');
      
      // åŠ è½½ç¤¼ç‰©äº‹ä»¶
      this.giftEvents = await this.giftEventDAO.getAllGiftEvents();
      console.log('è®°å½•é¡µé¢ï¼šåŠ è½½åˆ°çš„äº‹ä»¶æ•°é‡:', this.giftEvents.length);
      
      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç¤ºä¾‹æ•°æ®
      if (this.giftEvents.length === 0) {
        this.giftEvents = this.getMockGiftEvents();
      }
      
      // åŠ è½½è”ç³»äºº
      this.contacts = await this.contactDAO.getAllContacts();
      
      // ç”Ÿæˆå¯ç”¨å¹´ä»½åˆ—è¡¨
      this.generateAvailableYears();
      
      // åº”ç”¨ç­›é€‰
      this.applyFilters();
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
      this.giftEvents = this.getMockGiftEvents();
      this.generateAvailableYears();
      this.applyFilters();
    } finally {
      this.isLoading = false;
    }
  }

  // è·å–ç¤ºä¾‹æ•°æ®
  getMockGiftEvents(): GiftEvent[] {
    return MockData.getMockGiftEvents();
  }

  // ç”Ÿæˆå¯ç”¨å¹´ä»½
  generateAvailableYears() {
    const years = new Set<number>();
    this.giftEvents.forEach(event => {
      const year = new Date(event.date).getFullYear();
      years.add(year);
    });
    this.availableYears = Array.from(years).sort((a, b) => b - a);
    
    if (this.availableYears.length === 0) {
      this.availableYears = [new Date().getFullYear()];
    }
  }

  // åº”ç”¨ç­›é€‰
  applyFilters() {
    let result = this.giftEvents;
    
    // æŒ‰å¹´ä»½ç­›é€‰
    if (this.selectedYear) {
      result = result.filter(event => {
        const eventYear = new Date(event.date).getFullYear();
        return eventYear === this.selectedYear;
      });
    }
    
    // æŒ‰è”ç³»äººç­›é€‰
    if (this.selectedContact) {
      result = result.filter(event => event.contactId === this.selectedContact);
    }
    
    // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    result.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
    
    this.filteredEvents = result;
  }

  // å¯¼èˆªåˆ°åˆ›å»ºè®°å½•é¡µé¢
  navigateToCreateRecord() {
    router.pushUrl({
      url: 'pages/tabs/CreateGiftEventPage'
    });
  }

  // å¯¼èˆªåˆ°è®°å½•è¯¦æƒ…é¡µé¢
  navigateToEventDetail(event: GiftEvent) {
    router.pushUrl({
      url: 'pages/tabs/CreateGiftEventPage',
      params: {
        eventId: event.id,
        isEdit: true
      }
    });
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}æœˆ${day}æ—¥`;
  }

  private getIconByMood(mood: string | undefined): Resource {
    if (mood==='å¼€å¿ƒ') {
      return $r('app.media.icon_happy');
    }
    if (mood==='å…´å¥‹') {
      return $r('app.media.icon_xf');
    }
    if (mood==='æ„ŸåŠ¨') {
      return $r('app.media.icon_gd');
    }
    if (mood==='ç´§å¼ ') {
      return $r('app.media.icon_jz');
    }
    if (mood==='æœŸå¾…') {
      return $r('app.media.icon_qd');
    }
    if (mood==='æ»¡è¶³') {
      return $r('app.media.icon_mz');
    }
    if (mood==='æ¸©æš–') {
      return $r('app.media.icon_wn');
    }
    return $r('app.media.icon_other');
  }

  // è·å–é¢„ç®—çŠ¶æ€é¢œè‰²
  getBudgetStatusColor(budget: number, actualCost: number): string {
    if (actualCost <= budget) {
      return '#4CAF50'; // ç»¿è‰² - åœ¨é¢„ç®—å†…
    } else if (actualCost <= budget * 1.2) {
      return '#FF9800'; // æ©™è‰² - ç•¥è¶…é¢„ç®—
    } else {
      return '#F44336'; // çº¢è‰² - ä¸¥é‡è¶…é¢„ç®—
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å·¥å…·æ 
      Row() {
        Text('æƒ…æ„Ÿæ—¶é—´è½´')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)
        
        // ç­›é€‰æŒ‰é’®
        Row() {
           Image($r('app.media.icon_search'))
             .width(16)
             .height(16)
             .fillColor('#666666')
             .margin({ right: 4 })
           
           Text('ç­›é€‰')
            .fontSize(14)
            .fontColor('#333333')
        }
        .height(32)
        .backgroundColor('#F0F0F0')
        .borderRadius(16)
        .margin({ right: 8 })
        .padding({ left: 12, right: 12 })
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
        .visibility(this.giftEvents.length > 0 ? Visibility.Visible : Visibility.Hidden)
        .onClick(() => {
          this.showFilterDialog = true;
        })
        
        // æ·»åŠ æŒ‰é’®
        Image($r('app.media.ic_add'))
          .width(36)
          .height(36)
          .fillColor('#FF6B35')
          .onClick(() => {
            this.navigateToCreateRecord();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor(Color.White)
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#FF6B35')
            .margin({ top: 100 })
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 12 })
        }
        .width('100%')
        .height('60%')
        .justifyContent(FlexAlign.Start)
        .alignItems(HorizontalAlign.Center)
      } else {
        if (this.filteredEvents.length === 0) {
          // ç©ºçŠ¶æ€
          Column() {
            Image($r('app.media.icon_record'))
              .width(64)
              .height(64)
              .fillColor('#CCCCCC')
              .margin({ bottom: 20, top: 100 })
            
            Text('è¿˜æ²¡æœ‰è®°å½•å“¦')
              .fontSize(18)
              .fontColor('#666666')
              .margin({ bottom: 12 })
            
            Text('ç‚¹å‡»å³ä¸Šè§’çš„ + å·å¼€å§‹è®°å½•ä½ çš„é€ç¤¼æ•…äº‹å§')
              .fontSize(14)
              .fontColor('#999999')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 32 })
              .padding({ left: 16, right: 16 })
            
            Button('å¼€å§‹è®°å½•')
              .backgroundColor('#FF6B35')
              .borderRadius(20)
              .onClick(() => {
                this.navigateToCreateRecord();
              })
          }
          .width('100%')
          .height('60%')
          .justifyContent(FlexAlign.Start)
          .alignItems(HorizontalAlign.Center)
          .padding(32)
        } else {
          // æ—¶é—´è½´åˆ—è¡¨
          Scroll() {
            Column() {
              ForEach(this.filteredEvents, (event: GiftEvent, index: number) => {
                this.buildTimelineItem(event, index)
              })
              
              // åº•éƒ¨é—´è·
              Column()
                .height(20)
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 8 })
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
    .bindSheet($$this.showFilterDialog, this.buildFilterDialog(), {
      height: 400,
      dragBar: true
    })
  }

  @Builder
  buildTimelineItem(event: GiftEvent, index: number) {
    Row() {
      // æ—¶é—´è½´çº¿æ¡
      Column() {
        if (index === 0) {
          Column()
            .width(2)
            .height(20)
            .backgroundColor('#F0F0F0')
        } else {
          Column()
            .width(2)
            .height(20)
            .backgroundColor('#FF6B35')
        }
        
        // æ—¶é—´è½´èŠ‚ç‚¹
        Column()
          .width(12)
          .height(12)
          .backgroundColor('#FF6B35')
          .borderRadius(6)
          .border({ width: 3, color: Color.White })
        
        Column()
          .width(2)
          .height(20)
          .backgroundColor(index === this.filteredEvents.length - 1 ? '#F0F0F0' : '#FF6B35')
      }
      .width(20)
      .alignItems(HorizontalAlign.Center)
      
      // äº‹ä»¶å¡ç‰‡
      Column() {
        // å¡ç‰‡å¤´éƒ¨
        Row() {
          Column() {
            Text(event.contactName)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
            
            Text(`${event.occasion} Â· ${this.formatDate(event.date)}`)
              .fontSize(12)
              .fontColor('#666666')
              .margin({ top: 2 })
          }
          .alignItems(HorizontalAlign.Start)
          
          Blank()
          Image(this.getIconByMood(event.mood))
            .width(20)
            .height(20)
            .fillColor('#CCCCCC')
        }
        .width('100%')
        .margin({ bottom: 12 })
        
        // ç¤¼ç‰©ä¿¡æ¯
        Column() {
          Text(event.actualGift || event.giftIdea)
            .fontSize(14)
            .fontColor('#333333')
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 8 })
          
          // å›¾ç‰‡å±•ç¤º
          if (event.images && event.images.length > 0) {
            Image(event.images[0])
              .width('100%')
              .height(120)
              .objectFit(ImageFit.Cover)
              .borderRadius(8)
              .margin({ bottom: 8 })
          }
          
          if (event.story) {
            Text(event.story)
              .fontSize(13)
              .fontColor('#666666')
              .maxLines(3)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .lineHeight(18)
              .margin({ bottom: 12 })
          }
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
        
        // æ ‡ç­¾å’Œé¢„ç®—
        Row() {
          // æ ‡ç­¾
          if (event.tags && event.tags.length > 0) {
            ForEach(event.tags.slice(0, 2), (tag: string) => {
              Text(`#${tag}`)
                .fontSize(10)
                .fontColor('#FF6B35')
                .backgroundColor('#FFF0ED')
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius(4)
                .margin({ right: 6 })
            })
          }
          
          Blank()
          
          // é¢„ç®—ä¿¡æ¯
          Text(`Â¥${event.actualCost || event.budget}`)
            .fontSize(12)
            .fontColor(this.getBudgetStatusColor(event.budget, event.actualCost || event.budget))
            .fontWeight(FontWeight.Medium)
        }
        .width('100%')
        
        // æé†’æ ‡è¯†
        if (event.reminderSet) {
          Row() {
            Text('ğŸ””')
              .fontSize(12)
            
            Text('å·²è®¾ç½®æé†’')
              .fontSize(11)
              .fontColor('#666666')
              .margin({ left: 4 })
          }
          .margin({ top: 8 })
        }
      }
      .layoutWeight(1)
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ left: 12, bottom: 16 })
      .onClick(() => {
        this.navigateToEventDetail(event);
      })
    }
    .width('100%')
    .alignItems(VerticalAlign.Top)
  }

  @Builder
  buildFilterDialog() {
    Column() {
      Text('ç­›é€‰æ¡ä»¶')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 24 })
      
      // å¹´ä»½ç­›é€‰
      Column() {
        Text('å¹´ä»½')
          .fontSize(14)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
        
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
          Button('å…¨éƒ¨')
            .fontSize(12)
            .height(32)
            .backgroundColor(this.selectedYear === 0 ? '#FF6B35' : '#F0F0F0')
            .fontColor(this.selectedYear === 0 ? Color.White : '#333333')
            .borderRadius(16)
            .margin({ right: 8, bottom: 8 })
            .onClick(() => {
              this.selectedYear = 0;
              this.applyFilters();
            })
          
          ForEach(this.availableYears, (year: number) => {
            Button(year.toString())
              .fontSize(12)
              .height(32)
              .backgroundColor(this.selectedYear === year ? '#FF6B35' : '#F0F0F0')
              .fontColor(this.selectedYear === year ? Color.White : '#333333')
              .borderRadius(16)
              .margin({ right: 8, bottom: 8 })
              .onClick(() => {
                this.selectedYear = year;
                this.applyFilters();
              })
          })
        }
      }
      .width('100%')
      .margin({ bottom: 24 })
      
      // è”ç³»äººç­›é€‰
      Column() {
        Text('è”ç³»äºº')
          .fontSize(14)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
        
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
          Button('å…¨éƒ¨')
            .fontSize(12)
            .height(32)
            .backgroundColor(this.selectedContact === '' ? '#FF6B35' : '#F0F0F0')
            .fontColor(this.selectedContact === '' ? Color.White : '#333333')
            .borderRadius(16)
            .margin({ right: 8, bottom: 8 })
            .onClick(() => {
              this.selectedContact = '';
              this.applyFilters();
            })
          
          // ä»äº‹ä»¶ä¸­æå–è”ç³»äºº
          ForEach(Array.from(new Set(this.giftEvents.map(e => e.contactName))), (contactName: string) => {
            Button(contactName)
              .fontSize(12)
              .height(32)
              .backgroundColor(this.selectedContact === contactName ? '#FF6B35' : '#F0F0F0')
              .fontColor(this.selectedContact === contactName ? Color.White : '#333333')
              .borderRadius(16)
              .margin({ right: 8, bottom: 8 })
              .onClick(() => {
                this.selectedContact = this.giftEvents.find(e => e.contactName === contactName)?.contactId || '';
                this.applyFilters();
              })
          })
        }
      }
      .width('100%')
      .margin({ bottom: 24 })
      
      // æ“ä½œæŒ‰é’®
      Row() {
        Button('é‡ç½®')
          .layoutWeight(1)
          .height(44)
          .backgroundColor('#F0F0F0')
          .fontColor('#333333')
          .borderRadius(22)
          .margin({ right: 8 })
          .onClick(() => {
            this.selectedYear = new Date().getFullYear();
            this.selectedContact = '';
            this.applyFilters();
          })
        
        Button('ç¡®å®š')
          .layoutWeight(1)
          .height(44)
          .backgroundColor('#FF6B35')
          .fontColor(Color.White)
          .borderRadius(22)
          .margin({ left: 8 })
          .onClick(() => {
            this.showFilterDialog = false;
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(24)
  }
}