import router from '@ohos.router';
import { Contact, GiftEvent } from '../../model/NewDataModels';
import { ContactDAO } from '../../database/ContactDAO';
import { GiftEventDAO } from '../../database/GiftEventDAO';
import { NewDatabaseManager } from '../../database/NewDatabaseManager';
import { common } from '@kit.AbilityKit';

interface MonthlyData {
  month: string;
  count: number;
  amount: number;
}

interface CategoryData {
  category: string;
  count: number;
  amount: number;
  percentage: number;
}

interface TopContact {
  contact: Contact;
  giftCount: number;
  totalAmount: number;
}

interface ContactData {
  count: number;
  amount: number;
}

interface MonthlyDataItem {
  count: number;
  amount: number;
}

interface CategoryDataItem {
  category: string;
  count: number;
  amount: number;
  percentage: number;
}

interface TopContactItem {
  contact: Contact;
  giftCount: number;
  totalAmount: number;
}

interface CategoryMapData {
  count: number;
  amount: number;
}

@Entry
@Component
struct GiftStatisticsPage {
  @State giftEvents: GiftEvent[] = [];
  @State contacts: Contact[] = [];
  @State isLoading: boolean = true;
  @State selectedYear: number = new Date().getFullYear();
  @State selectedTab: string = 'overview'; // overview, monthly, category, contacts
  
  // ç»Ÿè®¡æ•°æ®
  @State totalGifts: number = 0;
  @State totalAmount: number = 0;
  @State averageAmount: number = 0;
  @State monthlyData: MonthlyData[] = [];
  @State categoryData: CategoryData[] = [];
  @State topContacts: TopContact[] = [];
  
  // åˆ†ç±»ç»Ÿè®¡æ•°æ®
  @State giveEvents: number = 0;
  @State receiveEvents: number = 0;
  @State giveSpent: number = 0;
  @State receiveSpent: number = 0;
  @State availableYears: number[] = [];
  @State isUsingDemoData: boolean = false; // æ ‡è¯†æ˜¯å¦ä½¿ç”¨ç¤ºä¾‹æ•°æ®
  
  private dbManager = new NewDatabaseManager();
  private contactDAO = new ContactDAO(this.dbManager);
  private giftEventDAO = new GiftEventDAO(this.dbManager);
  
  async aboutToAppear() {
    try {
      // åˆå§‹åŒ–æ•°æ®åº“
      const context = getContext(this) as common.UIAbilityContext;
      await this.dbManager.initDatabase(context);
      
      // åŠ è½½æ•°æ®
      await this.loadData();
    } catch (error) {
      console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
      this.isLoading = false;
    }
  }
  
  async loadData() {
    try {
      this.isLoading = true;
      
      // åŠ è½½æ•°æ®
      this.contacts = await this.contactDAO.getAllContacts();
      this.giftEvents = await this.giftEventDAO.getAllGiftEvents();
      
      // åŠ è½½åˆ†ç±»ç»Ÿè®¡æ•°æ®
      const typeStats = await this.giftEventDAO.getGiftEventTypeStats();
      this.giveEvents = typeStats.giveEvents;
      this.receiveEvents = typeStats.receiveEvents;
      this.giveSpent = typeStats.giveSpent;
      this.receiveSpent = typeStats.receiveSpent;
      
      // åˆå§‹åŒ–å¯ç”¨å¹´ä»½
      this.initAvailableYears();
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦ä½¿ç”¨ç¤ºä¾‹æ•°æ®
      if (this.giftEvents.length === 0) {
        this.generateDemoData();
        this.isUsingDemoData = true;
      }
      
      // è®¡ç®—ç»Ÿè®¡æ•°æ®
      this.calculateStatistics();
      
    } catch (error) {
      console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }
  
  calculateStatistics() {
    // ç­›é€‰å½“å‰å¹´ä»½çš„æ•°æ®
    const yearEvents = this.giftEvents.filter(event => {
      const eventYear = new Date(event.date).getFullYear();
      return eventYear === this.selectedYear;
    });
    
    // åŸºç¡€ç»Ÿè®¡
    this.totalGifts = yearEvents.length;
    this.totalAmount = yearEvents.reduce((sum, event) => sum + (event.actualCost || event.budget || 0), 0);
    this.averageAmount = this.totalGifts > 0 ? this.totalAmount / this.totalGifts : 0;
    
    // æœˆåº¦ç»Ÿè®¡
    this.calculateMonthlyData(yearEvents);
    
    // åˆ†ç±»ç»Ÿè®¡
    this.calculateCategoryData(yearEvents);
    
    // è”ç³»äººç»Ÿè®¡ - ä½¿ç”¨æ‰€æœ‰æ—¶é—´çš„æ•°æ®
    this.calculateTopContacts(this.giftEvents);
  }
  
  calculateMonthlyData(events: GiftEvent[]) {
    const monthlyMap = new Map<number, MonthlyDataItem>();
    
    // åˆå§‹åŒ–12ä¸ªæœˆ
    for (let i = 1; i <= 12; i++) {
      const monthlyItem: MonthlyDataItem = { count: 0, amount: 0 };
      monthlyMap.set(i, monthlyItem);
    }
    
    // ç»Ÿè®¡æ¯æœˆæ•°æ®
    events.forEach(event => {
      const month = new Date(event.date).getMonth() + 1;
      const data = monthlyMap.get(month)!;
      data.count++;
      data.amount += event.actualCost || event.budget || 0;
    });
    
    // è½¬æ¢ä¸ºæ•°ç»„
    this.monthlyData = Array.from(monthlyMap.entries()).map((entry) => {
      const month = entry[0];
      const data = entry[1];
      const monthlyData: MonthlyData = {
        month: `${month}æœˆ`,
        count: data.count,
        amount: data.amount
      };
      return monthlyData;
    });
  }
  
  calculateCategoryData(events: GiftEvent[]) {
    const categoryMap = new Map<string, CategoryMapData>();
    
    events.forEach(event => {
      const category = event.occasion || 'å…¶ä»–';
      if (!categoryMap.has(category)) {
        const categoryData: CategoryMapData = { count: 0, amount: 0 };
        categoryMap.set(category, categoryData);
      }
      const data = categoryMap.get(category)!;
      data.count++;
      data.amount += event.actualCost || event.budget || 0;
    });
    
    // è½¬æ¢ä¸ºæ•°ç»„å¹¶è®¡ç®—ç™¾åˆ†æ¯”
    this.categoryData = Array.from(categoryMap.entries())
      .map((entry) => {
        const category = entry[0];
        const data = entry[1];
        const categoryItem: CategoryDataItem = {
          category,
          count: data.count,
          amount: data.amount,
          percentage: this.totalAmount > 0 ? (data.amount / this.totalAmount) * 100 : 0
        };
        return categoryItem;
      })
      .sort((a, b) => b.amount - a.amount);
  }
  
  calculateTopContacts(events: GiftEvent[]) {
    const contactMap = new Map<string, ContactData>();
    
    events.forEach(event => {
      if (!contactMap.has(event.contactId)) {
        const contactData: ContactData = { count: 0, amount: 0 };
        contactMap.set(event.contactId, contactData);
      }
      const data = contactMap.get(event.contactId)!;
      data.count++;
      data.amount += event.actualCost || event.budget || 0;
    });
    
    // è½¬æ¢ä¸ºæ•°ç»„
    this.topContacts = Array.from(contactMap.entries())
      .map((entry) => {
        const contactId = entry[0];
        const data = entry[1];
        const contact = this.contacts.find(c => c.id === contactId);
        const topContactItem: TopContactItem = {
          contact: contact!,
          giftCount: data.count,
          totalAmount: data.amount
        };
        return topContactItem;
      })
      .filter(item => item.contact)
      .sort((a, b) => b.totalAmount - a.totalAmount)
      .slice(0, 10);
  }
  
  formatAmount(amount: number): string {
    if (amount >= 10000) {
      return (amount / 10000).toFixed(1) + 'ä¸‡';
    } else if (amount >= 1000) {
      return (amount / 1000).toFixed(1) + 'k';
    }
    return amount.toString();
  }
  
  getCategoryColor(index: number): string {
    const colors = ['#FF6B35', '#FFA500', '#32CD32', '#87CEEB', '#DDA0DD', '#F0E68C', '#FFB6C1', '#98FB98'];
    return colors[index % colors.length];
  }
  
  getMaxMonthlyAmount(): number {
    return Math.max(...this.monthlyData.map(d => d.amount), 1);
  }

  goBack() {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Image($r('app.media.icon_back'))
            .width(24)
            .height(24)
            .fillColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.goBack()
        })
        
        Text('ç¤¼ç‰©ç»Ÿè®¡')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // å ä½ç©ºé—´ï¼Œä¿æŒå¸ƒå±€å¹³è¡¡
        Row()
          .width(40)
          .height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)
      
      // ç¤ºä¾‹æ•°æ®æç¤ºæ¡
      if (this.isUsingDemoData) {
        Row() {
          Image($r('app.media.ic_info'))
            .width(16)
            .height(16)
            .fillColor('#FF6B35')
            .margin({ right: 8 })
          
          Text('å½“å‰æ˜¾ç¤ºçš„æ˜¯æ¼”ç¤ºæ•°æ®ï¼Œå¼€å§‹è®°å½•æ‚¨çš„é€ç¤¼æ•…äº‹å§ï¼')
            .fontSize(12)
            .fontColor('#FF6B35')
            .layoutWeight(1)
          
          Text('äº†è§£')
            .fontSize(12)
            .fontColor('#FF6B35')
            .fontWeight(FontWeight.Medium)
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor('#FFF8F5')
            .borderRadius(4)
            .onClick(() => {
              // å¯ä»¥è·³è½¬åˆ°å¸®åŠ©é¡µé¢æˆ–å…³é—­æç¤º
              this.isUsingDemoData = false;
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .backgroundColor('#FFF8F5')
        .border({ width: { bottom: 1 }, color: '#FFE4D6' })
      }
       
       // åŠ è½½çŠ¶æ€
       if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#FF6B35')
          
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        Column() {
          // Tabåˆ‡æ¢
          Row() {
            ForEach(['overview', 'monthly', 'category'], (tab: string) => {
              Text(this.getTabName(tab))
                .fontSize(14)
                .fontColor(this.selectedTab === tab ? Color.White : '#666666')
                .backgroundColor(this.selectedTab === tab ? '#FF6B35' : '#F0F0F0')
                .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                .borderRadius(16)
                .margin({ right: 8 })
                .onClick(() => {
                  this.selectedTab = tab;
                })
            }, (tab: string) => tab)
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 16 })
          
          // å†…å®¹åŒºåŸŸ
          Scroll() {
            Column() {
              if (this.selectedTab === 'overview') {
                this.buildOverviewContent()
              } else if (this.selectedTab === 'monthly') {
                this.buildMonthlyContent()
              } else if (this.selectedTab === 'category') {
                this.buildCategoryContent()
              }
            }
            .width('100%')
            .padding({ bottom: 20 })
          }
          .scrollBar(BarState.Off)
          .margin({ top: 8 })
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }
  
  @Builder
  buildOverviewContent() {
    Column() {
      // å¹´ä»½é€‰æ‹©å™¨
      Row() {
        Text('ç»Ÿè®¡å¹´ä»½')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
        
        Blank()
        
        Select(this.availableYears.map(year => {
          const option: SelectOption = { value: year.toString() };
          return option;
        }))
          .selected(this.availableYears.findIndex(year => year === this.selectedYear))
          .value(`${this.selectedYear}å¹´`)
          .font({ size: 16, weight: FontWeight.Medium })
          .fontColor('#FF6B35')
          .selectedOptionFont({ size: 16, weight: FontWeight.Medium })
          .optionFont({ size: 16, weight: FontWeight.Normal })
          .backgroundColor('#FFF8F5')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .onSelect((index: number) => {
            if (index >= 0 && index < this.availableYears.length) {
              this.selectedYear = this.availableYears[index];
              this.calculateStatistics();
            }
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 8 })
      
      // æ€»è§ˆå¡ç‰‡
      Row() {
        Column() {
          Text(this.giveEvents.toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B35')
          
          Text('é€ç¤¼æ¬¡æ•°')
            .fontSize(12)
            .fontColor('#666666')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        
        Column() {
          Text(this.receiveEvents.toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#32CD32')
          
          Text('æ”¶ç¤¼æ¬¡æ•°')
            .fontSize(12)
            .fontColor('#666666')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        
        Column() {
          Text(`Â¥${this.formatAmount(this.giveSpent)}`)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFA500')
          
          Text('æ€»èŠ±è´¹é‡‘é¢')
            .fontSize(12)
            .fontColor('#666666')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
      }
      .width('100%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ top: 8, left: 16, right: 16 })
      
      // æœˆåº¦è¶‹åŠ¿é¢„è§ˆ
      Column() {
        Row() {
          Text('æœˆåº¦è¶‹åŠ¿')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')

        }
        .width('100%')
        .margin({ bottom: 16 })
        
        // ç®€åŒ–çš„æœˆåº¦å›¾è¡¨
        Row() {
          ForEach(this.monthlyData.slice(0, 6), (data: MonthlyData, index: number) => {
            Column() {
              Column()
                .width(20)
                .height(Math.max(data.amount / this.getMaxMonthlyAmount() * 60, 2))
                .backgroundColor('#FF6B35')
                .borderRadius(2)
              
              Text(data.month.replace('æœˆ', ''))
                .fontSize(10)
                .fontColor('#666666')
                .margin({ top: 4 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Center)
          })
        }
        .width('100%')
        .height(80)
        .alignItems(VerticalAlign.Bottom)
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ top: 8, left: 16, right: 16 })
      
      // åˆ†ç±»é¢„è§ˆ
      Column() {
        Row() {
          Text('åˆ†ç±»ç»Ÿè®¡')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
        }
        .width('100%')
        .margin({ bottom: 16 })
        
        ForEach(this.categoryData.slice(0, 3), (data: CategoryData, index: number) => {
          Row() {
            Circle({ width: 8, height: 8 })
              .fill(this.getCategoryColor(index))
              .margin({ right: 8 })
            
            Text(data.category)
              .fontSize(14)
              .fontColor('#333333')
              .layoutWeight(1)
            
            Text(`Â¥${this.formatAmount(data.amount)}`)
              .fontSize(14)
              .fontColor('#666666')
            
            Text(`${data.percentage.toFixed(1)}%`)
              .fontSize(12)
              .fontColor('#999999')
              .margin({ left: 8 })
          }
          .width('100%')
          .margin({ bottom: 8 })
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ top: 8, left: 16, right: 16 })
    }
  }
  
  @Builder
  buildMonthlyContent() {
    Column() {
      // æœˆåº¦å›¾è¡¨
      Column() {
        Text('æœˆåº¦ç¤¼ç‰©ç»Ÿè®¡')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 16 })
        
        // å›¾è¡¨åŒºåŸŸ
        Column() {
          Row() {
            ForEach(this.monthlyData, (data: MonthlyData) => {
              Column() {
                Column()
                  .width(20)
                  .height(Math.max(data.amount / this.getMaxMonthlyAmount() * 120, 2))
                  .backgroundColor('#FF6B35')
                  .borderRadius(2)
                
                Text(data.month.replace('æœˆ', ''))
                  .fontSize(10)
                  .fontColor('#666666')
                  .margin({ top: 4 })
                
                Text(`Â¥${this.formatAmount(data.amount)}`)
                  .fontSize(8)
                  .fontColor('#999999')
                  .margin({ top: 2 })
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)
            })
          }
          .width('100%')
          .height(150)
          .alignItems(VerticalAlign.Bottom)
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#F8F9FA')
        .borderRadius(8)
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ top: 16, left: 16, right: 16 })
      
      // æœˆåº¦è¯¦ç»†æ•°æ®
      Column() {
        Text('è¯¦ç»†æ•°æ®')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 16 })
        
        ForEach(this.monthlyData.filter(d => d.count > 0), (data: MonthlyData) => {
          Row() {
            Text(data.month)
              .fontSize(14)
              .fontColor('#333333')
              .layoutWeight(1)
            
            Text(`${data.count}æ¬¡`)
              .fontSize(14)
              .fontColor('#666666')
              .margin({ right: 16 })
            
            Text(`Â¥${this.formatAmount(data.amount)}`)
              .fontSize(14)
              .fontColor('#FF6B35')
              .fontWeight(FontWeight.Medium)
          }
          .width('100%')
          .padding({ top: 8, bottom: 8 })
          .borderRadius(8)
          .backgroundColor('#F8F9FA')
          .margin({ bottom: 4 })
          .padding({ left: 12, right: 12 })
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ top: 8, left: 16, right: 16 })
    }
  }
  
  @Builder
  buildCategoryContent() {
    Column() {
      // åˆ†ç±»é¥¼å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰
      Column() {
        Text('åˆ†ç±»å æ¯”')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 16 })
        
        ForEach(this.categoryData, (data: CategoryData, index: number) => {
          Column() {
            Row() {
              Circle({ width: 12, height: 12 })
                .fill(this.getCategoryColor(index))
                .margin({ right: 12 })
              
              Text(data.category)
                .fontSize(14)
                .fontColor('#333333')
                .layoutWeight(1)
              
              Text(`${data.count}æ¬¡`)
                .fontSize(12)
                .fontColor('#666666')
                .margin({ right: 8 })
              
              Text(`Â¥${this.formatAmount(data.amount)}`)
                .fontSize(14)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
                .margin({ right: 8 })
              
              Text(`${data.percentage.toFixed(1)}%`)
                .fontSize(12)
                .fontColor('#FF6B35')
                .width(40)
                .textAlign(TextAlign.End)
            }
            .width('100%')
            .padding({ top: 8, bottom: 8 })
            
            // è¿›åº¦æ¡
            Progress({ value: data.percentage, total: 100, type: ProgressType.Linear })
              .width('100%')
              .height(4)
              .color(this.getCategoryColor(index))
              .backgroundColor('#F0F0F0')
              .margin({ top: 4 })
          }
          .width('100%')
          .margin({ bottom: 12 })
        })
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ top: 16, left: 16, right: 16 })
    }
  }
  
  @Builder
  buildContactsContent() {
    Column() {
      Column() {
        Row() {
          Text('ç¤¼ç‰©å¯¹è±¡æ’è¡Œ')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
          
          Blank()
          
          Text('å…¨éƒ¨æ—¶é—´')
            .fontSize(12)
            .fontColor('#999999')
            .backgroundColor('#F5F5F5')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(10)
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
        .margin({ bottom: 16 })
        
        ForEach(this.topContacts, (item: TopContact, index: number) => {
          Row() {
            // æ’å
            Text(`${index + 1}`)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(index < 3 ? '#FF6B35' : '#666666')
              .width(24)
              .textAlign(TextAlign.Center)
              .margin({ right: 12 })
            
            // å¤´åƒ
            if (item.contact.avatar) {
              Text(item.contact.avatar)
                .fontSize(16)
                .width(40)
                .height(40)
                .borderRadius(20)
                .backgroundColor('#F0F0F0')
                .textAlign(TextAlign.Center)
            } else {
              Image($r('app.media.icon_mine'))
                .width(32)
                .height(32)
                .fillColor('#CCCCCC')
                .borderRadius(20)
                .backgroundColor('#F0F0F0')
            }
            
            // è”ç³»äººä¿¡æ¯
            Column() {
              Text(item.contact.name)
                .fontSize(14)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
                .alignSelf(ItemAlign.Start)
              
              Text(`${item.giftCount}æ¬¡ç¤¼ç‰©`)
                .fontSize(12)
                .fontColor('#666666')
                .alignSelf(ItemAlign.Start)
                .margin({ top: 2 })
            }
            .layoutWeight(1)
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 12 })
            
            // é‡‘é¢
            Text(`Â¥${this.formatAmount(item.totalAmount)}`)
              .fontSize(14)
              .fontColor('#FF6B35')
              .fontWeight(FontWeight.Medium)
          }
          .width('100%')
          .padding(12)
          .backgroundColor(index < 3 ? '#FFF8F5' : Color.White)
          .borderRadius(8)
          .margin({ bottom: 8 })
          .onClick(() => {
            router.pushUrl({
              url: 'pages/profile/ContactFormPage',
              params: { contact: item.contact, isEdit: true }
            });
          })
        })
        
        if (this.topContacts.length === 0) {
          Column() {
            Image($r('app.media.ic_empty'))
              .width(60)
              .height(60)
              .fillColor('#CCCCCC')
            
            Text('æš‚æ— æ•°æ®')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 12 })
          }
          .width('100%')
          .height(120)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .margin({ top: 16, left: 16, right: 16 })
    }
  }
  
  getTabName(tab: string): string {
    switch (tab) {
      case 'overview': return 'æ€»è§ˆ';
      case 'monthly': return 'æœˆåº¦';
      case 'category': return 'åˆ†ç±»';
      case 'contacts': return 'å¯¹è±¡';
      default: return 'æ€»è§ˆ';
    }
  }
  
  // åˆå§‹åŒ–å¯ç”¨å¹´ä»½
  initAvailableYears() {
    const currentYear = new Date().getFullYear();
    const years: number[] = [];
    
    // è·å–æ•°æ®ä¸­çš„å¹´ä»½èŒƒå›´
    const eventYears = this.giftEvents.map(event => new Date(event.date).getFullYear());
    const minYear = eventYears.length > 0 ? Math.min(...eventYears) : currentYear;
    const maxYear = Math.max(currentYear, eventYears.length > 0 ? Math.max(...eventYears) : currentYear);
    
    // ç”Ÿæˆå¹´ä»½åˆ—è¡¨
    for (let year = maxYear; year >= minYear; year--) {
      years.push(year);
    }
    
    this.availableYears = years;
  }
  
  // ç”Ÿæˆä¸°å¯Œçš„ç¤ºä¾‹æ•°æ®
  generateDemoData() {
    // åˆ›å»ºç¤ºä¾‹è”ç³»äºº
    const demoContacts: Contact[] = [
      { id: '1', name: 'å¼ å°æ˜', relationship: 'æœ‹å‹', avatar: 'ğŸ‘¨', birthday: '1990-05-15', importantDates: [], preferences: [], notes: 'å¤§å­¦åŒå­¦ï¼Œå–œæ¬¢è¿åŠ¨', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
      { id: '2', name: 'æç¾ä¸½', relationship: 'åŒäº‹', avatar: 'ğŸ‘©', birthday: '1988-08-20', importantDates: [], preferences: [], notes: 'éƒ¨é—¨åŒäº‹ï¼Œçˆ±å¥½æ‘„å½±', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
      { id: '3', name: 'ç‹å¤§åŠ›', relationship: 'å®¶äºº', avatar: 'ğŸ‘¨â€ğŸ’¼', birthday: '1985-12-10', importantDates: [], preferences: [], notes: 'è¡¨å“¥ï¼Œåœ¨å¤–åœ°å·¥ä½œ', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
      { id: '4', name: 'é™ˆå°èŠ±', relationship: 'æœ‹å‹', avatar: 'ğŸ‘§', birthday: '1992-03-25', importantDates: [], preferences: [], notes: 'é—ºèœœï¼Œå–œæ¬¢åŒ–å¦†å“', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
      { id: '5', name: 'åˆ˜è€å¸ˆ', relationship: 'è€å¸ˆ', avatar: 'ğŸ‘¨â€ğŸ«', birthday: '1975-07-08', importantDates: [], preferences: [], notes: 'é«˜ä¸­ç­ä¸»ä»»', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() },
      { id: '6', name: 'èµµå°é›¨', relationship: 'å®¶äºº', avatar: 'ğŸ‘¶', birthday: '2010-11-30', importantDates: [], preferences: [], notes: 'å°ä¾„å¥³ï¼Œå–œæ¬¢ç©å…·', createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() }
    ];
    
    // åˆ›å»ºç¤ºä¾‹ç¤¼ç‰©äº‹ä»¶
    const currentYear = new Date().getFullYear();
    const demoGiftEvents: GiftEvent[] = [
      // 1æœˆä»½
      { id: '1', contactId: '1', contactName: 'å¼ å°æ˜', recordType: 'give', giftIdea: 'è¿åŠ¨æ‰‹è¡¨', actualGift: 'è¿åŠ¨æ‰‹è¡¨', occasion: 'ç”Ÿæ—¥', date: `${currentYear}-01-15`, budget: 800, actualCost: 750, images: [], story: 'ç”Ÿæ—¥ç¤¼ç‰©ï¼Œå¾ˆå®ç”¨', tags: [], reminderSet: false },
      { id: '2', contactId: '2', contactName: 'æç¾ä¸½', recordType: 'give', giftIdea: 'ç›¸æœºé•œå¤´', actualGift: 'ç›¸æœºé•œå¤´', occasion: 'å‡èŒ', date: `${currentYear}-01-28`, budget: 1200, actualCost: 1150, images: [], story: 'å‡èŒåº†ç¥', tags: [], reminderSet: false },
      
      // 2æœˆä»½ - æ˜¥èŠ‚
      { id: '3', contactId: '3', contactName: 'ç‹å¤§åŠ›', recordType: 'give', giftIdea: 'èŒ¶å¶ç¤¼ç›’', actualGift: 'èŒ¶å¶ç¤¼ç›’', occasion: 'æ˜¥èŠ‚', date: `${currentYear}-02-10`, budget: 300, actualCost: 280, images: [], story: 'æ˜¥èŠ‚æ‹œå¹´', tags: [], reminderSet: false },
      { id: '4', contactId: '6', contactName: 'èµµå°é›¨', recordType: 'give', giftIdea: 'ç©å…·æœºå™¨äºº', actualGift: 'ç©å…·æœºå™¨äºº', occasion: 'æ˜¥èŠ‚', date: `${currentYear}-02-12`, budget: 200, actualCost: 180, images: [], story: 'ç»™å°ä¾„å¥³çš„å‹å²é’±', tags: [], reminderSet: false },
      { id: '5', contactId: '5', contactName: 'åˆ˜è€å¸ˆ', recordType: 'give', giftIdea: 'ä¿å¥å“', actualGift: 'ä¿å¥å“', occasion: 'æ˜¥èŠ‚', date: `${currentYear}-02-14`, budget: 500, actualCost: 480, images: [], story: 'ç»™è€å¸ˆæ‹œå¹´', tags: [], reminderSet: false },
      
      // 3æœˆä»½
      { id: '6', contactId: '4', contactName: 'é™ˆå°èŠ±', recordType: 'give', giftIdea: 'å£çº¢å¥—è£…', actualGift: 'å£çº¢å¥—è£…', occasion: 'å¦‡å¥³èŠ‚', date: `${currentYear}-03-08`, budget: 400, actualCost: 380, images: [], story: 'å¦‡å¥³èŠ‚ç¤¼ç‰©', tags: [], reminderSet: false },
      { id: '7', contactId: '2', contactName: 'æç¾ä¸½', recordType: 'give', giftIdea: 'é²œèŠ±', actualGift: 'é²œèŠ±', occasion: 'å¦‡å¥³èŠ‚', date: `${currentYear}-03-08`, budget: 100, actualCost: 88, images: [], story: 'åŒäº‹é—´çš„å°å¿ƒæ„', tags: [], reminderSet: false },
      
      // 4æœˆä»½
      { id: '8', contactId: '1', contactName: 'å¼ å°æ˜', recordType: 'give', giftIdea: 'ç¯®çƒé‹', actualGift: 'ç¯®çƒé‹', occasion: 'å‹è°Š', date: `${currentYear}-04-20`, budget: 600, actualCost: 550, images: [], story: 'ä¸€èµ·æ‰“çƒç”¨', tags: [], reminderSet: false },
      
      // 5æœˆä»½
      { id: '9', contactId: '3', contactName: 'ç‹å¤§åŠ›', recordType: 'give', giftIdea: 'æŒ‰æ‘©æ¤…å«', actualGift: 'æŒ‰æ‘©æ¤…å«', occasion: 'æ¯äº²èŠ‚', date: `${currentYear}-05-12`, budget: 800, actualCost: 750, images: [], story: 'æ¯äº²èŠ‚ç»™å©¶å©¶', tags: [], reminderSet: false },
      { id: '10', contactId: '5', contactName: 'åˆ˜è€å¸ˆ', recordType: 'give', giftIdea: 'ä¹¦ç±', actualGift: 'ä¹¦ç±', occasion: 'æ„Ÿè°¢', date: `${currentYear}-05-20`, budget: 150, actualCost: 120, images: [], story: 'æ„Ÿè°¢è€å¸ˆçš„å¸®åŠ©', tags: [], reminderSet: false },
      
      // 6æœˆä»½
      { id: '11', contactId: '6', contactName: 'èµµå°é›¨', recordType: 'give', giftIdea: 'å„¿ç«¥æ‰‹è¡¨', actualGift: 'å„¿ç«¥æ‰‹è¡¨', occasion: 'å„¿ç«¥èŠ‚', date: `${currentYear}-06-01`, budget: 300, actualCost: 280, images: [], story: 'å„¿ç«¥èŠ‚ç¤¼ç‰©', tags: [], reminderSet: false },
      { id: '12', contactId: '4', contactName: 'é™ˆå°èŠ±', recordType: 'give', giftIdea: 'åŒ…åŒ…', actualGift: 'åŒ…åŒ…', occasion: 'å‹è°Š', date: `${currentYear}-06-15`, budget: 800, actualCost: 720, images: [], story: 'é—ºèœœç”Ÿæ—¥', tags: [], reminderSet: false },
      
      // 7æœˆä»½
      { id: '13', contactId: '2', contactName: 'æç¾ä¸½', recordType: 'give', giftIdea: 'æ—…è¡Œç®±', actualGift: 'æ—…è¡Œç®±', occasion: 'å‡ºå·®', date: `${currentYear}-07-10`, budget: 500, actualCost: 450, images: [], story: 'å‡ºå·®ç”¨å“', tags: [], reminderSet: false },
      
      // 8æœˆä»½
      { id: '14', contactId: '1', contactName: 'å¼ å°æ˜', recordType: 'give', giftIdea: 'å¥èº«å™¨æ', actualGift: 'å¥èº«å™¨æ', occasion: 'ç”Ÿæ—¥', date: `${currentYear}-08-05`, budget: 1000, actualCost: 950, images: [], story: 'å¥èº«çˆ±å¥½è€…', tags: [], reminderSet: false },
      
      // 9æœˆä»½
      { id: '15', contactId: '5', contactName: 'åˆ˜è€å¸ˆ', recordType: 'give', giftIdea: 'é’¢ç¬”', actualGift: 'é’¢ç¬”', occasion: 'æ•™å¸ˆèŠ‚', date: `${currentYear}-09-10`, budget: 200, actualCost: 180, images: [], story: 'æ•™å¸ˆèŠ‚æ„Ÿè°¢', tags: [], reminderSet: false },
      
      // 10æœˆä»½
      { id: '16', contactId: '3', contactName: 'ç‹å¤§åŠ›', recordType: 'give', giftIdea: 'ä¿æ¸©æ¯', actualGift: 'ä¿æ¸©æ¯', occasion: 'å…³æ€€', date: `${currentYear}-10-15`, budget: 150, actualCost: 130, images: [], story: 'å¤©æ°”è½¬å‡‰çš„å…³æ€€', tags: [], reminderSet: false },
      
      // 11æœˆä»½
      { id: '17', contactId: '4', contactName: 'é™ˆå°èŠ±', recordType: 'give', giftIdea: 'æŠ¤è‚¤å“å¥—è£…', actualGift: 'æŠ¤è‚¤å“å¥—è£…', occasion: 'åŒåä¸€', date: `${currentYear}-11-11`, budget: 600, actualCost: 480, images: [], story: 'åŒåä¸€ä¼˜æƒ ', tags: [], reminderSet: false },
      
      // 12æœˆä»½
      { id: '18', contactId: '2', contactName: 'æç¾ä¸½', recordType: 'give', giftIdea: 'å›´å·¾', actualGift: 'å›´å·¾', occasion: 'åœ£è¯èŠ‚', date: `${currentYear}-12-25`, budget: 200, actualCost: 180, images: [], story: 'åœ£è¯èŠ‚ç¤¼ç‰©', tags: [], reminderSet: false },
      { id: '19', contactId: '6', contactName: 'èµµå°é›¨', recordType: 'give', giftIdea: 'æ•…äº‹ä¹¦', actualGift: 'æ•…äº‹ä¹¦', occasion: 'åœ£è¯èŠ‚', date: `${currentYear}-12-25`, budget: 80, actualCost: 70, images: [], story: 'åœ£è¯èŠ‚ç»™å°æœ‹å‹', tags: [], reminderSet: false },
      
      // æ”¶åˆ°çš„ç¤¼ç‰©
      { id: '20', contactId: '1', contactName: 'å¼ å°æ˜', recordType: 'receive', giftIdea: 'å’–å•¡è±†', actualGift: 'å’–å•¡è±†', occasion: 'æ„Ÿè°¢', date: `${currentYear}-03-15`, budget: 0, actualCost: 0, images: [], story: 'æœ‹å‹é€çš„å’–å•¡è±†', tags: [], reminderSet: false },
      { id: '21', contactId: '4', contactName: 'é™ˆå°èŠ±', recordType: 'receive', giftIdea: 'æ‰‹å·¥é¥¼å¹²', actualGift: 'æ‰‹å·¥é¥¼å¹²', occasion: 'å‹è°Š', date: `${currentYear}-06-20`, budget: 0, actualCost: 0, images: [], story: 'é—ºèœœäº²æ‰‹åšçš„', tags: [], reminderSet: false },
      { id: '22', contactId: '3', contactName: 'ç‹å¤§åŠ›', recordType: 'receive', giftIdea: 'ç‰¹äº§', actualGift: 'ç‰¹äº§', occasion: 'å‡ºå·®', date: `${currentYear}-09-05`, budget: 0, actualCost: 0, images: [], story: 'è¡¨å“¥å‡ºå·®å¸¦å›æ¥çš„', tags: [], reminderSet: false }
    ];
    
    // è®¾ç½®ç¤ºä¾‹æ•°æ®
    this.contacts = demoContacts;
    this.giftEvents = demoGiftEvents;
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    const giveEvents = demoGiftEvents.filter(event => event.recordType === 'give');
    const receiveEvents = demoGiftEvents.filter(event => event.recordType === 'receive');
    
    this.giveEvents = giveEvents.length;
    this.receiveEvents = receiveEvents.length;
    this.giveSpent = giveEvents.reduce((sum, event) => sum + (event.actualCost || 0), 0);
    this.receiveSpent = 0; // æ”¶åˆ°çš„ç¤¼ç‰©ä¸è®¡ç®—èŠ±è´¹
  }

}