import router from '@ohos.router';
import { GiftDAO } from '../database/GiftDAO';
import { Gift, UserReview, PurchaseLink } from '../model/DataModels';

@Entry
@Component
struct GiftDetailPage {
  @State gift: Gift | null = null;
  @State reviews: UserReview[] = [];
  @State similarGifts: Gift[] = [];
  @State isLoading: boolean = true;
  @State currentImageIndex: number = 0;
  @State showFullDescription: boolean = false;
  @State isFavorite: boolean = false;
  
  private giftDAO: GiftDAO = new GiftDAO();
  private giftId: string = '';
  
  aboutToAppear() {
    // Ëé∑ÂèñË∑ØÁî±ÂèÇÊï∞
    const params = router.getParams() as Record<string, Object>;
    this.giftId = params?.giftId as string || '';
    
    if (this.giftId) {
      this.loadGiftDetail();
    } else {
      this.isLoading = false;
    }
  }
  
  private async loadGiftDetail() {
    try {
      this.isLoading = true;
      
      // ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÁ§ºÁâ©ËØ¶ÊÉÖ
      this.gift = await this.giftDAO.getGiftById(this.giftId);
      
      if (this.gift) {
        // Ëé∑ÂèñÁõ∏‰ººÁ§ºÁâ©
        this.similarGifts = await this.giftDAO.getGiftsByCategory(this.gift.category, 5);
        // ËøáÊª§ÊéâÂΩìÂâçÁ§ºÁâ©
        this.similarGifts = this.similarGifts.filter(g => g.id !== this.giftId);
        
        // Ê®°ÊãüËØÑËÆ∫Êï∞ÊçÆÔºàÂÆûÈôÖÂ∫îÁî®‰∏≠ÂèØ‰ª•‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÔºâ
        this.reviews = this.getMockReviews();
      }
    } catch (error) {
      console.error('Âä†ËΩΩÁ§ºÁâ©ËØ¶ÊÉÖÂ§±Ë¥•:', error);
    } finally {
      this.isLoading = false;
    }
  }
  

  

  
  private getMockReviews(): UserReview[] {
    return [
      {
        id: '1',
        userName: 'Â∞èÁæé',
        avatar: 'https://example.com/avatar1.jpg',
        rating: 5,
        comment: 'ÈùûÂ∏∏ÊºÇ‰∫ÆÁöÑÈ°πÈìæÔºåÊ∞¥Êô∂Âæà‰∫ÆÔºåÂÅöÂ∑•Á≤æËá¥ÔºåÂ•≥ÊúãÂèãÂæàÂñúÊ¨¢ÔºÅ',
        date: '2024-01-15',
        images: ['https://example.com/review1.jpg']
      },
      {
        id: '2',
        userName: 'Èò≥ÂÖâÁî∑Â≠©',
        avatar: 'https://example.com/avatar2.jpg',
        rating: 4,
        comment: 'Ë¥®Èáè‰∏çÈîôÔºåÂåÖË£Ö‰πüÂæàÁ≤æÁæéÔºåÂ∞±ÊòØ‰ª∑Ê†ºÊúâÁÇπË¥µ',
        date: '2024-01-10'
      },
      {
        id: '3',
        userName: 'Ê∏©ÊüîÂ•≥Â≠ê',
        avatar: 'https://example.com/avatar3.jpg',
        rating: 5,
        comment: 'Êî∂Âà∞‰∫ÜÔºåÂæàÊª°ÊÑèÔºÅÊ∞¥Êô∂Èó™Èó™ÂèëÂÖâÔºåÊà¥‰∏äÂæàÊòæÊ∞îË¥®',
        date: '2024-01-08'
      }
    ];
  }
  
  private toggleFavorite() {
    this.isFavorite = !this.isFavorite;
  }
  
  private handlePurchase() {
    // Ë¥≠‰π∞ÈÄªËæë
    console.log('Ë¥≠‰π∞Á§ºÁâ©:', this.gift?.name);
  }
  
  private navigateToGiftDetail(giftId: string) {
    router.pushUrl({
      url: 'pages/GiftDetailPage',
      params: { giftId: giftId }
    });
  }
  
  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      this.buildNavigationBar()
      
      if (this.isLoading) {
        this.buildLoadingView()
      } else if (this.gift) {
        Scroll() {
          Column() {
            // ÂïÜÂìÅÂõæÁâáËΩÆÊí≠
            this.buildImageCarousel()
            
            // ÂïÜÂìÅÂü∫Êú¨‰ø°ÊÅØ
            this.buildBasicInfo()
            
            // ÂïÜÂìÅËØ¶ÊÉÖ
            this.buildDetailInfo()
            
            // Ë¥≠‰π∞ÈìæÊé•
            this.buildPurchaseLinks()
            
            // Áî®Êà∑ËØÑ‰ª∑
            this.buildReviews()
            
            // Áõ∏‰ººÊé®Ëçê
            this.buildSimilarGifts()
          }
        }
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Off)
        .layoutWeight(1)
        
        // Â∫ïÈÉ®Êìç‰ΩúÊ†è
        this.buildBottomActions()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
  }
  
  @Builder
  buildNavigationBar() {
    Row() {
      Text('‚Üê')
        .fontSize(24)
        .fontColor('#333333')
        .onClick(() => {
          router.back();
        })
      
      Text('Á§ºÁâ©ËØ¶ÊÉÖ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      Text('‚ãØ')
        .fontSize(24)
        .fontColor('#333333')
        .onClick(() => {
          // ÂàÜ‰∫´ÂäüËÉΩ
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
  }
  
  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#4CAF50')
      
      Text('Âä†ËΩΩ‰∏≠...')
        .fontSize(14)
        .fontColor('#999999')
        .margin({ top: 12 })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }
  
  @Builder
  buildImageCarousel() {
    Stack() {
      Image(this.gift!.imageUrl)
        .width('100%')
        .height(300)
        .objectFit(ImageFit.Cover)
      
      // Êî∂ËóèÊåâÈíÆ
      Row() {
        Text(this.isFavorite ? '‚ù§Ô∏è' : 'ü§ç')
          .fontSize(24)
      }
      .width('100%')
      .justifyContent(FlexAlign.End)
      .padding({ top: 16, right: 16 })
      .onClick(() => {
        this.isFavorite = !this.isFavorite;
      })
    }
    .width('100%')
    .backgroundColor(Color.White)
  }
  
  @Builder
  buildBasicInfo() {
    Column() {
      // ÂïÜÂìÅÂêçÁß∞
      Text(this.gift!.name)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .width('100%')
        .margin({ bottom: 8 })
      
      // ‰ª∑Ê†ºÂíåËØÑÂàÜ
      Row() {
        Text(`¬•${this.gift!.price}`)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FF6B35')
        
        Blank()
        
        Row() {
          ForEach([0, 1, 2, 3, 4], (index: number) => {
            Text(index < Math.floor(this.gift!.rating) ? '‚≠ê' : '‚òÜ')
              .fontSize(16)
              .fontColor(index < Math.floor(this.gift!.rating) ? '#FFD700' : '#E0E0E0')
          })
          
          Text(`${this.gift!.rating}`)
            .fontSize(14)
            .fontColor('#666666')
            .margin({ left: 4 })
          
          Text(`(${this.gift!.reviewCount}Êù°ËØÑ‰ª∑)`)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ left: 4 })
        }
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // Ê†áÁ≠æ
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.gift!.tags, (tag: string, index: number) => {
          Text(tag)
            .fontSize(12)
            .fontColor('#4CAF50')
            .backgroundColor('#E8F5E8')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(12)
            .margin({ right: 8, bottom: 8 })
        })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }
  
  @Builder
  buildDetailInfo() {
    Column() {
      Row() {
        Text('ÂïÜÂìÅËØ¶ÊÉÖ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
        
        Blank()
        
        Text(this.showFullDescription ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ')
          .fontSize(14)
          .fontColor('#4CAF50')
          .onClick(() => {
            this.showFullDescription = !this.showFullDescription;
          })
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      Text(this.gift!.description)
        .fontSize(14)
        .fontColor('#666666')
        .lineHeight(20)
        .maxLines(this.showFullDescription ? undefined : 3)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('100%')
        .margin({ bottom: 12 })
      
      if (this.gift!.meaning) {
        Column() {
          Text('ÂØìÊÑèËß£ËØª')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .width('100%')
            .margin({ bottom: 8 })
          
          Text(this.gift!.meaning)
            .fontSize(14)
            .fontColor('#666666')
            .lineHeight(20)
            .width('100%')
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#FFF8E1')
        .borderRadius(8)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }
  
  @Builder
  buildPurchaseLinks() {
    Column() {
      Text('Ë¥≠‰π∞Ê∏†ÈÅì')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .width('100%')
        .margin({ bottom: 12 })
      
      ForEach(this.gift!.purchaseLinks, (link: PurchaseLink, index: number) => {
        Row() {
          Column() {
            Text(link.platform)
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
            
            Text(link.inStock ? 'ÊúâË¥ß' : 'Áº∫Ë¥ß')
              .fontSize(12)
              .fontColor(link.inStock ? '#4CAF50' : '#FF5722')
          }
          .alignItems(HorizontalAlign.Start)
          
          Blank()
          
          Text(`¬•${link.price}`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF6B35')
          
          Button(link.inStock ? 'ÂéªË¥≠‰π∞' : 'Áº∫Ë¥ß')
            .fontSize(12)
            .backgroundColor(link.inStock ? '#4CAF50' : '#CCCCCC')
            .fontColor(Color.White)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .margin({ left: 12 })
            .enabled(link.inStock)
            .onClick(() => {
              if (link.inStock) {
                // Ë∑≥ËΩ¨Âà∞Ë¥≠‰π∞ÈìæÊé•
              }
            })
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#F8F8F8')
        .borderRadius(8)
        .margin({ bottom: 8 })
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }
  
  @Builder
  buildReviews() {
    Column() {
      Row() {
        Text('Áî®Êà∑ËØÑ‰ª∑')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
        
        Blank()
        
        Text('Êü•ÁúãÂÖ®ÈÉ®')
          .fontSize(14)
          .fontColor('#4CAF50')
          .onClick(() => {
            // Ë∑≥ËΩ¨Âà∞ËØÑ‰ª∑È°µÈù¢
          })
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      ForEach(this.reviews.slice(0, 3), (review: UserReview, index: number) => {
        Column() {
          Row() {
            Image(review.avatar)
              .width(32)
              .height(32)
              .borderRadius(16)
              .backgroundColor('#E0E0E0')
            
            Column() {
              Text(review.userName)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
              
              Row() {
                ForEach([0, 1, 2, 3, 4], (index: number) => {
                  Text(index < review.rating ? '‚≠ê' : '‚òÜ')
                    .fontSize(12)
                    .fontColor(index < review.rating ? '#FFD700' : '#E0E0E0')
                })
                
                Text(review.date)
                  .fontSize(12)
                  .fontColor('#999999')
                  .margin({ left: 8 })
              }
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 8 })
            .layoutWeight(1)
          }
          .width('100%')
          .margin({ bottom: 8 })
          
          Text(review.comment)
            .fontSize(14)
            .fontColor('#666666')
            .lineHeight(20)
            .width('100%')
        }
        .width('100%')
        .padding(12)
        .backgroundColor('#F8F8F8')
        .borderRadius(8)
        .margin({ bottom: 8 })
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }
  
  @Builder
  buildSimilarGifts() {
    Column() {
      Text('Áõ∏‰ººÊé®Ëçê')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
        .width('100%')
        .margin({ bottom: 12 })
      
      Scroll() {
        Row() {
          ForEach(this.similarGifts, (gift: Gift, index: number) => {
            Column() {
              Image(gift.imageUrl)
                .width(120)
                .height(120)
                .borderRadius(8)
                .backgroundColor('#E0E0E0')
              
              Text(gift.name)
                .fontSize(12)
                .fontColor('#333333')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .width(120)
                .margin({ top: 8 })
              
              Text(`¬•${gift.price}`)
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF6B35')
                .margin({ top: 4 })
            }
            .width(120)
            .margin({ right: 12 })
            .onClick(() => this.navigateToGiftDetail(gift.id))
          })
        }
        .padding({ left: 16, right: 16 })
      }
    }
    .width('100%')
    .padding({ top: 16, bottom: 16 })
    .backgroundColor(Color.White)
  }
  
  @Builder
  buildBottomActions() {
    Row() {
      Button('Âä†ÂÖ•Êî∂Ëóè')
        .fontSize(14)
        .backgroundColor(this.isFavorite ? '#FF6B35' : '#E0E0E0')
        .fontColor(this.isFavorite ? Color.White : '#666666')
        .layoutWeight(1)
        .margin({ right: 8 })
        .onClick(this.toggleFavorite.bind(this))
      
      Button('Á´ãÂç≥Ë¥≠‰π∞')
        .fontSize(14)
        .backgroundColor('#4CAF50')
        .fontColor(Color.White)
        .layoutWeight(2)
        .onClick(this.handlePurchase.bind(this))
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .border({ width: { top: 1 }, color: '#E0E0E0' })
  }
}