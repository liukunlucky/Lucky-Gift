import { Gift, GiftCategory, Scenario, PriceRange } from '../model/GiftModel';
import { GiftRecommendationService } from '../service/GiftRecommendationService';
import router from '@ohos.router';

// ç­›é€‰æ¡ä»¶æ¥å£
interface FilterConditions {
  keyword: string;
  category: GiftCategory | null;
  scenario: Scenario | null;
  priceMin: number;
  priceMax: number;
  sortBy: 'price' | 'rating' | 'popularity' | 'newest';
  sortOrder: 'asc' | 'desc';
}

// ä»·æ ¼åŒºé—´é€‰é¡¹
interface PriceRangeOption {
  label: string;
  min: number;
  max: number;
}

@Entry
@Component
struct SearchFilterPage {
  @State searchKeyword: string = '';
  @State filteredGifts: Gift[] = [];
  @State allGifts: Gift[] = [];
  @State loading: boolean = false;
  @State showFilter: boolean = false;
  @State filterConditions: FilterConditions = {
    keyword: '',
    category: null,
    scenario: null,
    priceMin: 0,
    priceMax: 10000,
    sortBy: 'popularity',
    sortOrder: 'desc'
  };
  
  private giftService: GiftRecommendationService = GiftRecommendationService.getInstance();
  private scroller: Scroller = new Scroller();
  
  // ä»·æ ¼åŒºé—´é€‰é¡¹
  private priceRanges: PriceRangeOption[] = [
    { label: 'ä¸é™', min: 0, max: 10000 },
    { label: '100ä»¥ä¸‹', min: 0, max: 100 },
    { label: '100-300', min: 100, max: 300 },
    { label: '300-500', min: 300, max: 500 },
    { label: '500-1000', min: 500, max: 1000 },
    { label: '1000-3000', min: 1000, max: 3000 },
    { label: '3000ä»¥ä¸Š', min: 3000, max: 10000 }
  ];

  aboutToAppear() {
    this.loadGifts();
  }

  build() {
    Column() {
      this.buildHeader()
      this.buildSearchBar()
      this.buildFilterBar()
      if (this.showFilter) {
        this.buildFilterPanel()
      }
      this.buildResultList()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }

  @Builder
  buildHeader() {
    Row() {
      Text('â†')
        .fontSize(24)
        .fontColor('#333333')
        .onClick(() => {
          router.back();
        })

      Text('ç¤¼ç‰©æœç´¢')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Text('ğŸ”')
        .fontSize(24)
        .onClick(() => {
          this.performSearch();
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildSearchBar() {
    Row() {
      TextInput({ placeholder: 'æœç´¢ç¤¼ç‰©åç§°ã€å“ç‰Œã€å…³é”®è¯...' })
        .layoutWeight(1)
        .height(40)
        .backgroundColor('#F5F5F5')
        .borderRadius(20)
        .padding({ left: 16, right: 16 })
        .fontSize(14)
        .onChange((value: string) => {
          this.searchKeyword = value;
          this.filterConditions.keyword = value;
        })
        .onSubmit(() => {
          this.performSearch();
        })

      Button('æœç´¢')
        .backgroundColor('#4CAF50')
        .fontColor(Color.White)
        .fontSize(14)
        .borderRadius(20)
        .height(40)
        .margin({ left: 12 })
        .onClick(() => {
          this.performSearch();
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Color.White)
  }

  @Builder
  buildFilterBar() {
    Row() {
      Text('ç­›é€‰')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ right: 8 })

      Button(this.showFilter ? 'æ”¶èµ·ç­›é€‰' : 'å±•å¼€ç­›é€‰')
        .backgroundColor(this.showFilter ? '#FF9800' : '#E3F2FD')
        .fontColor(this.showFilter ? Color.White : '#2196F3')
        .fontSize(12)
        .borderRadius(12)
        .height(32)
        .onClick(() => {
          this.showFilter = !this.showFilter;
        })

      Blank()

      Text(`å…±${this.filteredGifts.length}ä»¶å•†å“`)
        .fontSize(12)
        .fontColor('#999999')

      Button('é‡ç½®')
        .backgroundColor('#F0F0F0')
        .fontColor('#666666')
        .fontSize(12)
        .borderRadius(12)
        .height(32)
        .margin({ left: 8 })
        .onClick(() => {
          this.resetFilters();
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }

  @Builder
  buildFilterPanel() {
    Column() {
      // åˆ†ç±»ç­›é€‰
      this.buildCategoryFilter()
      
      Divider().margin({ top: 16, bottom: 16 })
      
      // åœºæ™¯ç­›é€‰
      this.buildScenarioFilter()
      
      Divider().margin({ top: 16, bottom: 16 })
      
      // ä»·æ ¼ç­›é€‰
      this.buildPriceFilter()
      
      Divider().margin({ top: 16, bottom: 16 })
      
      // æ’åºé€‰é¡¹
      this.buildSortOptions()
      
      // åº”ç”¨ç­›é€‰æŒ‰é’®
      Button('åº”ç”¨ç­›é€‰')
        .backgroundColor('#4CAF50')
        .fontColor(Color.White)
        .width('100%')
        .height(44)
        .borderRadius(22)
        .margin({ top: 20 })
        .onClick(() => {
          this.applyFilters();
          this.showFilter = false;
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .margin({ bottom: 8 })
  }

  @Builder
  buildCategoryFilter() {
    Column() {
      Text('ç¤¼ç‰©åˆ†ç±»')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)
      
      Flex({ wrap: FlexWrap.Wrap }) {
        this.buildCategoryChip('å…¨éƒ¨', null)
        this.buildCategoryChip('é²œèŠ±', GiftCategory.FLOWERS)
        this.buildCategoryChip('ç å®', GiftCategory.JEWELRY)
        this.buildCategoryChip('æ•°ç ', GiftCategory.ELECTRONICS)
        this.buildCategoryChip('æœé¥°', GiftCategory.CLOTHING)
        this.buildCategoryChip('ç¾å¦†', GiftCategory.COSMETICS)
        this.buildCategoryChip('ä¹¦ç±', GiftCategory.BOOKS)
        this.buildCategoryChip('è¿åŠ¨', GiftCategory.SPORTS)
        this.buildCategoryChip('å®¶å±…', GiftCategory.HOME)
        this.buildCategoryChip('ç¾é£Ÿ', GiftCategory.FOOD)
      }
    }
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildCategoryChip(label: string, category: GiftCategory | null) {
    Text(label)
      .fontSize(14)
      .fontColor(this.filterConditions.category === category ? Color.White : '#666666')
      .backgroundColor(this.filterConditions.category === category ? '#4CAF50' : '#F0F0F0')
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .borderRadius(16)
      .margin({ right: 8, bottom: 8 })
      .onClick(() => {
        this.filterConditions.category = category;
      })
  }

  @Builder
  buildScenarioFilter() {
    Column() {
      Text('ä½¿ç”¨åœºæ™¯')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)
      
      Flex({ wrap: FlexWrap.Wrap }) {
        this.buildScenarioChip('å…¨éƒ¨', null)
        this.buildScenarioChip('ç”Ÿæ—¥', Scenario.BIRTHDAY)
        this.buildScenarioChip('æƒ…äººèŠ‚', Scenario.VALENTINE)
        this.buildScenarioChip('æ¯•ä¸šå…¸ç¤¼', Scenario.GRADUATION)
        this.buildScenarioChip('å©šç¤¼', Scenario.WEDDING)
        this.buildScenarioChip('åœ£è¯èŠ‚', Scenario.CHRISTMAS)
        this.buildScenarioChip('çºªå¿µæ—¥', Scenario.ANNIVERSARY)
        this.buildScenarioChip('é“æ­‰', Scenario.APOLOGY)
        this.buildScenarioChip('æ„Ÿè°¢', Scenario.THANK_YOU)
        this.buildScenarioChip('ç¥è´º', Scenario.CONGRATULATIONS)
      }
    }
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildScenarioChip(label: string, scenario: Scenario | null) {
    Text(label)
      .fontSize(14)
      .fontColor(this.filterConditions.scenario === scenario ? Color.White : '#666666')
      .backgroundColor(this.filterConditions.scenario === scenario ? '#4CAF50' : '#F0F0F0')
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .borderRadius(16)
      .margin({ right: 8, bottom: 8 })
      .onClick(() => {
        this.filterConditions.scenario = scenario;
      })
  }

  @Builder
  buildPriceFilter() {
    Column() {
      Text('ä»·æ ¼åŒºé—´')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)
      
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.priceRanges, (range: PriceRangeOption) => {
          this.buildPriceChip(range)
        })
      }
      
      // è‡ªå®šä¹‰ä»·æ ¼åŒºé—´
      Row() {
        Text('è‡ªå®šä¹‰:')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ right: 8 })
        
        TextInput({ placeholder: 'æœ€ä½ä»·' })
          .width(80)
          .height(32)
          .fontSize(12)
          .backgroundColor('#F5F5F5')
          .borderRadius(4)
          .textAlign(TextAlign.Center)
          .type(InputType.Number)
          .onChange((value: string) => {
            this.filterConditions.priceMin = parseInt(value) || 0;
          })
        
        Text('-')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ left: 8, right: 8 })
        
        TextInput({ placeholder: 'æœ€é«˜ä»·' })
          .width(80)
          .height(32)
          .fontSize(12)
          .backgroundColor('#F5F5F5')
          .borderRadius(4)
          .textAlign(TextAlign.Center)
          .type(InputType.Number)
          .onChange((value: string) => {
            this.filterConditions.priceMax = parseInt(value) || 10000;
          })
      }
      .margin({ top: 12 })
    }
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildPriceChip(range: PriceRangeOption) {
    Text(range.label)
      .fontSize(14)
      .fontColor(this.filterConditions.priceMin === range.min && this.filterConditions.priceMax === range.max ? Color.White : '#666666')
      .backgroundColor(this.filterConditions.priceMin === range.min && this.filterConditions.priceMax === range.max ? '#4CAF50' : '#F0F0F0')
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .borderRadius(16)
      .margin({ right: 8, bottom: 8 })
      .onClick(() => {
        this.filterConditions.priceMin = range.min;
        this.filterConditions.priceMax = range.max;
      })
  }

  @Builder
  buildSortOptions() {
    Column() {
      Text('æ’åºæ–¹å¼')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)
      
      Flex({ wrap: FlexWrap.Wrap }) {
        this.buildSortChip('äººæ°”æ¨è', 'popularity', 'desc')
        this.buildSortChip('ä»·æ ¼ä»ä½åˆ°é«˜', 'price', 'asc')
        this.buildSortChip('ä»·æ ¼ä»é«˜åˆ°ä½', 'price', 'desc')
        this.buildSortChip('è¯„åˆ†æœ€é«˜', 'rating', 'desc')
        this.buildSortChip('æœ€æ–°ä¸Šæ¶', 'newest', 'desc')
      }
    }
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  buildSortChip(label: string, sortBy: string, sortOrder: string) {
    Text(label)
      .fontSize(14)
      .fontColor(this.filterConditions.sortBy === sortBy && this.filterConditions.sortOrder === sortOrder ? Color.White : '#666666')
      .backgroundColor(this.filterConditions.sortBy === sortBy && this.filterConditions.sortOrder === sortOrder ? '#4CAF50' : '#F0F0F0')
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .borderRadius(16)
      .margin({ right: 8, bottom: 8 })
      .onClick(() => {
        this.filterConditions.sortBy = sortBy as 'price' | 'rating' | 'popularity' | 'newest';
        this.filterConditions.sortOrder = sortOrder as 'asc' | 'desc';
      })
  }

  @Builder
  buildResultList() {
    if (this.loading) {
      Column() {
        Text('ğŸ”')
          .fontSize(48)
          .margin({ bottom: 16 })
        
        Text('æ­£åœ¨æœç´¢...')
          .fontSize(16)
          .fontColor('#666666')
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    } else if (this.filteredGifts.length === 0) {
      Column() {
        Text('ğŸ˜”')
          .fontSize(48)
          .margin({ bottom: 16 })
        
        Text('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç¤¼ç‰©')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ bottom: 8 })
        
        Text('è¯•è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–ç­›é€‰æ¡ä»¶')
          .fontSize(14)
          .fontColor('#999999')
        
        Button('é‡æ–°æœç´¢')
          .backgroundColor('#4CAF50')
          .fontColor(Color.White)
          .borderRadius(20)
          .margin({ top: 20 })
          .onClick(() => {
            this.resetFilters();
            this.loadGifts();
          })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    } else {
      Scroll(this.scroller) {
        Column() {
          ForEach(this.filteredGifts, (gift: Gift) => {
            this.buildGiftCard(gift)
          })
        }
        .padding({ left: 16, right: 16, top: 8, bottom: 16 })
      }
      .layoutWeight(1)
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
    }
  }

  @Builder
  buildGiftCard(gift: Gift) {
    Row() {
      // ç¤¼ç‰©å›¾ç‰‡
      Column() {
        Text('ğŸ')
          .fontSize(32)
      }
      .width(80)
      .height(80)
      .backgroundColor('#F5F5F5')
      .borderRadius(8)
      .justifyContent(FlexAlign.Center)
      .margin({ right: 12 })

      // ç¤¼ç‰©ä¿¡æ¯
      Column() {
        Text(gift.name)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 4 })
        
        Text(gift.description)
          .fontSize(14)
          .fontColor('#666666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 8 })
        
        Row() {
          Text(`Â¥${gift.price}`)
            .fontSize(18)
            .fontColor('#FF5722')
            .fontWeight(FontWeight.Bold)
          
          Text(`â­ ${gift.rating}`)
            .fontSize(12)
            .fontColor('#FF9800')
            .margin({ left: 8 })
          
          Blank()
          
          Text(this.getCategoryText(gift.category))
            .fontSize(12)
            .fontColor('#999999')
            .backgroundColor('#F0F0F0')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(4)
        }
        .width('100%')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // æ”¶è—æŒ‰é’®
      Text('â™¡')
        .fontSize(24)
        .fontColor('#CCCCCC')
        .onClick(() => {
          // æ·»åŠ åˆ°æ”¶è—
        })
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ bottom: 12 })
    .onClick(() => {
      router.pushUrl({
        url: 'pages/GiftDetailPage',
        params: { giftId: gift.id }
      });
    })
  }

  private loadGifts() {
    this.loading = true;
    
    // æ¨¡æ‹ŸåŠ è½½ç¤¼ç‰©æ•°æ®
    setTimeout(() => {
      this.allGifts = this.giftService.getRecommendations({
          scenario: Scenario.BIRTHDAY,
          priceRange: PriceRange.MODERATE
        }).gifts;
      this.filteredGifts = [...this.allGifts];
      this.loading = false;
    }, 500);
  }

  private performSearch() {
    this.loading = true;
    
    setTimeout(() => {
      this.applyFilters();
      this.loading = false;
    }, 300);
  }

  private applyFilters() {
    let results = [...this.allGifts];
    
    // å…³é”®è¯æœç´¢
    if (this.filterConditions.keyword.trim()) {
      const keyword = this.filterConditions.keyword.toLowerCase();
      results = results.filter(gift => 
        gift.name.toLowerCase().includes(keyword) ||
        gift.description.toLowerCase().includes(keyword)
      );
    }
    
    // åˆ†ç±»ç­›é€‰
    if (this.filterConditions.category !== null) {
      results = results.filter(gift => gift.category === this.filterConditions.category);
    }
    
    // åœºæ™¯ç­›é€‰
    if (this.filterConditions.scenario !== null) {
      results = results.filter(gift => gift.scenarios.includes(this.filterConditions.scenario!));
    }
    
    // ä»·æ ¼ç­›é€‰
    results = results.filter(gift => 
      gift.price >= this.filterConditions.priceMin && 
      gift.price <= this.filterConditions.priceMax
    );
    
    // æ’åº
    results.sort((a, b) => {
      let comparison = 0;
      
      switch (this.filterConditions.sortBy) {
        case 'price':
          comparison = a.price - b.price;
          break;
        case 'rating':
          comparison = a.rating - b.rating;
          break;
        case 'popularity':
          comparison = a.rating - b.rating; // ä½¿ç”¨è¯„åˆ†ä»£æ›¿äººæ°”
          break;
        case 'newest':
          comparison = a.id.localeCompare(b.id); // ä½¿ç”¨IDæ’åºä»£æ›¿åˆ›å»ºæ—¶é—´
          break;
      }
      
      return this.filterConditions.sortOrder === 'desc' ? -comparison : comparison;
    });
    
    this.filteredGifts = results;
  }

  private resetFilters() {
    this.searchKeyword = '';
    this.filterConditions = {
      keyword: '',
      category: null,
      scenario: null,
      priceMin: 0,
      priceMax: 10000,
      sortBy: 'popularity',
      sortOrder: 'desc'
    };
    this.filteredGifts = [...this.allGifts];
  }

  private getCategoryText(category: GiftCategory): string {
    switch (category) {
      case GiftCategory.FLOWERS:
        return 'é²œèŠ±';
      case GiftCategory.JEWELRY:
        return 'ç å®';
      case GiftCategory.ELECTRONICS:
        return 'æ•°ç ';
      case GiftCategory.CLOTHING:
        return 'æœé¥°';
      case GiftCategory.COSMETICS:
        return 'ç¾å¦†';
      case GiftCategory.BOOKS:
        return 'ä¹¦ç±';
      case GiftCategory.SPORTS:
        return 'è¿åŠ¨';
      case GiftCategory.HOME:
        return 'å®¶å±…';
      case GiftCategory.FOOD:
        return 'ç¾é£Ÿ';
      case GiftCategory.TOYS:
        return 'å…¶ä»–';
      default:
        return 'æœªçŸ¥';
    }
  }
}