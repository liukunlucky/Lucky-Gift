import router from '@ohos.router';
import { scanBarcode, scanCore } from '@kit.ScanKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';
import { ScanHistoryDAO, ScanHistoryItem } from '../dao/ScanHistoryDAO';
import { NewDatabaseManager } from '../database/NewDatabaseManager';
import { common } from '@kit.AbilityKit';

@Entry
@Component
struct BarcodeScanIntroPage {
  @State recentScans: ScanHistoryItem[] = [];
  @State isLoading: boolean = false;
  
  private dbManager: NewDatabaseManager = new NewDatabaseManager();
  private scanHistoryDAO: ScanHistoryDAO = new ScanHistoryDAO(this.dbManager);

  async aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®åº“
    const context = getContext(this) as common.UIAbilityContext;
    await this.dbManager.initDatabase(context);
    
    // åŠ è½½æœ€è¿‘æ‰«æè®°å½•
    await this.loadRecentScans();
  }

  async onPageShow() {
    // åŠ è½½æœ€è¿‘æ‰«æè®°å½•
    await this.loadRecentScans();
  }

  // åŠ è½½æœ€è¿‘æ‰«æè®°å½•
  async loadRecentScans() {
    try {
      this.recentScans = await this.scanHistoryDAO.getRecentScans(5);
    } catch (error) {
      console.error('åŠ è½½æ‰«æåŽ†å²å¤±è´¥:', error);
    }
  }

  // å¼€å§‹æ‰«ç 
  async startScan() {
    try {
      this.isLoading = true;
      
      // æ£€æŸ¥æ‰«ç æƒé™
      const options: scanBarcode.ScanOptions = {
        scanTypes: [scanCore.ScanType.ALL],
        enableMultiMode: false,
        enableAlbum: true
      };

      const result = await scanBarcode.startScanForResult(getContext(this), options);
      
      if (result && result.originalValue) {
        // è·³è½¬åˆ°å•†å“è¯¦æƒ…é¡µé¢
        router.pushUrl({
          url: 'pages/BarcodeProductPage',
          params: {
            barcode: result.originalValue,
            fromIntro: true
          }
        });
      }
    } catch (error) {
      console.error('æ‰«ç å¤±è´¥:', error);
      promptAction.showToast({
        message: 'æ‰«ç å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  // æŸ¥çœ‹æ‰«æåŽ†å²è¯¦æƒ…
  viewScanHistory(item: ScanHistoryItem) {
    router.pushUrl({
      url: 'pages/BarcodeProductPage',
      params: {
        barcode: item.barcode,
        fromHistory: true
      }
    });
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Image($r('app.media.icon_back'))
            .width(24)
            .height(24)
            .fillColor('#333333')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back();
        })
        
        Text('å•†å“æ‰«ç ')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // å ä½ç¬¦ä¿æŒå±…ä¸­
        Row().width(40).height(40)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      Scroll() {
        Column({ space: 24 }) {
          // ä½¿ç”¨ä»‹ç»åŒºåŸŸ
          Column({ space: 16 }) {
            Text('å¦‚ä½•ä½¿ç”¨å•†å“æ‰«ç ')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)

            // æ¡å½¢ç ç¤ºæ„å›¾
            Column({ space: 12 }) {
              Image($r('app.media.pic_barcode'))
                .width(200)
                .height(120)
                .objectFit(ImageFit.Contain)
                .borderRadius(8)
                .backgroundColor('#F8F8F8')

              Text('è¯·å°†æ‘„åƒå¤´å¯¹å‡†å•†å“åŒ…è£…ä¸Šçš„æ¡å½¢ç ')
                .fontSize(14)
                .fontColor('#666666')
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .alignItems(HorizontalAlign.Center)

            // ä½¿ç”¨è¯´æ˜Ž
            Column({ space: 8 }) {
              this.InstructionItem('1', 'æ‰¾åˆ°å•†å“åŒ…è£…ä¸Šçš„æ¡å½¢ç ')
              this.InstructionItem('2', 'ç‚¹å‡»ä¸‹æ–¹"æ‰«ä¸€æ‰«"æŒ‰é’®')
              this.InstructionItem('3', 'å°†æ‘„åƒå¤´å¯¹å‡†æ¡å½¢ç æ‰«æ')
              this.InstructionItem('4', 'æŸ¥çœ‹å•†å“è¯¦ç»†ä¿¡æ¯')
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)

          // æ‰«ä¸€æ‰«æŒ‰é’®
          Button() {
            Row({ space: 8 }) {
              if (this.isLoading) {
                LoadingProgress()
                  .width(20)
                  .height(20)
                  .color('#FFFFFF')
              } else {
                Image($r('app.media.icon_scan'))
                  .width(24)
                  .height(24)
                  .fillColor('#ffffff')
              }
              
              Text(this.isLoading ? 'æ‰«æä¸­...' : 'æ‰«ä¸€æ‰«')
                .fontSize(18)
                .fontColor('#FFFFFF')
                .fontWeight(FontWeight.Medium)
            }
          }
          .width('80%')
          .height(56)
          .backgroundColor('#FA8C16')
          .borderRadius(28)
          .enabled(!this.isLoading)
          .onClick(() => this.startScan())

          // æœ€è¿‘æ‰«æè®°å½•
          if (this.recentScans.length > 0) {
            Column({ space: 16 }) {
              Row() {
                Text('æœ€è¿‘æ‰«æ')
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                
                Blank()
                
                Text(`å…±${this.recentScans.length}æ¡è®°å½•`)
                  .fontSize(14)
                  .fontColor('#999999')
              }
              .width('100%')

              Column({ space: 12 }) {
                ForEach(this.recentScans, (item: ScanHistoryItem, index: number) => {
                  this.ScanHistoryItem(item, index)
                })
              }
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            Blank().height(20)
          } else {
            Column() {
              Text('æœ€è¿‘æ— æ‰«æè®°å½•').fontSize(14)
                .fontColor('#999999')
            }.height(200).justifyContent(FlexAlign.Center).width('90%').backgroundColor('#FFFFFF').borderRadius(12)


          }
        }
        .padding(16)
      }
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // ä½¿ç”¨è¯´æ˜Žé¡¹
  @Builder InstructionItem(step: string, description: string) {
    Row({ space: 12 }) {
      Text(step)
        .width(24)
        .height(24)
        .fontSize(12)
        .fontColor('#FFFFFF')
        .backgroundColor('#FA8C16')
        .borderRadius(12)
        .textAlign(TextAlign.Center)
      
      Text(description)
        .fontSize(14)
        .fontColor('#333333')
        .layoutWeight(1)
    }
    .width('100%')
    .alignItems(VerticalAlign.Center)
  }

  // æ‰«æåŽ†å²é¡¹
  @Builder ScanHistoryItem(item: ScanHistoryItem, index: number) {
    Row({ space: 12 }) {
      // å•†å“å›¾ç‰‡
      if (item.image) {
        Image(item.image)
          .width(50)
          .height(50)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)
      } else {
        Row() {
          Text('ðŸ“¦')
            .fontSize(20)
        }
        .width(50)
        .height(50)
        .backgroundColor('#F0F0F0')
        .borderRadius(8)
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
      }

      // å•†å“ä¿¡æ¯
      Column({ space: 4 }) {
        Text(item.goodsName || 'æœªçŸ¥å•†å“')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .alignSelf(ItemAlign.Start)
        
        Text(item.brand || 'æœªçŸ¥å“ç‰Œ')
          .fontSize(12)
          .fontColor('#666666')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .alignSelf(ItemAlign.Start)
        
        Row({ space: 8 }) {
          Text(`Â¥${item.price || '0.00'}`)
            .fontSize(12)
            .fontColor('#FF6B35')
            .fontWeight(FontWeight.Medium)
          
          Text(item.scanTime)
            .fontSize(10)
            .fontColor('#999999')
        }
        .alignSelf(ItemAlign.Start)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // ç®­å¤´
      Text('â€º')
        .fontSize(16)
        .fontColor('#CCCCCC')
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#FAFAFA')
    .borderRadius(8)
    .onClick(() => this.viewScanHistory(item))
  }
}