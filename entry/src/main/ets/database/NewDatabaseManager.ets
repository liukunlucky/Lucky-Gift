import relationalStore from '@ohos.data.relationalStore';
import { Contact, GiftEvent, Inspiration, FavoriteInspiration, ImportantDate, ContactPreference, UserGiftCard, Reminder, AppSettings,
  Achievement,
  AchievementType} from '../model/NewDataModels';

// èŠ‚æ—¥æ•°æ®æ¥å£
interface HolidayData {
  id: string;
  name: string;
  date: string;
  isRecurring: boolean;
  description: string;
  giftSuggestions: string;
}

// ç¤¼å“å¡æ¨¡æ¿æ•°æ®æ¥å£
interface GiftCardTemplateData {
  id: string;
  name: string;
  previewImage: string;
  templatePath: string;
  category: string;
  isDefault: boolean;
}

export class NewDatabaseManager {
  private rdbStore: relationalStore.RdbStore | null = null;
  private readonly DATABASE_NAME = 'LuckyGiftV2.db';
  private readonly DATABASE_VERSION = 3;

  async initDatabase(context: Context): Promise<void> {
    const config: relationalStore.StoreConfig = {
      name: this.DATABASE_NAME,
      securityLevel: relationalStore.SecurityLevel.S1
    };

    try {
      this.rdbStore = await relationalStore.getRdbStore(context, config);
      await this.createTables();
      await this.initDefaultData();
    } catch (error) {
      console.error('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error);
      throw new Error(`æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${error}`);
    }
  }

  isInitialized(): boolean {
    return this.rdbStore !== null;
  }



  private async createTables(): Promise<void> {
    if (!this.rdbStore) return;

    const tables = [
      // è”ç³»äººè¡¨
      `CREATE TABLE IF NOT EXISTS contacts (
        id TEXT PRIMARY KEY,
        name TEXT NOT NULL,
        relationship TEXT NOT NULL,
        avatar TEXT,
        birthday TEXT,
        notes TEXT,
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL
      )`,

      // é‡è¦æ—¥æœŸè¡¨
      `CREATE TABLE IF NOT EXISTS important_dates (
        id TEXT PRIMARY KEY,
        contact_id TEXT NOT NULL,
        name TEXT NOT NULL,
        date TEXT NOT NULL,
        is_recurring INTEGER NOT NULL DEFAULT 1,
        reminder_enabled INTEGER NOT NULL DEFAULT 1,
        reminder_days INTEGER NOT NULL DEFAULT 7,
        FOREIGN KEY (contact_id) REFERENCES contacts (id) ON DELETE CASCADE
      )`,

      // è”ç³»äººåå¥½è¡¨
      `CREATE TABLE IF NOT EXISTS contact_preferences (
        id TEXT PRIMARY KEY,
        contact_id TEXT NOT NULL,
        category TEXT NOT NULL,
        content TEXT NOT NULL,
        priority TEXT NOT NULL DEFAULT 'medium',
        FOREIGN KEY (contact_id) REFERENCES contacts (id) ON DELETE CASCADE
      )`,

      // ç¤¼ç‰©äº‹ä»¶è¡¨ï¼ˆæ—¶é—´è½´æ ¸å¿ƒï¼‰
      `CREATE TABLE IF NOT EXISTS gift_events (
        id TEXT PRIMARY KEY,
        contact_id TEXT NOT NULL,
        contact_name TEXT NOT NULL,
        record_type TEXT NOT NULL DEFAULT 'give', -- 'give'é€ç¤¼ æˆ– 'receive'æ”¶ç¤¼
        occasion TEXT NOT NULL,
        date TEXT NOT NULL,
        gift_idea TEXT NOT NULL,
        actual_gift TEXT,
        budget REAL NOT NULL DEFAULT 0,
        actual_cost REAL,
        images TEXT, -- JSONæ•°ç»„
        story TEXT,
        reaction TEXT,
        mood TEXT,
        tags TEXT, -- JSONæ•°ç»„
        reminder_set INTEGER NOT NULL DEFAULT 0,
        reminder_date TEXT,
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL,
        FOREIGN KEY (contact_id) REFERENCES contacts (id) ON DELETE CASCADE
      )`,

      // æˆ‘çš„çµæ„Ÿè¡¨ï¼ˆç”¨æˆ·è‡ªå·±åˆ›å»ºçš„çµæ„Ÿï¼‰
      `CREATE TABLE IF NOT EXISTS my_inspirations (
        id TEXT PRIMARY KEY,
        title TEXT NOT NULL,
        description TEXT NOT NULL,
        detailed_description TEXT,
        images TEXT, -- JSONæ•°ç»„ï¼Œå­˜å‚¨å›¾ç‰‡è·¯å¾„
        tags TEXT, -- JSONæ•°ç»„
        target_audience TEXT, -- JSONæ•°ç»„
        occasions TEXT, -- JSONæ•°ç»„
        interests TEXT, -- JSONæ•°ç»„
        budget_min REAL NOT NULL DEFAULT 0,
        budget_max REAL NOT NULL DEFAULT 0,
        budget_label TEXT NOT NULL DEFAULT '',
        gift_type TEXT NOT NULL,
        difficulty TEXT NOT NULL DEFAULT 'easy',
        time_required TEXT,
        materials TEXT, -- JSONæ•°ç»„
        steps TEXT, -- JSONæ•°ç»„
        tips TEXT, -- JSONæ•°ç»„
        precautions TEXT, -- JSONæ•°ç»„
        gift_wrap_ideas TEXT, -- JSONæ•°ç»„
        presentation_tips TEXT, -- JSONæ•°ç»„
        personalized_tips TEXT, -- JSONæ•°ç»„
        view_count INTEGER NOT NULL DEFAULT 0,
        favorite_count INTEGER NOT NULL DEFAULT 0,
        rating REAL DEFAULT 0,
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL
      )`,

      // æ”¶è—çš„çµæ„Ÿè¡¨
      `CREATE TABLE IF NOT EXISTS favorite_inspirations (
        id TEXT PRIMARY KEY,
        inspiration_id TEXT NOT NULL,
        user_id TEXT NOT NULL DEFAULT 'default',
        notes TEXT,
        created_at TEXT NOT NULL,
        FOREIGN KEY (inspiration_id) REFERENCES inspirations (id) ON DELETE CASCADE
      )`,

      // ç¤¼ç‰©å¡æ¨¡æ¿è¡¨
      `CREATE TABLE IF NOT EXISTS gift_card_templates (
        id TEXT PRIMARY KEY,
        name TEXT NOT NULL,
        preview_image TEXT NOT NULL,
        template_path TEXT NOT NULL,
        category TEXT NOT NULL,
        is_default INTEGER NOT NULL DEFAULT 0
      )`,

      // ç”¨æˆ·ç¤¼ç‰©å¡è¡¨
      `CREATE TABLE IF NOT EXISTS user_gift_cards (
        id TEXT PRIMARY KEY,
        template_id TEXT NOT NULL,
        title TEXT NOT NULL,
        message TEXT NOT NULL,
        recipient_name TEXT,
        sender_name TEXT,
        created_at TEXT NOT NULL,
        image_path TEXT,
        FOREIGN KEY (template_id) REFERENCES gift_card_templates (id)
      )`,

      // èŠ‚æ—¥è¡¨
      `CREATE TABLE IF NOT EXISTS holidays (
        id TEXT PRIMARY KEY,
        name TEXT NOT NULL,
        date TEXT NOT NULL,
        is_recurring INTEGER NOT NULL DEFAULT 1,
        description TEXT,
        gift_suggestions TEXT, -- JSONæ•°ç»„
        icon TEXT
      )`,

      // æé†’è¡¨
      `CREATE TABLE IF NOT EXISTS reminders (
        id TEXT PRIMARY KEY,
        type TEXT NOT NULL,
        related_id TEXT NOT NULL,
        title TEXT NOT NULL,
        message TEXT NOT NULL,
        reminder_date TEXT NOT NULL,
        is_active INTEGER NOT NULL DEFAULT 1,
        is_triggered INTEGER NOT NULL DEFAULT 0,
        created_at TEXT NOT NULL
      )`,

      // ç¤¼ç‰©æ•…äº‹è¡¨
      `CREATE TABLE IF NOT EXISTS gift_stories (
        id TEXT PRIMARY KEY,
        gift_event_id TEXT NOT NULL,
        gift_event_title TEXT NOT NULL,
        contact_name TEXT NOT NULL,
        title TEXT NOT NULL,
        content TEXT NOT NULL,
        images TEXT, -- JSONæ•°ç»„ï¼Œæœ€å¤š3å¼ ç…§ç‰‡è·¯å¾„
        emotion TEXT,
        reason TEXT,
        scene TEXT,
        tags TEXT, -- JSONæ•°ç»„
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL,
        FOREIGN KEY (gift_event_id) REFERENCES gift_events (id) ON DELETE CASCADE
      )`,

      // æˆå°±æ¨¡æ¿è¡¨ï¼ˆå›ºå®šçš„æˆå°±å®šä¹‰ï¼‰
      `CREATE TABLE IF NOT EXISTS achievements (
        id TEXT PRIMARY KEY,
        name TEXT NOT NULL,
        description TEXT NOT NULL,
        icon TEXT NOT NULL,
        type TEXT NOT NULL,
        condition_type TEXT NOT NULL,
        target_value INTEGER NOT NULL,
        time_window INTEGER,
        specific_value TEXT
      )`,

      // ç”¨æˆ·æˆå°±è¿›åº¦è¡¨ï¼ˆæ¯ä¸ªç”¨æˆ·çš„ä¸ªäººæˆå°±è¿›åº¦ï¼‰
      `CREATE TABLE IF NOT EXISTS user_achievement_progress (
        id TEXT PRIMARY KEY,
        user_id TEXT NOT NULL DEFAULT 'default',
        achievement_id TEXT NOT NULL,
        current_progress INTEGER NOT NULL DEFAULT 0,
        is_unlocked INTEGER NOT NULL DEFAULT 0,
        unlocked_at TEXT,
        last_updated TEXT NOT NULL,
        FOREIGN KEY (achievement_id) REFERENCES achievements (id) ON DELETE CASCADE
      )`,

      // æˆå°±é‡Œç¨‹ç¢‘è¡¨
      `CREATE TABLE IF NOT EXISTS achievement_milestones (
        id TEXT PRIMARY KEY,
        achievement_id TEXT NOT NULL,
        date TEXT NOT NULL,
        description TEXT NOT NULL,
        related_event_id TEXT,
        FOREIGN KEY (achievement_id) REFERENCES achievements (id) ON DELETE CASCADE
      )`,

      // æ—¶é—´è½´äº‹ä»¶è¡¨
      `CREATE TABLE IF NOT EXISTS timeline_events (
        id TEXT PRIMARY KEY,
        contact_id TEXT NOT NULL,
        contact_name TEXT NOT NULL,
        contact_avatar TEXT,
        type TEXT NOT NULL, -- 'meet', 'friend', 'close', 'conflict', 'reconcile', 'gift', 'milestone', 'memory'
        title TEXT NOT NULL,
        description TEXT,
        date TEXT NOT NULL,
        emotion_level INTEGER NOT NULL DEFAULT 3, -- 1-5
        tags TEXT, -- JSONæ•°ç»„
        photos TEXT, -- JSONæ•°ç»„
        location TEXT,
        weather TEXT,
        mood TEXT NOT NULL,
        is_important INTEGER NOT NULL DEFAULT 0,
        related_gift_id TEXT,
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL,
        FOREIGN KEY (contact_id) REFERENCES contacts (id) ON DELETE CASCADE
      )`,

      // ä»½å­ç¤¼è®°å½•è¡¨
      `CREATE TABLE IF NOT EXISTS fenzi_gift_records (
        id TEXT PRIMARY KEY,
        contact_id TEXT NOT NULL,
        contact_name TEXT NOT NULL,
        type TEXT NOT NULL, -- wedding, birthday, housewarming, baby_shower, graduation, promotion, other
        occasion TEXT NOT NULL,
        amount REAL NOT NULL,
        direction TEXT NOT NULL, -- sent, received
        date TEXT NOT NULL,
        location TEXT,
        note TEXT,
        photos TEXT, -- JSONæ•°ç»„
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL,
        FOREIGN KEY (contact_id) REFERENCES contacts (id) ON DELETE CASCADE
      )`,

      // åº”ç”¨è®¾ç½®è¡¨
      `CREATE TABLE IF NOT EXISTS app_settings (
        id TEXT PRIMARY KEY DEFAULT 'default',
        default_reminder_days INTEGER NOT NULL DEFAULT 7,
        enable_notifications INTEGER NOT NULL DEFAULT 1,
        data_backup_enabled INTEGER NOT NULL DEFAULT 1,
        last_backup_date TEXT,
        theme_mode TEXT NOT NULL DEFAULT 'auto',
        language TEXT NOT NULL DEFAULT 'zh-CN',
        privacy_mode INTEGER NOT NULL DEFAULT 0
      )`,

      // å¤‡å¿˜è¡¨
      `CREATE TABLE IF NOT EXISTS quick_records (
        id TEXT PRIMARY KEY,
        type TEXT NOT NULL,
        title TEXT NOT NULL,
        content TEXT NOT NULL,
        date TEXT NOT NULL,
        tags TEXT NOT NULL DEFAULT '[]',
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL
      )`,

      // æˆ‘çš„å¿ƒæ„¿è¡¨
      `CREATE TABLE IF NOT EXISTS my_wishes (
        id TEXT PRIMARY KEY,
        title TEXT NOT NULL,
        description TEXT NOT NULL,
        category TEXT NOT NULL, -- gift, experience, travel, learning, health, career, relationship, hobby, other
        priority TEXT NOT NULL, -- low, medium, high, urgent
        status TEXT NOT NULL, -- active, achieved, cancelled, postponed
        target_date TEXT,
        estimated_cost REAL DEFAULT 0,
        actual_cost REAL DEFAULT 0,
        tags TEXT NOT NULL DEFAULT '[]', -- JSONæ•°ç»„
        images TEXT NOT NULL DEFAULT '[]', -- JSONæ•°ç»„
        notes TEXT,
        progress INTEGER NOT NULL DEFAULT 0, -- 0-100
        related_contacts TEXT NOT NULL DEFAULT '[]', -- JSONæ•°ç»„
        inspiration_source TEXT,
        achieved_date TEXT,
        achievement_notes TEXT,
        reminder_enabled INTEGER NOT NULL DEFAULT 0,
        reminder_date TEXT,
        is_public INTEGER NOT NULL DEFAULT 0,
        created_at TEXT NOT NULL,
        updated_at TEXT NOT NULL
      )`
    ];

    for (const sql of tables) {
      await this.rdbStore.executeSql(sql);
    }

    // åˆ›å»ºç´¢å¼•
    const indexes = [
      'CREATE INDEX IF NOT EXISTS idx_gift_events_date ON gift_events (date)',
      'CREATE INDEX IF NOT EXISTS idx_gift_events_contact ON gift_events (contact_id)',
      'CREATE INDEX IF NOT EXISTS idx_important_dates_contact ON important_dates (contact_id)',
      'CREATE INDEX IF NOT EXISTS idx_reminders_date ON reminders (reminder_date)',
      'CREATE INDEX IF NOT EXISTS idx_timeline_events_date ON timeline_events (date)',
      'CREATE INDEX IF NOT EXISTS idx_timeline_events_contact ON timeline_events (contact_id)',
      'CREATE INDEX IF NOT EXISTS idx_timeline_events_type ON timeline_events (type)',
      'CREATE INDEX IF NOT EXISTS idx_fenzi_gift_records_date ON fenzi_gift_records (date)',
      'CREATE INDEX IF NOT EXISTS idx_fenzi_gift_records_contact ON fenzi_gift_records (contact_id)',
      'CREATE INDEX IF NOT EXISTS idx_fenzi_gift_records_direction ON fenzi_gift_records (direction)',
      'CREATE INDEX IF NOT EXISTS idx_fenzi_gift_records_type ON fenzi_gift_records (type)',
      'CREATE INDEX IF NOT EXISTS idx_my_wishes_status ON my_wishes (status)',
      'CREATE INDEX IF NOT EXISTS idx_my_wishes_category ON my_wishes (category)',
      'CREATE INDEX IF NOT EXISTS idx_my_wishes_priority ON my_wishes (priority)',
      'CREATE INDEX IF NOT EXISTS idx_my_wishes_target_date ON my_wishes (target_date)',
      'CREATE INDEX IF NOT EXISTS idx_my_wishes_created_at ON my_wishes (created_at)'
    ];

    for (const sql of indexes) {
      await this.rdbStore.executeSql(sql);
    }
  }

  private async initDefaultData(): Promise<void> {
    if (!this.rdbStore) return;

    try {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰é»˜è®¤è®¾ç½®
      const settingsCount = await this.rdbStore.querySql('SELECT COUNT(*) as count FROM app_settings');
      if (settingsCount.goToFirstRow() && settingsCount.getLong(0) === 0) {
        // æ’å…¥é»˜è®¤è®¾ç½®
        await this.rdbStore.executeSql(
          'INSERT INTO app_settings (id) VALUES (?)',
          ['default']
        );
      }
      settingsCount.close();

      // åˆå§‹åŒ–é»˜è®¤èŠ‚æ—¥æ•°æ®
      const holidaysCount = await this.rdbStore.querySql('SELECT COUNT(*) as count FROM holidays');
      if (holidaysCount.goToFirstRow() && holidaysCount.getLong(0) === 0) {
        await this.initDefaultHolidays();
      }
      holidaysCount.close();

      // åˆå§‹åŒ–ç¤¼ç‰©å¡æ¨¡æ¿
      const templatesCount = await this.rdbStore.querySql('SELECT COUNT(*) as count FROM gift_card_templates');
      if (templatesCount.goToFirstRow() && templatesCount.getLong(0) === 0) {
        await this.initDefaultGiftCardTemplates();
      }
      templatesCount.close();

      // åˆå§‹åŒ–æˆå°±ç³»ç»Ÿ
      const achievementsCount = await this.rdbStore.querySql('SELECT COUNT(*) as count FROM achievements');
      if (achievementsCount.goToFirstRow() && achievementsCount.getLong(0) === 0) {
        await this.initDefaultAchievements();
      }
      achievementsCount.close();
    } catch (error) {
      console.error('åˆå§‹åŒ–é»˜è®¤æ•°æ®å¤±è´¥:', error);
      throw new Error(`åˆå§‹åŒ–é»˜è®¤æ•°æ®å¤±è´¥: ${error}`);
    }
  }

  private async initDefaultHolidays(): Promise<void> {
    if (!this.rdbStore) return;

    const holidays: HolidayData[] = [
      {
        id: 'spring_festival',
        name: 'æ˜¥èŠ‚',
        date: '2024-02-10', // ç¤ºä¾‹æ—¥æœŸ
        isRecurring: true,
        description: 'ä¸­å›½ä¼ ç»Ÿæ–°å¹´',
        giftSuggestions: JSON.stringify(['çº¢åŒ…', 'å¹´è´§ç¤¼ç›’', 'ä¼ ç»Ÿå·¥è‰ºå“'])
      },
      {
        id: 'valentines_day',
        name: 'æƒ…äººèŠ‚',
        date: '02-14',
        isRecurring: true,
        description: 'æµªæ¼«æƒ…äººèŠ‚',
        giftSuggestions: JSON.stringify(['é²œèŠ±', 'å·§å…‹åŠ›', 'ç å®', 'æµªæ¼«æ™šé¤'])
      },
      {
        id: 'mothers_day',
        name: 'æ¯äº²èŠ‚',
        date: '05-12', // äº”æœˆç¬¬äºŒä¸ªå‘¨æ—¥
        isRecurring: true,
        description: 'æ„Ÿæ©æ¯äº²çš„èŠ‚æ—¥',
        giftSuggestions: JSON.stringify(['åº·ä¹ƒé¦¨', 'æŠ¤è‚¤å“', 'æŒ‰æ‘©å™¨', 'é™ªä¼´æ—¶å…‰'])
      },
      {
        id: 'fathers_day',
        name: 'çˆ¶äº²èŠ‚',
        date: '06-16', // å…­æœˆç¬¬ä¸‰ä¸ªå‘¨æ—¥
        isRecurring: true,
        description: 'æ„Ÿæ©çˆ¶äº²çš„èŠ‚æ—¥',
        giftSuggestions: JSON.stringify(['èŒ¶å¶', 'å‰ƒé¡»åˆ€', 'é’±åŒ…', 'è¿åŠ¨ç”¨å“'])
      },
      {
        id: 'christmas',
        name: 'åœ£è¯èŠ‚',
        date: '12-25',
        isRecurring: true,
        description: 'è¥¿æ–¹ä¼ ç»ŸèŠ‚æ—¥',
        giftSuggestions: JSON.stringify(['åœ£è¯ç¤¼ç›’', 'è£…é¥°å“', 'ç©å…·', 'ç¾é£Ÿ'])
      }
    ];

    for (const holiday of holidays) {
      await this.rdbStore.executeSql(
        `INSERT INTO holidays (id, name, date, is_recurring, description, gift_suggestions) 
         VALUES (?, ?, ?, ?, ?, ?)`,
        [holiday.id, holiday.name, holiday.date, holiday.isRecurring ? 1 : 0, 
         holiday.description, holiday.giftSuggestions]
      );
    }
  }

  private async initDefaultGiftCardTemplates(): Promise<void> {
    if (!this.rdbStore) return;

    const templates: GiftCardTemplateData[] = [
      {
        id: 'classic_birthday',
        name: 'ç»å…¸ç”Ÿæ—¥',
        previewImage: 'assets/templates/classic_birthday_preview.svg',
        templatePath: 'assets/templates/classic_birthday.svg',
        category: 'ç”Ÿæ—¥',
        isDefault: true
      },
      {
        id: 'romantic_love',
        name: 'æµªæ¼«çˆ±æƒ…',
        previewImage: 'assets/templates/romantic_love_preview.svg',
        templatePath: 'assets/templates/romantic_love.svg',
        category: 'çˆ±æƒ…',
        isDefault: true
      },
      {
        id: 'warm_family',
        name: 'æ¸©é¦¨å®¶åº­',
        previewImage: 'assets/templates/warm_family_preview.svg',
        templatePath: 'assets/templates/warm_family.svg',
        category: 'å®¶åº­',
        isDefault: true
      }
    ];

    for (const template of templates) {
      await this.rdbStore.executeSql(
        `INSERT INTO gift_card_templates (id, name, preview_image, template_path, category, is_default) 
         VALUES (?, ?, ?, ?, ?, ?)`,
        [template.id, template.name, template.previewImage, template.templatePath, 
         template.category, template.isDefault ? 1 : 0]
      );
    }
  }

  private async initDefaultAchievements(): Promise<void> {
    if (!this.rdbStore) return;

    // æˆå°±æ¨¡æ¿æ•°æ®ï¼ˆå›ºå®šçš„7ä¸ªæˆå°±å®šä¹‰ï¼‰
    interface AchievementTemplateData {
      id: string;
      name: string;
      description: string;
      icon: string;
      type: AchievementType;
      conditionType: AchievementType;
      targetValue: number;
      timeWindow: number | null;
      specificValue: string | null;
    }
    
    const achievementTemplates: AchievementTemplateData[] = [];
    
    // åˆ›å»ºæˆå°±æ¨¡æ¿å¯¹è±¡
    const firstGift: AchievementTemplateData = {
      id: 'first_gift',
      name: 'åˆæ¬¡å°è¯•',
      description: 'åˆ›å»ºç¬¬ä¸€ä¸ªç¤¼ç‰©è®°å½•',
      icon: 'ğŸŒŸ',
      type: AchievementType.GIFT_COUNT,
      conditionType: AchievementType.GIFT_COUNT,
      targetValue: 1,
      timeWindow: null,
      specificValue: null
    };
    achievementTemplates.push(firstGift);

    const heartFull: AchievementTemplateData = {
      id: 'heart_full',
      name: 'å¿ƒæ„æ»¡æ»¡',
      description: 'ç´¯è®¡è®°å½•10æ¬¡é€ç¤¼',
      icon: 'ğŸ’',
      type: AchievementType.GIFT_COUNT,
      conditionType: AchievementType.GIFT_COUNT,
      targetValue: 10,
      timeWindow: null,
      specificValue: null
    };
    achievementTemplates.push(heartFull);

    const mindReader: AchievementTemplateData = {
      id: 'mind_reader',
      name: 'è¯»å¿ƒå¤§å¸ˆ',
      description: 'æ”¶åˆ°5æ¬¡"éå¸¸å¼€å¿ƒ"çš„è¯„ä»·',
      icon: 'ğŸ¯',
      type: AchievementType.FEEDBACK_QUALITY,
      conditionType: AchievementType.FEEDBACK_QUALITY,
      targetValue: 5,
      timeWindow: null,
      specificValue: 'éå¸¸å¼€å¿ƒ'
    };
    achievementTemplates.push(mindReader);

    const budgetMaster: AchievementTemplateData = {
      id: 'budget_master',
      name: 'é¢„ç®—è¾¾äºº',
      description: 'è¿ç»­3æ¬¡é€ç¤¼éƒ½åœ¨é¢„ç®—å†…',
      icon: 'ğŸ’°',
      type: AchievementType.BUDGET_CONTROL,
      conditionType: AchievementType.BUDGET_CONTROL,
      targetValue: 3,
      timeWindow: null,
      specificValue: null
    };
    achievementTemplates.push(budgetMaster);

    const holidayPioneer: AchievementTemplateData = {
      id: 'holiday_pioneer',
      name: 'èŠ‚æ—¥å…ˆé”‹',
      description: 'æå‰ä¸€å‘¨è®¾ç½®å¥½é‡è¦èŠ‚æ—¥æé†’',
      icon: 'ğŸ‰',
      type: AchievementType.PLANNING_AHEAD,
      conditionType: AchievementType.PLANNING_AHEAD,
      targetValue: 1,
      timeWindow: 7,
      specificValue: null
    };
    achievementTemplates.push(holidayPioneer);

    const giftMaster: AchievementTemplateData = {
      id: 'gift_master',
      name: 'é€ç¤¼è¾¾äºº',
      description: 'ç´¯è®¡è®°å½•25æ¬¡é€ç¤¼',
      icon: 'ğŸ†',
      type: AchievementType.GIFT_COUNT,
      conditionType: AchievementType.GIFT_COUNT,
      targetValue: 25,
      timeWindow: null,
      specificValue: null
    };
    achievementTemplates.push(giftMaster);

    const emotionExpert: AchievementTemplateData = {
      id: 'emotion_expert',
      name: 'æƒ…æ„Ÿä¸“å®¶',
      description: 'æ”¶åˆ°10æ¬¡ç§¯æè¯„ä»·',
      icon: 'ğŸ˜Š',
      type: AchievementType.FEEDBACK_QUALITY,
      conditionType: AchievementType.FEEDBACK_QUALITY,
      targetValue: 10,
      timeWindow: null,
      specificValue: 'å¼€å¿ƒ'
    };
    achievementTemplates.push(emotionExpert);

    for (const template of achievementTemplates) {
      await this.rdbStore.executeSql(
        `INSERT INTO achievements (id, name, description, icon, type, condition_type, target_value, time_window, specific_value) 
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [
          template.id,
          template.name,
          template.description,
          template.icon,
          template.type,
          template.conditionType,
          template.targetValue,
          template.timeWindow,
          template.specificValue
        ]
      );
    }
  }

  getRdbStore(): relationalStore.RdbStore | null {
    return this.rdbStore;
  }

  // å…³é—­æ•°æ®åº“
  async closeDatabase(): Promise<void> {
    if (this.rdbStore) {
      await this.rdbStore.close();
      this.rdbStore = null;
    }
  }

  // ç”ŸæˆUUID
  generateId(): string {
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  // è·å–å½“å‰æ—¶é—´æˆ³
  getCurrentTimestamp(): string {
    return new Date().toISOString();
  }

  // æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆç”¨äºé‡ç½®åº”ç”¨ï¼‰
  async clearAllData(): Promise<void> {
    if (!this.rdbStore) {
      throw new Error('æ•°æ®åº“æœªåˆå§‹åŒ–');
    }

    const tables = [
      'contacts', 'important_dates', 'contact_preferences', 'gift_events',
      'inspirations', 'favorite_inspirations', 'gift_card_templates',
      'user_gift_cards', 'holidays', 'reminders', 'app_settings'
    ];
    
    for (const table of tables) {
      await this.rdbStore.executeSql(`DELETE FROM ${table}`);
    }
    
    // é‡æ–°åˆå§‹åŒ–é»˜è®¤æ•°æ®
    await this.initDefaultData();
  }
}